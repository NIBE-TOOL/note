<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Note de dimensionnement</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            margin: 0;
            padding: 0;
            font-size: 16px;
            color: #222;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }
        .header {
            display: flex;
            align-items: center !important;
            margin-bottom: 12px !important;
            gap: 8px;
        }
        .header .logo {
            max-height: 28px !important;
            height: auto !important;
            width: auto !important;
            margin-top: 0 !important;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5em;
            flex: 1;
            text-align: center;
        }
        .step {
            display: none;
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .step.active {
            display: block;
            opacity: 1;
            transform: translateX(0);
        }
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            .header h1 {
                font-size: 1.2em;
            }
            .navigation {
                display: flex;
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            .navigation button {
                margin: 0;
                width: 100%;
            }
            table th, table td {
                font-size: 0.8em;
            }
            .summary-item {
                flex: 1 0 45%;
            }
            .zone-row {
                grid-template-columns: 1fr;
            }
            .zone-row .field,
            .zone-row .loss-display,
            .zone-row .remove-zone-btn {
                margin-bottom: 8px;
            }
            .zone-row input,
            .zone-row select {
                width: 100%;
            }
        }
        h1, h2, h3 {
            margin-top: 0;
        }
        .navigation {
            margin-top: 20px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            text-align: left;
        }
        .navigation button {
            padding: 8px 16px;
            font-size: 15px;
            margin: 0 8px 0 0;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .navigation button[disabled] {
            background-color: #aaa;
            cursor: default;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            table-layout: fixed;
        }
        table th, table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            font-size: 15px;
        }
        table td:first-child, table th:first-child {
            width: 40%;
        }
        table td:last-child, table th:last-child {
            width: 60%;
        }

        /*
         * Override global width rules for the quote/devis table.  Without this, the
         * generic styles that assign 40% width to the first column and 60% to
         * the last column can cause the 4‑column quote table to render with
         * columns overlapped.  The .devis-table class is applied to the quote
         * table generated in generateDevis().
         */
        .devis-table td:first-child, .devis-table th:first-child,
        .devis-table td:last-child, .devis-table th:last-child {
            width: auto;
        }
        .final-step table:first-of-type {
            margin-top: 12px;
        }
        .tech-summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            table-layout: fixed;
        }
        .tech-summary-table th, .tech-summary-table td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center;
            font-size: 14px;
            width: 25%;
        }
        .zone {
            border: 1px solid #d0dfe8;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 6px;
            background-color: #f9fbff;
        }
        .zone h4 {
            margin-top: 0;
        }
        .add-zone {
            margin-top: 10px;
            text-align: left;
        }
        .add-zone button {
            background-color: #007bff !important;
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            font-size: 15px;
            border-radius: 20px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .add-zone button:hover {
            background-color: #0056b3 !important;
        }
        .remove-zone-btn {
            background-color: #d62728;
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            font-size: 15px;
            border-radius: 20px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-width: 90px;
        }
        .pool-remove-btn {
            background-color: #007bff;
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            font-size: 15px;
            border-radius: 20px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-width: 90px;
        }
        .result {
            background-color: #f9f9f9;
            padding: 10px;
            border: 1px solid #ddd;
            margin-top: 20px;
        }
        .hidden {
            display: none;
        }
        #step1 label, #step2 label {
            display: block;
            margin-bottom: 4px !important;
            width: 100%;
        }
        #step1 input, #step1 select,
        #step2 input, #step2 select {
            width: 100%;
        }
        #step1, #step2 {
            max-width: 600px;
            margin: 0 auto;
        }
        input[type="text"], input[type="number"], select, textarea {
            background-color: #f2f7ff;
            border: 1px solid #c2d6ec;
            border-radius: 4px;
            padding: 8px;
            font-size: 15px;
            width: 100%;
            box-sizing: border-box;
        }
        label {
            font-size: 15px;
            color: #333;
        }
        .zone-row {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr 1.2fr 1.2fr 1fr 1.2fr auto;
            gap: 8px;
            align-items: flex-start !important;
        }
        .zone-row .field {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .zone-row .field span {
            font-size: 14px;
            margin-bottom: 2px;
            white-space: nowrap;
        }
        .loss-display {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        .manual-input {
            margin-top: 8px;
        }
        .zone-row input, .zone-row select {
            height: 36px;
        }
        .bordmer-container {
            display: flex;
            align-items: center;
            gap: 4px !important;
            margin-bottom: 6px;
            white-space: nowrap;
        }
        .bordmer-container label {
            margin: 0;
            width: auto !important;
            display: inline;
        }
        .altitude-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px !important;
            margin-bottom: 6px;
        }
        .altitude-field label {
            margin-bottom: 4px;
        }
        .altitude-field select {
            width: auto;
            min-width: 160px;
        }
        #step4 label {
            font-size: 16px;
        }
        #step4 select {
            font-size: 16px;
            padding: 8px;
        }
        .summary-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }
        .summary-item {
            flex: 1 0 22%;
            background-color: #f8fbff;
            border: 1px solid #d0dfe8;
            border-radius: 4px;
            padding: 6px;
            text-align: center;
            font-size: 14px;
        }
        .report-header {
            margin-bottom: 12px;
        }
        .print-spacer {
            display: none;
        }
        .final-step button {
            padding: 8px 16px;
            font-size: 15px;
            margin: 0 8px 0 0;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .final-buttons {
            margin-top: 12px;
        }
        .vmc-guide {
            margin-top: 16px;
            border: 1px solid #d0dfe8;
            border-radius: 8px;
            padding: 12px;
            background-color: #f9fbff;
        }
        .vmc-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }
        .vmc-input-group {
            flex: 1 1 140px;
        }
        .vmc-actions {
            margin-top: 6px;
        }
        .vmc-actions button {
            padding: 6px 14px;
            font-size: 14px;
        }
        .vmc-result {
            margin-top: 8px;
            background: #ffffff;
            border: 1px solid #d0dfe8;
            border-radius: 6px;
            padding: 8px;
            font-size: 14px;
        }
        .vmc-result-line {
            margin-bottom: 4px;
        }
        .vmc-note {
            margin-top: 6px;
            font-size: 12px;
            color: #555;
        }
        @media print {
            body {
                margin: 0;
                font-size: 11px;
            }
            @page {
                size: A4 portrait;
                margin: 0;
            }
            #finalReport {
                margin-left: 12mm;
                margin-right: 12mm;
                margin-top: 10mm;
                margin-bottom: 0;
            }
            #finalReport .report-header {
                margin-bottom: 0;
            }
            .navigation, .step:not(.final-step) {
                display: none !important;
            }
            .final-step {
                display: block !important;
            }
            table th, table td {
                font-size: 10px;
                padding: 3px;
            }
            h2, h3 {
                font-size: 12px;
            }
            .final-step button {
                display: none !important;
            }
            #finalReport table:first-of-type {
                margin-top: 10mm;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with logo and title -->
        <div class="header">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQQRLnUEoNR2GdiXhoMIgRc6NZN_8JHSGA2DQ&s" alt="logo" class="logo" />
            <h1 id="title">NOTE DE DIMENSIONNEMENT</h1>
        </div>

        <!-- Step 1 -->
        <div id="step1" class="step active">
            <label>Nom de l'installateur&nbsp;:<input type="text" id="companyName" placeholder="Nom de l'installateur"></label>
            <label>Adresse de l'installateur&nbsp;:<input type="text" id="companyAddress" placeholder="Adresse"></label>
            <label>Numéro de SIRET&nbsp;:<input type="text" id="companySiret" placeholder="Numéro de SIRET"></label>
        </div>

        <!-- Step 2 -->
        <div id="step2" class="step">
            <label>Prénom du bénéficiaire&nbsp;:<input type="text" id="beneficiaryFirstName" placeholder="Prénom"></label>
            <label>Nom du bénéficiaire&nbsp;:<input type="text" id="beneficiaryLastName" placeholder="Nom"></label>
            <label>Adresse du bénéficiaire&nbsp;:<input type="text" id="beneficiaryAddress" placeholder="Adresse"></label>
            <label>Code postal&nbsp;:<input type="text" id="beneficiaryPostalCode" maxlength="5" placeholder="Code postal"></label>
            <label>Ville&nbsp;:<input type="text" id="beneficiaryCity" placeholder="Ville"></label>
            <label>Année de construction&nbsp;:<input type="number" id="constructionYear" min="1800" max="2030" placeholder="Année"></label>
            <div class="altitude-row">
                <div class="altitude-field">
                    <label>Altitude&nbsp;:</label>
                    <select id="altitudeRange">
                        <option value="0-200">0 à 200 m</option>
                        <option value="201-400">201 à 400 m</option>
                        <option value="401-600">401 à 600 m</option>
                        <option value="601-800">601 à 800 m</option>
                        <option value="801-1000">801 à 1000 m</option>
                        <option value="1001-1200">1001 à 1200 m</option>
                        <option value="1201-1400">1201 à 1400 m</option>
                        <option value="1401-1600">1401 à 1600 m</option>
                        <option value="1601-1800">1601 à 1800 m</option>
                        <option value="1801-2000">1801 à 2000 m</option>
                        <option value="2001-2200">2001 à 2200 m</option>
                    </select>
                </div>
                <div class="bordmer-container">
                    <input type="checkbox" id="bordDeMer">
                    <span>Bord de mer (&lt;25 km)</span>
                </div>
            </div>
            <div id="baseTempResult">Température de base&nbsp;: <span id="baseTempValue">--</span> °C</div>
        </div>

        <!-- Step 3 -->
        <div id="step3" class="step">
            <div id="zonesContainer"></div>
            <div class="add-zone">
                <button type="button" onclick="addZone()">+ Ajouter une zone</button>
                <button type="button" id="addPoolBtn" onclick="addPool()">+ Ajouter une piscine</button>
            </div>
            <div id="poolContainer"></div>
            <div id="projectSummary" class="result hidden">
                <div style="font-weight:bold;">Total des déperditions&nbsp;: <span id="totalLoss"></span> kW</div>
                <div id="surfacesContainer" class="hidden">
                    <ul id="surfacesByTemp"></ul>
                </div>
                <span id="avgHeight" class="hidden"></span>
                <span id="maxAmbient" class="hidden"></span>
                <span id="maxHeating" class="hidden"></span>
            </div>
        </div>

        <!-- Step 4 -->
        <div id="step4" class="step">
            <h2>Sélection PAC</h2>
            <label>Technologie:
                <select id="technologySelect" onchange="onTechnologyChange()">
                    <option value="">-- Choisir --</option>
                    <option value="geothermie">Géothermie / Aquathermie</option>
                    <option value="aireau">Pompe à chaleur Air/eau</option>
                    <option value="airextr">Pompe à chaleur sur Air extrait</option>
                </select>
            </label><br>

            <div id="geoOptions" class="hidden">
                <label>Type:
                    <select id="geoType">
                        <option value="0">Géothermie 0°C</option>
                        <option value="5">Géothermie 5°C</option>
                        <option value="10">Aquathermie 10°C</option>
                    </select>
                </label><br>
                <label>Modèle:
                    <select id="geoModel"></select>
                </label><br>
                <label>Nombre d'unités:<input type="number" id="geoUnits" min="1" max="9" value="1"></label>
            </div>

            <div id="airEauOptions" class="hidden">
                <label>Modèle:
                    <select id="airEauModel"></select>
                </label><br>
                <label>Nombre d'unités:<input type="number" id="airEauUnits" min="1" max="8" value="1"></label>
            </div>

            <div id="airExtrOptions" class="hidden">
                <label>Modèle:
                    <select id="airExtrModel"></select>
                </label><br>
                <label>Débit de ventilation (m³/h):
                    <select id="airExtrFlow"></select>
                </label><br>
            </div>

            <!-- Guide VMC – visible uniquement pour PAC sur air extrait -->
            <div id="vmcGuide" class="vmc-guide hidden">
                <h3>Guide VMC (débit réglementaire indicatif)</h3>
                <div class="vmc-inputs">
                    <div class="vmc-input-group">
                        <label for="vmcBedrooms">Nombre de chambres</label>
                        <input type="number" id="vmcBedrooms" min="1" max="7" value="3">
                    </div>
                    <div class="vmc-input-group">
                        <label for="vmcBathrooms">Salles de bain</label>
                        <input type="number" id="vmcBathrooms" min="0" max="6" value="1">
                    </div>
                    <div class="vmc-input-group">
                        <label for="vmcWc">WC</label>
                        <input type="number" id="vmcWc" min="0" max="4" value="1">
                    </div>
                    <div class="vmc-input-group">
                        <label for="vmcOther">Autres pièces d'eau</label>
                        <input type="number" id="vmcOther" min="0" max="4" value="0">
                    </div>
                </div>
                <div class="vmc-actions">
                    <button type="button" onclick="computeVmcReglementaire()">Calculer le débit réglementaire</button>
                </div>
                <div id="vmcResult" class="vmc-result hidden"></div>
                <p class="vmc-note">
                    Ce guide VMC est fourni à titre purement indicatif et ne remplace pas une étude réglementaire complète ni un dimensionnement détaillé de réseau.
                </p>
            </div>

            <div id="techSummary" class="result hidden">
                <h3>Résultat sélection PAC</h3>
                <div class="summary-grid">
                    <div class="summary-item"><strong>Déperditions totales</strong><br><span id="summaryLoss"></span> kW</div>
                    <div class="summary-item"><strong>Puissance PAC</strong><br><span id="pacPower"></span> kW</div>
                    <div class="summary-item"><strong>Puissance/Déperditions</strong><br><span id="powerRatio"></span> %</div>
                    <div class="summary-item"><strong>Appoint recommandé</strong><br><span id="backupPower"></span> kW</div>
                </div>
                <div id="extraInfo" class="summary-item hidden" style="margin-top:8px;"></div>
                <div id="renewalInfo" class="summary-item hidden" style="margin-top:8px;"></div>
            </div>
        </div>

        <!-- Step 5 (Final) -->
        <div id="step5" class="step final-step">
            <div id="finalReport"></div>
            <!-- Actions spécifiques à la page de note : permettre de revenir à l'étape précédente ou de poursuivre vers le devis -->
            <div id="noteActions" style="margin-top:20px; text-align:center;">
                <div id="preconisationButtons" class="final-buttons" style="margin-bottom:12px;"></div>
                <button type="button" onclick="prevStep()" style="padding:8px 16px; margin-right:10px; background:#6c757d; color:#fff; border:none; border-radius:4px;">Précédent</button>
                <button type="button" onclick="window.print()" style="padding:8px 16px; background:#007bff; color:#fff; border:none; border-radius:4px;">Imprimer</button>
</div>

        </div> <!-- fin de step5 -->


        

        <!-- Navigation buttons -->
        <div class="navigation">
            <button id="prevBtn" onclick="prevStep()">Précédent</button>
            <button id="nextBtn" onclick="nextStep()">Suivant</button>
        </div>
    </div>

    <script>
        // Flags to track whether the user has manually selected model or units
        let geoManuallySelected = false;
        let airEauManuallySelected = false;

        /* =============================
           Données de base
        ============================== */
        const baseTempMapping = {
            '01': -10,'02': -7,'03': -8,'04': -8,'05': -10,'06': -2,'07': -7,'08': -10,'09': -5,'10': -10,
            '11': -5,'12': -8,'13': -5,'14': -7,'15': -8,'16': -5,'17': -5,'18': -7,'19': -8,'21': -10,
            '22': -4,'23': -8,'24': -5,'25': -12,'26': -7,'27': -7,'28': -7,'29': -4,'30': -5,'31': -5,
            '32': -5,'33': -5,'34': -5,'35': -5,'36': -7,'37': -7,'38': -10,'39': -10,'40': -5,'41': -7,
            '42': -10,'43': -8,'44': -5,'45': -7,'46': -7,'47': -5,'48': -8,'49': -7,'50': -4,'51': -10,
            '52': -12,'53': -7,'54': -15,'55': -12,'56': -4,'57': -15,'58': -10,'59': -9,'60': -7,'61': -7,
            '62': -9,'63': -8,'64': -5,'65': -5,'66': -5,'67': -15,'68': -15,'69': -10,'70': -12,'71': -10,
            '72': -7,'73': -10,'74': -10,'75': -7,'76': -7,'77': -7,'78': -7,'79': -7,'80': -9,'81': -5,
            '82': -5,'83': -2,'84': -7,'85': -5,'86': -7,'87': -8,'88': -15,'89': -10,'90': -15,'91': -7,
            '92': -7,'93': -7,'94': -7,'95': -7
        };
        const altitudeMap = {
            '-2': {
                '0-200': -2,'201-400': -4,'401-600': -6,'601-800': -8,'801-1000': -10,
                '1001-1200': -12,'1201-1400': -14,'1401-1600': -16,'1601-1800': -18,'1801-2000': -20,'2001-2200': -20
            },
            '-4': {
                '0-200': -4,'201-400': -5,'401-600': -6,'601-800': -7,'801-1000': -8,
                '1001-1200': -9,'1201-1400': -10,'1401-1600': -10,'1601-1800': -10,'1801-2000': -10,'2001-2200': -10
            },
            '-5': {
                '0-200': -5,'201-400': -6,'401-600': -7,'601-800': -8,'801-1000': -9,
                '1001-1200': -10,'1201-1400': -11,'1401-1600': -12,'1601-1800': -13,'1801-2000': -14,'2001-2200': -15
            },
            '-7': {
                '0-200': -7,'201-400': -8,'401-600': -9,'601-800': -11,'801-1000': -13,
                '1001-1200': -14,'1201-1400': -15,'1401-1600': -15,'1601-1800': -15,'1801-2000': -15,'2001-2200': -15
            },
            '-8': {
                '0-200': -8,'201-400': -9,'401-600': -11,'601-800': -13,'801-1000': -15,
                '1001-1200': -17,'1201-1400': -19,'1401-1600': -21,'1601-1800': -23,'1801-2000': -25,'2001-2200': -27
            },
            '-9': {
                '0-200': -9,'201-400': -10,'401-600': -11,'601-800': -12,'801-1000': -13,
                '1001-1200': -13,'1201-1400': -13,'1401-1600': -13,'1601-1800': -13,'1801-2000': -13,'2001-2200': -13
            },
            '-10': {
                '0-200': -10,'201-400': -11,'401-600': -13,'601-800': -14,'801-1000': -17,
                '1001-1200': -19,'1201-1400': -21,'1401-1600': -23,'1601-1800': -24,'1801-2000': -25,'2001-2200': -29
            },
            '-12': {
                '0-200': -12,'201-400': -13,'401-600': -15,'601-800': -17,'801-1000': -19,
                '1001-1200': -21,'1201-1400': -23,'1401-1600': -24,'1601-1800': -24,'1801-2000': -24,'2001-2200': -24
            },
            '-15': {
                '0-200': -15,'201-400': -15,'401-600': -19,'601-800': -21,'801-1000': -23,
                '1001-1200': -24,'1201-1400': -25,'1401-1600': -25,'1601-1800': -25,'1801-2000': -25,'2001-2200': -25
            }
        };

        const gCoefficients = [
            { label: 'véranda récente', value: 2.00 },
            { label: 'pas isolé, pas d’inertie', value: 1.60 },
            { label: 'pas isolé, ancien, mur 60cm', value: 1.40 },
            { label: 'isolé, bâtiment années 1960', value: 1.30 },
            { label: 'entre 1974-1982', value: 1.20 },
            { label: 'maison années 1980', value: 1.10 },
            { label: 'entre 1990-2000', value: 1.00 },
            { label: 'maison RT2000', value: 0.90 },
            { label: 'entre 2001-2005', value: 0.80 },
            { label: 'isolation norme RT2000', value: 0.80 },
            { label: 'maison RT2005', value: 0.75 },
            { label: 'isolation norme RT2012', value: 0.60 },
            { label: 'isolation norme RT2012 Bbio +', value: 0.50 },
            { label: 'isolation norme RE2020', value: 0.40 },
            { label: 'saisie manuelle', value: null }
        ];

        /* ============================================================
           Section devis – données et fonctions

           Ce bloc ajoute une fonctionnalité d'établissement de devis
           simplifié pour certaines pompes à chaleur air/eau. Il repose
           sur les règles fournies par NIBE et utilise les tarifs
           publics issus du fichier tarif en vigueur (janv‑2026). Les
           prix et éco‑participations sont inclus pour chaque référence.
           La logique suivante est volontairement simplifiée afin de
           fournir un devis estimatif : seules les gammes S2125 (8 à 20)
           et F2050 (6 à 16) sont traitées. Les options ECS
           intégrées/séparées sont proposées et les accessoires
           hydrauliques de base sont ajoutés selon la puissance. Les
           accessoires électriques et règles avancées (multi‑zones,
           dimensionnement radiateurs/plancher, géothermie, etc.) ne
           sont pas pris en compte ici pour des raisons de lisibilité.

           Pour étendre cette logique à d'autres modèles (AMS, S735,
           géothermie, etc.), il convient d'enrichir les objets
           `productData`, `ecsIntegreeOptions` et `ecsSeparableOptions`,
           ainsi que les règles dans generateDevis().
        ============================================================ */

        // Dictionnaire de tarifs par référence (tarif public HT) et éco‑participation
        const tarifRef = {
            // Pompes à chaleur air/eau série S2125 – désignations complètes
            "N064220": { tarif: 10080, eco: 10.02, libelle: "NIBE S2125-8 1X230V", designation: "PAC Air / Eau Monobloc R290 Hautes performances, 8kW, 230V" },
            "N064219": { tarif: 11047, eco: 10.02, libelle: "NIBE S2125-8 3X400V", designation: "PAC Air / Eau Monobloc R290 Hautes performances, 8kW, 400V" },
            "N064218": { tarif: 11204, eco: 10.02, libelle: "NIBE S2125-12 1X230V", designation: "PAC Air / Eau Monobloc R290 Hautes performances, 12kW, 230V" },
            "N064217": { tarif: 12244, eco: 10.02, libelle: "NIBE S2125-12 3X400V", designation: "PAC Air / Eau Monobloc R290 Hautes performances, 12kW, 400V" },
            "N064216": { tarif: 13428, eco: 10.02, libelle: "NIBE S2125-16 1x230V", designation: "PAC Air / Eau Monobloc R290 Hautes performances, 16kW, 230V" },
            "N064215": { tarif: 13428, eco: 10.02, libelle: "NIBE S2125-16 3x400V", designation: "PAC Air / Eau Monobloc R290 Hautes performances, 16kW, 400V" },
            "N064214": { tarif: 15019, eco: 10.02, libelle: "NIBE S2125-20 1X230V", designation: "PAC Air / Eau Monobloc R290 Hautes performances, 20kW, 230V" },
            "N064213": { tarif: 15019, eco: 10.02, libelle: "NIBE S2125-20 3X400V", designation: "PAC Air / Eau Monobloc R290 Hautes performances, 20kW, 400V" },
            // Pompes à chaleur air/eau série F2050 – désignations complètes
            "N064328": { tarif: 5326,  eco: 10.02, libelle: "NIBE F2050-6 1x230V", designation: "PAC Air / Eau Monobloc R32 Inverter Réversible 6kW, 230V" },
            "N064318": { tarif: 6014,  eco: 10.02, libelle: "NIBE F2050-10 1x230V", designation: "PAC Air / Eau Monobloc R32 Inverter Réversible 10kW, 230V" },
            "N064361": { tarif: 6309,  eco: 10.02, libelle: "NIBE F2050-12 1x230V", designation: "PAC Air / Eau Monobloc R32 Inverter Réversible 12kW, 230V" },
            "N064362": { tarif: 7739,  eco: 10.02, libelle: "NIBE F2050-16 1x230V", designation: "PAC Air / Eau Monobloc R32 Inverter Réversible 16kW, 230V" },
            // Unités extérieures AMS (split) – prix et éco-contributions
            "N064235": { tarif: 2714, eco: 10.02, libelle: "NIBE AMS 20-6", designation: "Unité extérieure SPLIT 6 kW R32" },
            "N064319": { tarif: 3552, eco: 10.02, libelle: "NIBE AMS 20-10", designation: "Unité extérieure SPLIT 10 kW R32" },
            // Accessoires de base et ECS – désignations extraites du tarif officiel
            "N067654": { tarif: 1463, eco: 0,    libelle: "NIBE SMO S40", designation: "Système de régulation pour PAC Air‑Eau, Série‑S" },
            "N067321": { tarif: 398,  eco: 0.60, libelle: "NIBE CPD11-25/65", designation: "Circulateur électronique de charge" },
            "N067320": { tarif: 436,  eco: 0.60, libelle: "NIBE CPD11-25/75", designation: "Circulateur électronique de charge" },
            "N069252": { tarif: 725,  eco: 1.75, libelle: "ELK 9, 230/400V", designation: "Appoint électrique en ligne (4,5 à 9 kW)" },
            "N088207": { tarif: 622,  eco: 0,    libelle: "NIBE UKV 100", designation: "Ballon tampon 100 L – 4 piquages, chaud/froid, classe C" },
            "N080012": { tarif: 1098, eco: 0,    libelle: "NIBE UKV 20-220 CHAUD SEUL", designation: "Ballon tampon 200 L – 4 piquages, classe C" },
            "N067761": { tarif: 96,   eco: 0,    libelle: "RACCORDS 22MM-1P X7 ET SONDES", designation: "Kit raccords hydrauliques 22 mm avec sondes" },
            "N069198": { tarif: 5913, eco: 18,    libelle: "NIBE VVM S320 R 1x230V", designation: "Module hydraulique pour PAC Air / Eau Série‑S, 230V" },
            "N069196": { tarif: 6054, eco: 18,    libelle: "NIBE VVM S320 R 400V", designation: "Module hydraulique pour PAC Air / Eau Série‑S, 400V" },
            "N069277": { tarif: 8473, eco: 1.75,  libelle: "NIBE VVM S500 1x230V", designation: "Module hydraulique VVM S500, 230V" },
            "N069276": { tarif: 8473, eco: 1.75,  libelle: "NIBE VVM S500 3x400V", designation: "Module hydraulique VVM S500, 400V" },
            "N069430": { tarif: 7310, eco: 1.75,  libelle: "NIBE VVM 310", designation: "Module hydraulique VVM 310, 230/400V" },
            "N069231": { tarif: 5149, eco: 18,    libelle: "NIBE VVM 225, 1X230V", designation: "Module hydraulique VVM 225, 230V" },
            "N069229": { tarif: 5379, eco: 18,    libelle: "NIBE VVM 225, 400V", designation: "Module hydraulique VVM 225, 400V" },
            "N081141": { tarif: 2328, eco: 18,    libelle: "NIBE VPB S200 R", designation: "Ballon ECS 200 L inox avec échangeur PAC" },
            "N081143": { tarif: 3193, eco: 22,    libelle: "NIBE VPB S300 R", designation: "Ballon ECS 300 L inox avec échangeur PAC" },
            "N082025": { tarif: 3059, eco: 22,    libelle: "NIBE VPA 300/200 E", designation: "Ballon ECS 487 L acier émaillé" },
            "N082032": { tarif: 4648, eco: 22,    libelle: "NIBE VPA 450/300 E", designation: "Ballon ECS 737 L acier émaillé" },
            "N089152": { tarif: 275,  eco: 0,    libelle: "NIBE VST 11", designation: "Vanne 3 voies ECS DN25" }
    ,
    // Kits de zones mélangées
            "N067287": { tarif: 1204, eco: 0,    libelle: "NIBE ECS 40", designation: "Kit zone mélangée ECS40 incluant circulateur, vannes d’isolement, vanne 3 voies motorisée et carte de régulation" },
    "N067288": { tarif: 1204, eco: 0,    libelle: "NIBE ECS 41", designation: "Kit zone mélangée ECS41 incluant circulateur, vannes d’isolement, vanne 3 voies motorisée et carte de régulation" },
    "N067062": { tarif: 0, eco: 0,    libelle: "POOL 40", designation: "Kit piscine POOL 40" },
    "N067247": { tarif: 0, eco: 0,    libelle: "POOL 310", designation: "Kit piscine POOL 310" },
    "N067181": { tarif: 0, eco: 0,    libelle: "POOL 500", designation: "Kit piscine POOL 500" }
            ,
            // Modules hydrauliques BA‑SVM et SHB (pour AMS)
            "N067944": { tarif: 4691, eco: 1.75, libelle: "NIBE SHB 20-6 EM", designation: "Module hydraulique BA‑SVM pour AMS 20‑6 (plancher chauffant)" },
            "N067945": { tarif: 4840, eco: 1.75, libelle: "NIBE SHB 20-12 EM", designation: "Module hydraulique BA‑SVM pour AMS 20‑10 (plancher chauffant)" },
            "N067953": { tarif: 5757, eco: 18,   libelle: "NIBE BA-SVM20-200/6E", designation: "Module hydraulique BA‑SVM 200/6E (intégrée)" },
            "N067954": { tarif: 5907, eco: 18,   libelle: "NIBE BA-SVM20-200/12E", designation: "Module hydraulique BA‑SVM 200/12E (intégrée)" }

            ,
            // Accessoires piscine (échangeur, détecteur, relais) – prix et éco par défaut à 0 car non listés dans le tarif
            "W49NT40": { tarif: 0, eco: 0, libelle: "Échangeur piscine", designation: "Échangeur piscine nu (sans régulation ni circulateur)" },
            // Les références WSK02022 et ESB20-11N ne sont plus utilisées (détecteur de débit et relais inverseur)
        };

        // Définition des modèles pris en charge avec les phases disponibles et accessoires de base
        const productData = {
            "S2125-8": {
                phases: ["Mono","Tri"],
                refs: { "Mono": "N064220", "Tri": "N064219" },
                baseAccessories: {
                    "Chauffage": ["N067654","N067321","N069252","N088207"],
                    "ChauffageECS": ["N067654","N067321","N069252","N088207"]
                }
            },
            "S2125-12": {
                phases: ["Mono","Tri"],
                refs: { "Mono": "N064218", "Tri": "N064217" },
                baseAccessories: {
                    "Chauffage": ["N067654","N067321","N069252","N088207"],
                    "ChauffageECS": ["N067654","N067321","N069252","N088207"]
                }
            },
            "S2125-16": {
                phases: ["Mono","Tri"],
                refs: { "Mono": "N064216", "Tri": "N064215" },
                baseAccessories: {
                    "Chauffage": ["N067654","N067320","N069252","N080012"],
                    "ChauffageECS": ["N067654","N067320","N069252","N080012"]
                }
            },
            "S2125-20": {
                phases: ["Mono","Tri"],
                refs: { "Mono": "N064214", "Tri": "N064213" },
                baseAccessories: {
                    "Chauffage": ["N067654","N067320","N069252","N080012"],
                    "ChauffageECS": ["N067654","N067320","N069252","N080012"]
                }
            },
            "F2050-6": {
                phases: ["Mono"],
                refs: { "Mono": "N064328" },
                baseAccessories: {
                    "Chauffage": ["N067654","N067321","N069252","N088207"],
                    "ChauffageECS": ["N067654","N067321","N069252","N088207"]
                }
            },
            "F2050-10": {
                phases: ["Mono"],
                refs: { "Mono": "N064318" },
                baseAccessories: {
                    "Chauffage": ["N067654","N067321","N069252","N088207"],
                    "ChauffageECS": ["N067654","N067321","N069252","N088207"]
                }
            },
            "F2050-12": {
                phases: ["Mono"],
                refs: { "Mono": "N064361" },
                baseAccessories: {
                    "Chauffage": ["N067654","N067321","N069252","N088207"],
                    "ChauffageECS": ["N067654","N067321","N069252","N088207"]
                }
            },
            "F2050-16": {
                phases: ["Mono"],
                refs: { "Mono": "N064362" },
                baseAccessories: {
                    "Chauffage": ["N067654","N067320","N069252","N080012"],
                    "ChauffageECS": ["N067654","N067320","N069252","N080012"]
                }
            }
            ,
            // Gamme AMS (unité extérieure pour système Split) – les références sont identiques pour mono et tri
            "AMS 20-6": {
                phases: ["Mono","Tri"],
                refs: { "Mono": "N064235", "Tri": "N064235" },
                baseAccessories: {
                    // Pour simplifier, nous reprenons les accessoires de base des modèles F2050 pour AMS
                    "Chauffage": ["N067944","N067761"],
                    "ChauffageECS": ["N067944","N067761"]
                }
            },
            "AMS 20-10": {
                phases: ["Mono","Tri"],
                refs: { "Mono": "N064319", "Tri": "N064319" },
                baseAccessories: {
                    "Chauffage": ["N067945","N067761"],
                    "ChauffageECS": ["N067945","N067761"]
                }
            }
        };

        // ECS intégrée : volumes proposés et références par phase. Lorsque plusieurs références existent,
        // nous choisissons la version connectée (VVM S320) par défaut. D'autres versions (VVM 225)
        // sont ignorées pour simplifier.
        const ecsIntegreeOptions = {
            // 207 L – VVM S320 (série S) : hauteur 1,80 m (module connecté)
            "207s": {
                "Mono": ["N069198","N067761"],
                "Tri":  ["N069196","N067761"]
            },
            // 207 L – VVM 225 (série F) : hauteur 1,50 m (module non connecté)
            "207f": {
                "Mono": ["N069231","N067761"],
                "Tri":  ["N069229","N067761"]
            },
            // 270 L – VVM 310 (même référence pour mono et tri)
            "270": {
                "Mono": ["N069430"],
                "Tri":  ["N069430"]
            },
            // 390 L – VVM S500 (référence différente selon la tension)
            "390": {
                "Mono": ["N069277"],
                "Tri":  ["N069276"]
            }
        };

        // ECS séparée : volumes proposés et références associées. Chaque élément est un tableau
        // de références (ballon et accessoires complémentaires). L'éco‑participation est appliquée
        // à chaque référence.
        const ecsSeparableOptions = {
            "200": ["N081141","N089152","N067761"], // ballon 200 L INOX + accessoires
            "300": ["N081143","N089152","N067761"], // ballon 300 L INOX + accessoires
            "487": ["N082025","N089152"],           // ballon 487 L acier + accessoires
            "737": ["N082032","N089152"]            // ballon 737 L acier + accessoires
        };

        // ECS séparée par produit : référence des ballons et accessoires selon le modèle
        const ecsSeparableByProduct = {
            "S2125-8": {
                "200": ["N081141","N089152","N067761"],
                "300": ["N081143","N089152","N067761"],
                "487": ["N082025","N089152"],
                "737": ["N082032","N089152"]
            },
            "S2125-12": {
                "200": ["N081141","N089152","N067761"],
                "300": ["N081143","N089152","N067761"],
                "487": ["N082025","N089152"],
                "737": ["N082032","N089152"]
            },
            "F2050-6": {
                "200": ["N081141","N089152","N067761"],
                "300": ["N081143","N089152","N067761"],
                "487": ["N082025","N089152"],
                "737": ["N082032","N089152"]
            },
            "F2050-10": {
                "200": ["N081141","N089152","N067761"],
                "300": ["N081143","N089152","N067761"],
                "487": ["N082025","N089152"],
                "737": ["N082032","N089152"]
            },
            "F2050-12": {
                "200": ["N081141","N089152","N067761"],
                "300": ["N081143","N089152","N067761"],
                "487": ["N082025","N089152"],
                "737": ["N082032","N089152"]
            },
            "S2125-16": {
                "200": ["N081141","N089388","N067761"],
                "300": ["N081143","N089388","N067761"],
                "487": ["N082025","N089388"],
                "737": ["N082032","N089388"]
            },
            "F2050-16": {
                "487": ["N082025","N089388"],
                "737": ["N082032","N089388"]
            },
            "S2125-20": {
                "487": ["N082025","N089388"],
                "737": ["N082032","N089388"]
            }
        };

        /**
         * Affiche la section devis et prépare la liste des phases selon le modèle.
         */
        function openDevis() {
            // Stocker les informations finales de la PAC dans le localStorage pour les utiliser sur la page de devis
            if (!finalPac || !finalPac.model) {
                alert("Aucune pompe à chaleur n'a été sélectionnée pour établir un devis.");
                return;
            }
            // Vérifier qu'une seule unité est préconisée (conformément aux règles du devis)
            if (finalPac.units && finalPac.units > 1) {
                alert("Le devis ne peut être généré que pour une installation avec une seule unité.");
                return;
            }
            // Préparer la section devis dans la même page
            // Afficher la section devis sans masquer le rapport final ni les boutons. Le devis s'affiche sous la note.
            const devisSection = document.getElementById('devisSection');
            if (devisSection) devisSection.style.display = 'block';
            // Pré-renseigner le modèle sélectionné et masquer la liste déroulante
            const productSelect = document.getElementById('devisProduct');
            const productRow = document.getElementById('productRow');
            const modelInfo = document.getElementById('selectedModelInfo');
            const modelDisplay = document.getElementById('devisModelDisplay');
            if (productSelect && finalPac.model) {
                // Pré‑sélectionner le modèle trouvé lors du dimensionnement, mais laisser la liste visible pour permettre un changement éventuel.
                productSelect.value = finalPac.model;
                // Ne pas masquer la ligne de sélection du produit
                if (modelInfo) {
                    // Cacher l'affichage du modèle imposé car l'utilisateur peut choisir un autre modèle
                    modelInfo.style.display = 'none';
                }
            }
            // Mettre à jour les options de volumes selon le modèle et initialiser l'ECS
            updateEcsVolumeOptions();
            updateSepVolumeOptions();
            toggleEcsOptions();
            toggleEcsDetail();
            // Générer le devis initial
            generateDevis();
        }

        /**
         * Met à jour la liste des phases en fonction du produit sélectionné. Si le
         * produit n'a qu'une seule phase, la sélection est masquée.
         */
        function updatePhaseOptions() {
            // Cette fonction est conservée pour compatibilité mais n'est plus utilisée.
            // La sélection de phase se fait via le champ installPhaseRow (phase de l'installation).
            const phaseRow = document.getElementById("phaseRow");
            if (phaseRow) phaseRow.style.display = "none";
        }

        /**
         * Met à jour la liste des volumes d'ECS intégrée en fonction du modèle sélectionné.
         * Certains modèles n'acceptent pas tous les volumes de ballon. Cette fonction
         * ajuste les options de volume disponibles dans le sélecteur ecsVolume.
         */
        function updateEcsVolumeOptions() {
            const product = document.getElementById("devisProduct").value;
            const volumeSelect = document.getElementById("ecsVolume");
            if (!volumeSelect) return;
            let options = [];
            if (product === "S2125-8" || product === "S2125-12" || product === "S2125-16") {
                // Ces modèles peuvent utiliser les deux variantes à 207 L (S320 et VVM 225) ainsi que 270 L et 390 L
                options = ["207s","207f","270","390"];
            } else if (product === "S2125-20") {
                // S2125‑20 n'accepte que le volume 390 L
                options = ["390"];
            } else if (product.startsWith("F2050")) {
                if (product === "F2050-16") {
                    // F2050‑16 n'accepte que 270 L ou 390 L en intégré
                    options = ["270","390"];
                } else {
                    // F2050‑6, 10, 12 : volumes intégrés 207 L (S320 ou VVM 225), 270 L et 390 L
                    options = ["207s","207f","270","390"];
                }
            } else if (product.startsWith("AMS")) {
                // AMS : un seul module intégré (BA‑SVM). On utilise par défaut la variante S320 207 L
                options = ["207s"];
            } else {
                // Par défaut, proposer tous les volumes
                options = ["207s","207f","270","390"];
            }
            // Mettre à jour les options du sélecteur
            volumeSelect.innerHTML = "";
            options.forEach(val => {
                const opt = document.createElement("option");
                opt.value = val;
                let text = "";
                if (val === "207s") text = "207 (S320 – 1,80 m)";
                else if (val === "207f") text = "207 (VVM 225 – 1,50 m)";
                else if (val === "270") text = "270 L";
                else if (val === "390") text = "390 L";
                else text = val;
                opt.textContent = text;
                volumeSelect.appendChild(opt);
            });
        }

        /**
         * Met à jour la liste des volumes pour l'ECS séparée en fonction du modèle sélectionné.
         */
        function updateSepVolumeOptions() {
            const product = document.getElementById("devisProduct").value;
            const sepSelect = document.getElementById("ecsSepVolume");
            if (!sepSelect) return;
            let options = [];
            if (product === "S2125-20" || product === "F2050-16") {
                // Ces modèles n'acceptent que les volumes 487 et 737 pour ECS séparée
                options = ["487","737"];
            } else {
                // Tous les autres modèles acceptent les quatre volumes standard
                options = ["200","300","487","737"];
            }
            // Mettre à jour les options du sélecteur
            sepSelect.innerHTML = "";
            options.forEach(val => {
                let text = "";
                if (val === "200") text = "200 L INOX";
                else if (val === "300") text = "300 L INOX";
                else if (val === "487") text = "487 L ACIER";
                else if (val === "737") text = "737 L ACIER";
                const opt = document.createElement("option");
                opt.value = val;
                opt.textContent = text;
                sepSelect.appendChild(opt);
            });
        }

        /**
         * Affiche ou masque les options ECS selon l'usage. Si l'utilisateur
         * choisit chauffage + ECS, on affiche les choix intégrée/séparée.
         */
        function toggleEcsOptions() {
            const usage = document.querySelector("input[name='devisUsage']:checked").value;
            const ecsOptionsDiv = document.getElementById("ecsOptions");
            ecsOptionsDiv.style.display = usage === "ChauffageECS" ? "block" : "none";
        }

        /**
         * Affiche les détails de l'ECS intégrée ou séparée selon le choix.
         */
        function toggleEcsDetail() {
            const ecsType = document.querySelector("input[name='ecsType']:checked").value;
            const integreeDiv = document.getElementById("ecsIntegreeDetails");
            const separableDiv = document.getElementById("ecsSeparableDetails");
            if (ecsType === "integree") {
                integreeDiv.style.display = "block";
                separableDiv.style.display = "none";
                // afficher le choix de la phase pour module ECS intégrée
                const phaseRow = document.getElementById("ecsPhaseRow");
                if (phaseRow) phaseRow.style.display = "block";
            } else {
                integreeDiv.style.display = "none";
                separableDiv.style.display = "block";
                // masquer le choix de la phase pour module ECS séparée
                const phaseRow = document.getElementById("ecsPhaseRow");
                if (phaseRow) phaseRow.style.display = "none";
            }
        }

        /**
         * Affiche ou masque les options de piscine en fonction de la case à cocher.
         */
        function togglePoolOptions() {
            const poolCheckbox = document.getElementById('hasPool');
            const poolDetails = document.getElementById('poolDetails');
            if (poolDetails) {
                poolDetails.style.display = (poolCheckbox && poolCheckbox.checked) ? 'block' : 'none';
            }
        }

        /**
         * Ajoute une nouvelle zone mélangée dans l'interface devis. L'utilisateur peut
         * saisir au maximum 7 zones. Chaque zone est représentée par une ligne
         * contenant un sélecteur de surface. Une surface de 0‑80 m² génère un kit
         * ECS 40 (référence N067287) et une surface de 80‑240 m² génère un kit
         * ECS 41 (référence N067288). Si la limite de 7 zones est atteinte, le
         * bouton d'ajout est désactivé et un avertissement apparaît.
         */
        function addMixedZone() {
            const container = document.getElementById('mixedZonesContainer');
            const warning = document.getElementById('mixedZoneLimitWarning');
            if (!container) return;
            // Vérifier la limite à 7 zones
            if (container.children.length >= 7) {
                // Afficher un message d'avertissement et ne pas ajouter de nouvelle zone
                if (warning) warning.style.display = 'block';
                return;
            }
            // Cacher l'avertissement si une zone est ajoutée
            if (warning) warning.style.display = 'none';
            // Créer la ligne de zone
            const row = document.createElement('div');
            row.className = 'mixed-zone-row';
            row.style.display = 'flex';
            row.style.alignItems = 'center';
            row.style.gap = '8px';
            // Libellé pour la zone (sera mis à jour par updateMixedZonesLabels)
            const label = document.createElement('span');
            label.className = 'mixed-zone-label';
            label.textContent = 'Zone';
            row.appendChild(label);
            // Sélecteur de surface pour déterminer le kit
            const select = document.createElement('select');
            select.onchange = generateDevis;
            const optSmall = document.createElement('option');
            optSmall.value = 'small';
            optSmall.textContent = '0 – 80 m²';
            const optLarge = document.createElement('option');
            optLarge.value = 'large';
            optLarge.textContent = '80 – 240 m²';
            select.appendChild(optSmall);
            select.appendChild(optLarge);
            row.appendChild(select);
            // Bouton de suppression de la zone
            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.textContent = '×';
            delBtn.style.background = '#dc3545';
            delBtn.style.color = '#fff';
            delBtn.style.border = 'none';
            delBtn.style.borderRadius = '50%';
            delBtn.style.width = '24px';
            delBtn.style.height = '24px';
            delBtn.style.lineHeight = '20px';
            delBtn.style.textAlign = 'center';
            delBtn.style.cursor = 'pointer';
            delBtn.onclick = function() {
                container.removeChild(row);
                updateMixedZonesLabels();
                // Masquer l'avertissement et réactiver le bouton d'ajout le cas échéant
                if (warning) warning.style.display = 'none';
                const addBtn = document.getElementById('addMixedZoneBtn');
                if (addBtn) addBtn.disabled = false;
                generateDevis();
            };
            row.appendChild(delBtn);
            container.appendChild(row);
            // Mettre à jour les labels des zones
            updateMixedZonesLabels();
            // Générer un devis mis à jour
            generateDevis();
            // Désactiver le bouton d'ajout si on atteint 7 zones
            const addBtn = document.getElementById('addMixedZoneBtn');
            if (container.children.length >= 7 && addBtn) addBtn.disabled = true;
        }

        /**
         * Met à jour les libellés des zones mélangées (Zone 1, Zone 2, …) à
         * chaque ajout ou suppression pour conserver un ordonnancement clair.
         */
        function updateMixedZonesLabels() {
            const container = document.getElementById('mixedZonesContainer');
            if (!container) return;
            Array.from(container.children).forEach((row, index) => {
                const label = row.querySelector('.mixed-zone-label');
                if (label) label.textContent = `Zone ${index + 1}`;
            });
        }

        /**
         * Génère le devis en fonction des choix effectués par l'utilisateur. La
         * fonction assemble une liste d'articles (références) avec leur tarif
         * public et éco‑participation, puis calcule le total. Une fois le devis
         * généré, il est affiché dans la div #devisResult sous forme de table.
         */
        function generateDevis() {
            const product = document.getElementById("devisProduct").value;
            if (!product || !productData[product]) {
                alert("Veuillez sélectionner un modèle de pompe à chaleur.");
                return;
            }
            const usage = document.querySelector("input[name='devisUsage']:checked").value;
            // Mettre à jour le résumé de la configuration choisie (affichage en haut du devis)
            const summaryEl = document.getElementById('devisInfoSummary');
            if (summaryEl) {
                const installPhaseVal = document.getElementById('installPhase') ? document.getElementById('installPhase').value : 'Mono';
                let summaryLines = [];
                // Modèle
                const modelLabel = document.getElementById('devisProduct').value;
                if (modelLabel) summaryLines.push(`Modèle : ${modelLabel}`);
                summaryLines.push(`Tension de l'installation : ${installPhaseVal}`);
                if (usage === 'Chauffage') {
                    summaryLines.push('Usage : Chauffage seul');
                } else {
                    const ecsType = document.querySelector("input[name='ecsType']:checked").value;
                    if (ecsType === 'integree') {
                        const volSelect = document.getElementById('ecsVolume');
                        const volText = volSelect.options[volSelect.selectedIndex].text;
                        summaryLines.push('Usage : Chauffage + ECS intégrée');
                        summaryLines.push(`ECS intégrée : ${volText}`);
                    } else {
                        const sepVolSelect = document.getElementById('ecsSepVolume');
                        const sepVolText = sepVolSelect.options[sepVolSelect.selectedIndex].text;
                        summaryLines.push('Usage : Chauffage + ECS séparée');
                        summaryLines.push(`Volume du ballon séparé : ${sepVolText}`);
                    }
                }
                // Compter les zones mélangées ajoutées (0 à 7)
                let nbZones = 0;
                const mzContainer = document.getElementById('mixedZonesContainer');
                if (mzContainer) nbZones = mzContainer.children.length;
                summaryLines.push(`Zones mélangées : ${nbZones}`);
                const hasPool = document.getElementById('hasPool').checked;
                if (hasPool) {
                    summaryLines.push('Piscine : oui');
                }
                // Joindre les lignes avec des sauts de ligne pour une meilleure lisibilité
                summaryEl.innerHTML = summaryLines.map(l => `<div>${l}</div>`).join('');
            }
            // Lecture de la phase de l'installation (mono ou tri)
            let installPhase = "Mono";
            const installPhaseSelect = document.getElementById("installPhase");
            if (installPhaseSelect) {
                installPhase = installPhaseSelect.value;
            }
            // Déterminer la phase de la pompe : si le produit propose plusieurs phases, utiliser celle de l'installation si elle est disponible ; sinon prendre la première phase proposée
            let phase = "Mono";
            if (productData[product].phases && productData[product].phases.length > 1) {
                if (productData[product].phases.includes(installPhase)) {
                    phase = installPhase;
                } else {
                    phase = productData[product].phases[0];
                }
            } else {
                phase = productData[product].phases[0];
            }
            // Préparation de la liste des articles (références)
            let articleRefs = [];
            // Référence de la pompe
            const pumpRef = productData[product].refs[phase];
            articleRefs.push(pumpRef);
            // Déterminer les accessoires de base selon l'usage et l'intégration ECS.  
            let baseAcc = [];
            if (usage === "Chauffage") {
                // chauffage seul : on prend toujours les accessoires de base
                baseAcc = productData[product].baseAccessories["Chauffage"] || [];
            } else if (usage === "ChauffageECS") {
                const ecsType = document.querySelector("input[name='ecsType']:checked").value;
                if (ecsType === "integree") {
                    // ECS intégrée : pas d'accessoires de base (ils sont inclus dans le module)
                    baseAcc = [];
                } else {
                    // ECS séparée : reprendre les accessoires de base pour le chauffage
                    baseAcc = productData[product].baseAccessories["Chauffage"] || [];
                }
            }
            articleRefs = articleRefs.concat(baseAcc);
            // Si l'usage inclut ECS, ajouter les références intégrées ou séparées
            let addedEcsRefs = [];
            if (usage === "ChauffageECS") {
                const ecsType = document.querySelector("input[name='ecsType']:checked").value;
                if (ecsType === "integree") {
                    // Volume intégré (207s, 207f, 270 ou 390)
                    const volumeKey = document.getElementById("ecsVolume").value;
                    // Le module ECS utilise la même tension que l'installation
                    let modulePhase = installPhase;
                    let ecsRefs = [];
                    // Vérifier la disponibilité du volume pour le modèle et la phase
                    if (ecsIntegreeOptions[volumeKey] && ecsIntegreeOptions[volumeKey][modulePhase]) {
                        ecsRefs = ecsIntegreeOptions[volumeKey][modulePhase].slice();
                    } else {
                        alert("Volume intégré non disponible pour ce modèle");
                        return;
                    }
                    // Ajout de références supplémentaires selon le modèle et le volume
                    // VVM 225 (207f) : ajouter systématiquement le circulateur N088207
                    if (volumeKey === "207f") {
                        ecsRefs.push("N088207");
                    } else if (volumeKey === "207s") {
                        // VVM S320 (207s) : ajouter N088207 uniquement pour S2125‑8, S2125‑12 et F2050‑12
                        if (product === "S2125-8" || product === "S2125-12" || product === "F2050-12") {
                            ecsRefs.push("N088207");
                        }
                    }
                    // S2125‑16 : ajouter N080012 pour toute ECS intégrée (207s ou 207f)
                    if (product === "S2125-16" && (volumeKey === "207s" || volumeKey === "207f")) {
                        ecsRefs.push("N080012");
                    }
                    // Restrictions sur volumes : S2125‑20 n'accepte que 390 L ; F2050‑16 n'accepte pas 207 L
                    if (product === "S2125-20" && volumeKey !== "390") {
                        alert("Volume intégré non disponible pour S2125‑20");
                        return;
                    }
                    if (product === "F2050-16" && (volumeKey === "207s" || volumeKey === "207f")) {
                        alert("Volume intégré non disponible pour F2050‑16");
                        return;
                    }
                    articleRefs = articleRefs.concat(ecsRefs);
                    addedEcsRefs = ecsRefs.slice();
                } else {
                    // ECS séparée : utiliser le volume sélectionné et les références par produit
                    const sepVolume = document.getElementById("ecsSepVolume").value;
                    let sepRefs = [];
                    if (ecsSeparableByProduct[product] && ecsSeparableByProduct[product][sepVolume]) {
                        sepRefs = ecsSeparableByProduct[product][sepVolume];
                    } else {
                        // fallback to default separate references
                        sepRefs = ecsSeparableOptions[sepVolume] || [];
                    }
                    articleRefs = articleRefs.concat(sepRefs);
                    addedEcsRefs = sepRefs.slice();
                }
            }
            // Ajout de la ligne Pot à boue magnétique (sans tarif) dans tous les cas
            const nonPricedLines = ["Pot à boue magnétique"];
            // Indicateur d'accessoires piscine (échangeur, détecteur, relais) à ajouter dans les sections non chiffrées et protections
            let addPoolAccessories = false;
            // Ajout des kits de zones mélangées : chaque zone ajoutée via l'interface correspond
            // à un kit ECS40 ou ECS41 selon sa surface (0‑80 m² → ECS40, 80‑240 m² → ECS41).
            try {
                const mixedContainer = document.getElementById('mixedZonesContainer');
                if (mixedContainer && mixedContainer.children.length > 0) {
                    Array.from(mixedContainer.children).forEach(row => {
                        const sel = row.querySelector('select');
                        if (sel) {
                            const val = sel.value;
                            // valeur 'small' pour 0‑80 m² → kit ECS40, sinon ECS41
                            articleRefs.push(val === 'small' ? 'N067287' : 'N067288');
                        }
                    });
                }
            } catch (e) {
                // ignore en cas d'erreur
            }

            // Ajout du kit piscine selon le module hydraulique et le produit sélectionné. Lorsqu'une piscine est sélectionnée,
            // on détermine automatiquement le kit à utiliser :
            // – POOL 310 (N067247) pour les modules intégrés VVM 310, VVM S320 ou VVM 225 (volumes 207s, 207f ou 270).
            // – POOL 500 (N067181) pour VVM S500 (volume 390).
            // – POOL 40 (N067062) pour les autres configurations, sauf pour les modèles F1345‑40, F1355‑43 et F1345‑60 où aucun kit n'est ajouté.
            const poolCheckbox = document.getElementById('hasPool');
            if (poolCheckbox && poolCheckbox.checked) {
                let poolRef = null;
                // Vérifier les exclusions (modèles de forte puissance géothermie)
                if (product === 'F1345-40' || product === 'F1355-43' || product === 'F1345-60') {
                    poolRef = null;
                } else if (usage === 'ChauffageECS' && document.querySelector("input[name='ecsType']:checked").value === 'integree') {
                    const volumeKey = document.getElementById('ecsVolume').value;
                    if (volumeKey === '390') {
                        poolRef = 'N067181'; // POOL 500
                    } else {
                        // 207s, 207f ou 270 → POOL 310
                        poolRef = 'N067247';
                    }
                } else {
                    // Chauffage seul ou ECS séparée
                    poolRef = 'N067062'; // POOL 40
                }
                if (poolRef) {
                    articleRefs.push(poolRef);
                    // Marque que les accessoires piscine (échangeur, détecteur, relais) doivent être ajoutés
                    addPoolAccessories = true;
                }
            }
            // Établissement de la date du devis et de la validité (2 mois)
            const today = new Date();
            const validity = new Date(today);
            validity.setMonth(validity.getMonth() + 2);
            const formatDate = (dateObj) => {
                return dateObj.toLocaleDateString('fr-FR');
            };
            // Calcul des totaux et préparation des articles avec catégories et désignations
            let totalTarif = 0;
            let totalEco = 0;
            const ligneArticles = [];
            articleRefs.forEach(ref => {
                const info = tarifRef[ref];
                if (!info) return;
                // Toutes les références tarifées font partie de la fourniture NIB (PAC et accessoires). Une seule catégorie est utilisée.
                const category = 'Fourniture NIB';
                const designation = info.designation || ref;
                // Utiliser l'éco‑participation du tarif si elle est définie ; sinon 0
                const ecoPart = (info.eco !== undefined && info.eco !== null) ? info.eco : 0;
                ligneArticles.push({ ref, designation, prix: info.tarif, eco: ecoPart, category });
                totalTarif += info.tarif;
                totalEco += ecoPart;
            });
            // Construction du HTML du devis
            let html = '';
            html += `<h3>Devis – établi le ${formatDate(today)} (valable jusqu'au ${formatDate(validity)})</h3>`;
            // Construire la table en 5 colonnes : référence, libellé court, description longue, tarif HT et éco‑part.
            // Les largeurs allouées assurent une bonne lisibilité même si des styles globaux imposent des tailles de colonnes.
            html += '<table class="devis-table" style="width:100%; border-collapse:collapse; margin-bottom:12px;">';
            html += '<colgroup><col style="width:20%;"><col style="width:25%;"><col style="width:35%;"><col style="width:10%;"><col style="width:10%;"></colgroup>';
            html += '<thead><tr><th style="border:1px solid #ccc; padding:6px;">Référence</th><th style="border:1px solid #ccc; padding:6px;">Libellé</th><th style="border:1px solid #ccc; padding:6px;">Description</th><th style="border:1px solid #ccc; padding:6px; text-align:right;">Tarif&nbsp;HT&nbsp;(€)</th><th style="border:1px solid #ccc; padding:6px; text-align:right;">Éco‑part&nbsp;(€)</th></tr></thead>';
            html += '<tbody>';
            // Trier les articles par catégorie. Tous les articles tarifés appartiennent à la fourniture NIB.
            const categoriesOrder = ['Fourniture NIB'];
            categoriesOrder.forEach(cat => {
                const itemsCat = ligneArticles.filter(item => item.category === cat);
                if (itemsCat.length > 0) {
                    html += `<tr><td style="border:1px solid #ccc; padding:4px; background:#f5f5f5;" colspan="5"><strong>${cat}</strong></td></tr>`;
                    itemsCat.forEach(item => {
                        const infoRow = tarifRef[item.ref] || {};
                        const libelle = infoRow.libelle || '';
                        html += `<tr><td style="border:1px solid #ccc; padding:4px;">${item.ref}</td><td style="border:1px solid #ccc; padding:4px;">${libelle}</td><td style="border:1px solid #ccc; padding:4px;">${item.designation}</td><td style="border:1px solid #ccc; padding:4px; text-align:right;">${item.prix.toFixed(2)}</td><td style="border:1px solid #ccc; padding:4px; text-align:right;">${item.eco.toFixed(2)}</td></tr>`;
                    });
                }
            });
            // Clôture du tableau principal
            html += '</tbody>';
            html += '<tfoot>';
            html += `<tr>
                <td style="border:1px solid #ccc; padding:4px;" colspan="3"><strong>Total hors taxes</strong></td>
                <td style="border:1px solid #ccc; padding:4px; text-align:right;"><strong>${totalTarif.toFixed(2)}</strong></td>
                <td style="border:1px solid #ccc; padding:4px; text-align:right;"><strong>${totalEco.toFixed(2)}</strong></td>
            </tr>`;
            html += '</tfoot>';
            html += '</table>';
            // Encarts non chiffrés : accessoires hydrauliques et protections électriques
            if (nonPricedLines.length > 0) {
                html += '<h4>Accessoires hydrauliques (non chiffrés)</h4><ul style="margin-top:4px; margin-bottom:12px;">';
                nonPricedLines.forEach(txt => {
                    html += `<li>${txt}</li>`;
                });
                html += '</ul>';
            }
            // Détermination des protections électriques à ajouter
            const protectionLines = [];
            protectionLines.push('Protection différentielle de tête (à prévoir)');
            const circRefs = ['N088470','N088207','N085002','N080013','N080014','N080012'];
            const hasCirc = articleRefs.some(r => circRefs.includes(r));
            if (hasCirc) {
                protectionLines.push('Disjoncteur C10 (monophasé) + câble 3G1,5 mm² pour alimentation du circulateur secondaire');
            }
            const regKeywords = ['Kit zone mélangée','ECS40','ECS41','AXC40','AXC50','POOL 40','POOL 310','POOL 500'];
            const needReg = nonPricedLines.some(txt => regKeywords.some(k => txt.includes(k)));
            if (needReg) {
                protectionLines.push('Disjoncteur C10 (monophasé) + câble 3G1,5 mm² pour alimentation de la carte de régulation');
            }
            // Ajouter les accessoires piscine lorsque l'option piscine est sélectionnée
            if (addPoolAccessories) {
                // Seul l'échangeur piscine est ajouté comme accessoire hydraulique non chiffré.
                // Le détecteur de débit et le relais inverseur ne sont pas affichés en références tarifées.
                nonPricedLines.push('Échangeur piscine (réf W49NT40)');
            }
            if (protectionLines.length > 0) {
                html += '<h4>Protections électriques (non chiffrées)</h4><ul style="margin-top:4px; margin-bottom:12px;">';
                protectionLines.forEach(txt => {
                    html += `<li>${txt}</li>`;
                });
                html += '</ul>';
            }
            html += '<p style="font-size:12px;">Ce devis est fourni à titre indicatif. Les prix publics HT et éco‑participations sont susceptibles d\'évoluer. Validité deux mois à compter de la date d\'édition.</p>';
            html += '<p style="font-size:12px;">Les normes en vigueur (électriques et hydrauliques) doivent être respectées par l’installateur. La responsabilité de la conformité de l’installation lui incombe.</p>';
            // Affichage
            const devisDiv = document.getElementById("devisResult");
            devisDiv.innerHTML = html;
        }

        // Geothermal/Aquathermal capacities (kW)
        const geoData = {
            'F1253-4': {
                '0': { '35': 4.5, '45': 4.5, '55': 4.1 },
                '5': { '35': 4.8, '45': 4.8, '55': 4.4 }
            },
            'F1153-4': {
                '0': { '35': 4.5, '45': 4.5, '55': 4.1 },
                '5': { '35': 4.8, '45': 4.8, '55': 4.4 }
            },
            'F1253-6': {
                '0': { '35': 7.6, '45': 7.7, '55': 7.0 },
                '5': { '35': 8.0, '45': 8.0, '55': 7.3 }
            },
            'F1153-6': {
                '0': { '35': 7.6, '45': 7.7, '55': 7.0 },
                '5': { '35': 8.0, '45': 8.0, '55': 7.3 }
            },
            'S1156-8': {
                '0': { '35': 8.5, '45': 8.5, '55': 7.8 },
                '5': { '35': 9.8, '45': 9.8, '55': 9.1 }
            },
            'S1256-8': {
                '0': { '35': 8.5, '45': 8.5, '55': 7.8 },
                '5': { '35': 9.8, '45': 9.8, '55': 9.1 }
            },
            'S1156-13': {
                '0': { '35': 13.5, '45': 13.5, '55': 12.5 },
                '5': { '35': 15.5, '45': 15.5, '55': 14.2 }
            },
            'S1256-13': {
                '0': { '35': 13.5, '45': 13.5, '55': 12.5 },
                '5': { '35': 15.5, '45': 15.5, '55': 14.2 }
            },
            'S1156-18': {
                '0': { '35': 18.9, '45': 18.9, '55': 17.8 },
                '5': { '35': 22.0, '45': 22.0, '55': 20.2 }
            },
            'S1256-18': {
                '0': { '35': 18.9, '45': 18.9, '55': 17.8 },
                '5': { '35': 22.0, '45': 22.0, '55': 20.2 }
            },
            'S1155-25': {
                '0': { '35': 25, '45': 25, '55': 24 },
                '5': { '35': 29, '45': 29, '55': 27 }
            },
            'F1345-24': {
                '0': { '35': 23, '45': 23, '55': 22 }
            },
            'F1345-30': {
                '0': { '35': 31, '45': 31, '55': 29 }
            },
            'F1345-40': {
                '0': { '35': 40, '45': 40, '55': 38 }
            },
            'F1345-60': {
                '0': { '35': 59, '45': 59, '55': 54 }
            },
            'F1355-28': {
                '0': { '35': 28, '45': 28, '55': 27 }
            },
            'F1355-43': {
                '0': { '35': 45, '45': 45, '55': 38 }
            },
            // Aquathermie (10°C)
            'F1253-4-10': { '10': { '35': 5.0, '45': 5.0, '55': 4.6 } },
            'F1153-4-10': { '10': { '35': 5.0, '45': 5.0, '55': 4.6 } },
            'F1253-6-10': { '10': { '35': 8.2, '45': 8.2, '55': 7.5 } },
            'F1153-6-10': { '10': { '35': 8.2, '45': 8.2, '55': 7.5 } },
            'S1156-8-10': { '10': { '35': 11.0, '45': 11.0, '55': 10.5 } },
            'S1256-8-10': { '10': { '35': 11.0, '45': 11.0, '55': 10.5 } },
            'S1156-13-10': { '10': { '35': 17.5, '45': 17.5, '55': 16.0 } },
            'S1256-13-10': { '10': { '35': 17.5, '45': 17.5, '55': 16.0 } },
            'S1156-18-10': { '10': { '35': 24.8, '45': 24.8, '55': 22.8 } },
            'S1256-18-10': { '10': { '35': 24.8, '45': 24.8, '55': 22.8 } },
            'S1155-25-10': { '10': { '35': 34, '45': 34, '55': 31 } },
            'F1345-24-10': { '10': { '35': 30, '45': 30, '55': 28 } },
            'F1345-30-10': { '10': { '35': 40, '45': 40, '55': 39 } },
            'F1345-40-10': { '10': { '35': 52, '45': 52, '55': 49 } },
            'F1345-60-10': { '10': { '35': 78, '45': 78, '55': 69 } },
            'F1355-28-10': { '10': { '35': 35, '45': 35, '55': 33 } },
            'F1355-43-10': { '10': { '35': 58, '45': 58, '55': 52 } }
        };

        /* Air/Eau capacities (kW) */
        const airEauData = {
            'S2125-8': [
                { ext: 7, '35': 6.4, '45': 6.2, '55': 6.0 },
                { ext: 2, '35': 6.4, '45': 6.2, '55': 6.0 },
                { ext: 1, '35': 6.4, '45': 6.1, '55': 5.9 },
                { ext: 0, '35': 6.3, '45': 6.0, '55': 5.9 },
                { ext: -1, '35': 6.2, '45': 5.9, '55': 5.8 },
                { ext: -2, '35': 6.1, '45': 5.7, '55': 5.7 },
                { ext: -3, '35': 5.9, '45': 5.6, '55': 5.6 },
                { ext: -4, '35': 5.8, '45': 5.5, '55': 5.5 },
                { ext: -5, '35': 5.7, '45': 5.4, '55': 5.4 },
                { ext: -6, '35': 5.6, '45': 5.3, '55': 5.3 },
                { ext: -7, '35': 5.5, '45': 5.1, '55': 5.2 },
                { ext: -8, '35': 5.3, '45': 5.0, '55': 5.0 },
                { ext: -9, '35': 5.1, '45': 4.9, '55': 4.9 },
                { ext: -10,'35': 5.0,'45': 4.7,'55': 4.8 },
                { ext: -11,'35': 4.8,'45': 4.6,'55': 4.6 },
                { ext: -12,'35': 4.7,'45': 4.4,'55': 4.5 },
                { ext: -13,'35': 4.5,'45': 4.3,'55': 4.3 },
                { ext: -14,'35': 4.4,'45': 4.1,'55': 4.2 },
                { ext: -15,'35': 4.2,'45': 4.0,'55': 4.0 },
                { ext: -16,'35': 4.1,'45': 4.0,'55': 3.9 },
                { ext: -17,'35': 4.0,'45': 3.9,'55': 3.8 },
                { ext: -18,'35': 3.8,'45': 3.7,'55': 3.6 },
                { ext: -19,'35': 3.7,'45': 3.6,'55': 3.5 },
                { ext: -20,'35': 3.6,'45': 3.5,'55': 3.4 },
                { ext: -21,'35': 3.5,'45': 3.4,'55': 3.3 },
                { ext: -22,'35': 3.4,'45': 3.3,'55': 3.2 },
                { ext: -23,'35': 3.3,'45': 3.2,'55': 3.0 },
                { ext: -24,'35': 3.2,'45': 3.1,'55': 2.9 },
                { ext: -25,'35': 3.2,'45': 3.1,'55': 2.8 }
            ],
            'S2125-12': [
                { ext: 20,'35': 8.43,'45': 10.50,'55': 7.65 },
                { ext: 12,'35': 9.41,'45': 10.50,'55': 9.95 },
                { ext: 10,'35': 9.53,'45': 10.50,'55': 9.98 },
                { ext: 7, '35': 9.71,'45': 9.89,'55': 10.03 },
                { ext: 2, '35': 9.50,'45': 9.50,'55': 9.50 },
                { ext: 1, '35': 9.40,'45': 9.40,'55': 9.40 },
                { ext: 0, '35': 9.30,'45': 9.40,'55': 9.40 },
                { ext: -1,'35': 9.10,'45': 9.20,'55': 9.30 },
                { ext: -2,'35': 9.00,'45': 9.00,'55': 9.10 },
                { ext: -3,'35': 8.90,'45': 8.80,'55': 9.00 },
                { ext: -4,'35': 8.80,'45': 8.70,'55': 8.90 },
                { ext: -5,'35': 8.70,'45': 8.60,'55': 8.80 },
                { ext: -6,'35': 8.50,'45': 8.30,'55': 8.50 },
                { ext: -7,'35': 8.30,'45': 8.40,'55': 8.40 },
                { ext: -8,'35': 8.00,'45': 7.90,'55': 8.10 },
                { ext: -9,'35': 7.80,'45': 7.70,'55': 7.90 },
                { ext: -10,'35': 7.60,'45': 7.50,'55': 7.70 },
                { ext: -11,'35': 7.40,'45': 7.30,'55': 7.50 },
                { ext: -12,'35': 7.20,'45': 7.10,'55': 7.30 },
                { ext: -13,'35': 6.90,'45': 6.90,'55': 7.00 },
                { ext: -14,'35': 6.70,'45': 6.70,'55': 6.80 },
                { ext: -15,'35': 6.50,'45': 6.60,'55': 6.60 },
                { ext: -16,'35': 6.30,'45': 6.30,'55': 6.40 },
                { ext: -17,'35': 6.10,'45': 6.10,'55': 6.20 },
                { ext: -18,'35': 5.90,'45': 5.90,'55': 6.10 },
                { ext: -19,'35': 5.70,'45': 5.70,'55': 5.90 },
                { ext: -20,'35': 5.50,'45': 5.50,'55': 5.70 },
                { ext: -21,'35': 5.30,'45': 5.30,'55': 5.50 },
                { ext: -22,'35': 5.20,'45': 5.20,'55': 5.30 },
                { ext: -23,'35': 5.00,'45': 5.00,'55': 5.20 },
                { ext: -24,'35': 4.90,'45': 4.90,'55': 5.00 },
                { ext: -25,'35': 4.70,'45': 4.70,'55': 4.80 }
            ],
            'S2125-16': [
                { ext: 20,'35': 20.90,'45': 19.10,'55': 18.01 },
                { ext: 12,'35': 19.20,'45': 18.20,'55': 17.10 },
                { ext: 10,'35': 17.70,'45': 16.70,'55': 15.70 },
                { ext: 7, '35': 16.50,'45': 15.60,'55': 15.60 },
                { ext: 2, '35': 14.90,'45': 14.90,'55': 14.90 },
                { ext: 1, '35': 14.70,'45': 14.70,'55': 14.70 },
                { ext: 0, '35': 14.10,'45': 14.10,'55': 14.10 },
                { ext: -1,'35': 13.90,'45': 13.90,'55': 13.90 },
                { ext: -2,'35': 13.80,'45': 13.80,'55': 13.80 },
                { ext: -3,'35': 13.70,'45': 13.70,'55': 13.70 },
                { ext: -4,'35': 13.60,'45': 13.60,'55': 13.60 },
                { ext: -5,'35': 13.40,'45': 13.40,'55': 13.40 },
                { ext: -6,'35': 13.10,'45': 13.10,'55': 13.10 },
                { ext: -7,'35': 12.70,'45': 12.70,'55': 12.70 },
                { ext: -8,'35': 12.30,'45': 12.30,'55': 12.30 },
                { ext: -9,'35': 11.90,'45': 11.90,'55': 11.90 },
                { ext: -10,'35': 11.38,'45': 11.38,'55': 11.38 },
                { ext: -11,'35': 11.21,'45': 11.21,'55': 11.21 },
                { ext: -12,'35': 10.31,'45': 10.31,'55': 10.31 },
                { ext: -13,'35': 9.98,'45': 9.98,'55': 9.98 },
                { ext: -14,'35': 9.67,'45': 9.67,'55': 9.67 },
                { ext: -15,'35': 9.01,'45': 9.01,'55': 9.01 },
                { ext: -16,'35': 8.90,'45': 8.90,'55': 8.90 },
                { ext: -17,'35': 8.80,'45': 8.80,'55': 8.80 },
                { ext: -18,'35': 8.60,'45': 8.60,'55': 8.60 },
                { ext: -19,'35': 8.50,'45': 8.50,'55': 8.50 },
                { ext: -20,'35': 8.30,'45': 8.30,'55': 8.30 },
                { ext: -21,'35': 8.10,'45': 8.10,'55': 8.10 },
                { ext: -22,'35': 8.00,'45': 8.00,'55': 8.00 },
                { ext: -23,'35': 7.80,'45': 7.80,'55': 7.80 },
                { ext: -24,'35': 7.70,'45': 7.70,'55': 7.70 },
                { ext: -25,'35': 7.50,'45': 7.50,'55': 7.50 }
            ],
            'S2125-20': [
                { ext: 20,'35': 27.10,'45': 26.00,'55': 24.10 },
                { ext: 12,'35': 25.40,'45': 24.30,'55': 23.10 },
                { ext: 10,'35': 22.40,'45': 22.40,'55': 21.20 },
                { ext: 7, '35': 20.01,'45': 20.01,'55': 19.42 },
                { ext: 2, '35': 17.81,'45': 18.20,'55': 18.80 },
                { ext: 1, '35': 17.01,'45': 17.90,'55': 17.90 },
                { ext: 0, '35': 16.80,'45': 16.90,'55': 16.90 },
                { ext: -1,'35': 16.60,'45': 16.60,'55': 16.60 },
                { ext: -2,'35': 15.96,'45': 15.96,'55': 15.96 },
                { ext: -3,'35': 15.45,'45': 15.45,'55': 15.45 },
                { ext: -4,'35': 14.97,'45': 14.97,'55': 14.97 },
                { ext: -5,'35': 14.91,'45': 14.91,'55': 14.91 },
                { ext: -6,'35': 14.79,'45': 14.79,'55': 14.79 },
                { ext: -7,'35': 14.61,'45': 14.61,'55': 14.61 },
                { ext: -8,'35': 13.96,'45': 13.96,'55': 13.96 },
                { ext: -9,'35': 13.56,'45': 13.56,'55': 13.56 },
                { ext: -10,'35': 12.96,'45': 12.96,'55': 12.96 },
                { ext: -11,'35': 12.81,'45': 12.81,'55': 12.81 },
                { ext: -12,'35': 12.72,'45': 12.72,'55': 12.72 },
                { ext: -13,'35': 12.43,'45': 12.43,'55': 12.43 },
                { ext: -14,'35': 12.04,'45': 12.04,'55': 12.04 },
                { ext: -15,'35': 11.91,'45': 11.91,'55': 11.91 },
                { ext: -16,'35': 11.81,'45': 11.81,'55': 11.81 },
                { ext: -17,'35': 11.05,'45': 11.05,'55': 11.05 },
                { ext: -18,'35': 10.93,'45': 10.93,'55': 10.93 },
                { ext: -19,'35': 10.53,'45': 10.53,'55': 10.53 },
                { ext: -20,'35': 10.01,'45': 10.01,'55': 10.01 },
                { ext: -21,'35': 9.96,'45': 9.96,'55': 9.96 },
                { ext: -22,'35': 9.64,'45': 9.64,'55': 9.64 },
                { ext: -23,'35': 9.45,'45': 9.45,'55': 9.45 },
                { ext: -24,'35': 9.03,'45': 9.03,'55': 9.03 },
                { ext: -25,'35': 8.47,'45': 8.47,'55': 8.47 }
            ],
            'F2050-6': [
                { ext: 2, '35': 6.9, '45': 6.9, '55': 6.4 },
                { ext: 1, '35': 6.8, '45': 6.8, '55': 6.1 },
                { ext: 0, '35': 6.6, '45': 6.4, '55': 6.0 },
                { ext: -1, '35': 6.4, '45': 6.3, '55': 5.9 },
                { ext: -2, '35': 6.2, '45': 6.2, '55': 5.8 },
                { ext: -3, '35': 6.1, '45': 6.0, '55': 5.4 },
                { ext: -4, '35': 6.0, '45': 5.6, '55': 5.1 },
                { ext: -5, '35': 5.9, '45': 5.4, '55': 5.0 },
                { ext: -6, '35': 5.6, '45': 5.2, '55': 4.9 },
                { ext: -7, '35': 5.6, '45': 5.1, '55': 4.8 },
                { ext: -8, '35': 5.4, '45': 5.0, '55': 4.6 },
                { ext: -9, '35': 5.2, '45': 4.9, '55': 4.4 },
                { ext: -10,'35': 5.1,'45': 4.8,'55': 4.3 },
                { ext: -11,'35': 5.0,'45': 4.7,'55': 4.1 },
                { ext: -12,'35': 4.9,'45': 4.6,'55': 4.0 },
                { ext: -13,'35': 4.8,'45': 4.5,'55': 3.9 },
                { ext: -14,'35': 4.6,'45': 4.4,'55': 3.8 },
                { ext: -15,'35': 4.5,'45': 4.3,'55': 3.8 },
                { ext: -16,'35': 4.4,'45': 4.2,'55': 3.6 },
                { ext: -17,'35': 4.2,'45': 4.1,'55': 3.5 },
                { ext: -18,'35': 4.0,'45': 4.0,'55': 3.4 },
                { ext: -19,'35': 3.8,'45': 3.8,'55': 3.3 },
                { ext: -20,'35': 3.7,'45': 3.7,'55': 3.1 },
                { ext: -21,'35': 0.0,'45': 0.0,'55': 0.0 },
                { ext: -22,'35': 0.0,'45': 0.0,'55': 0.0 },
                { ext: -23,'35': 0.0,'45': 0.0,'55': 0.0 },
                { ext: -24,'35': 0.0,'45': 0.0,'55': 0.0 },
                { ext: -25,'35': 0.0,'45': 0.0,'55': 0.0 }
            ],
            'F2050-10': [
                { ext: 2, '35': 10.40,'45': 10.20,'55': 9.20 },
                { ext: 1, '35': 10.30,'45': 9.90,'55': 9.10 },
                { ext: 0, '35': 10.20,'45': 9.80,'55': 9.00 },
                { ext: -1,'35': 10.10,'45': 9.60,'55': 8.70 },
                { ext: -2,'35': 10.01,'45': 9.40,'55': 8.50 },
                { ext: -3,'35': 9.80,'45': 9.10,'55': 8.00 },
                { ext: -4,'35': 9.50,'45': 8.90,'55': 7.90 },
                { ext: -5,'35': 9.30,'45': 8.70,'55': 7.60 },
                { ext: -6,'35': 9.00,'45': 8.50,'55': 7.40 },
                { ext: -7,'35': 8.90,'45': 8.20,'55': 7.10 },
                { ext: -8,'35': 8.60,'45': 8.00,'55': 7.00 },
                { ext: -9,'35': 8.30,'45': 7.80,'55': 6.70 },
                { ext: -10,'35': 8.20,'45': 7.60,'55': 6.40 },
                { ext: -11,'35': 7.90,'45': 7.20,'55': 6.30 },
                { ext: -12,'35': 7.70,'45': 7.00,'55': 6.20 },
                { ext: -13,'35': 7.50,'45': 6.80,'55': 6.10 },
                { ext: -14,'35': 7.20,'45': 6.70,'55': 5.80 },
                { ext: -15,'35': 7.10,'45': 6.60,'55': 5.50 },
                { ext: -16,'35': 6.90,'45': 6.50,'55': 5.20 },
                { ext: -17,'35': 6.50,'45': 6.30,'55': 5.00 },
                { ext: -18,'35': 6.40,'45': 6.10,'55': 4.80 },
                { ext: -19,'35': 6.10,'45': 5.80,'55': 4.60 },
                { ext: -20,'35': 5.90,'45': 5.60,'55': 4.50 },
                { ext: -21,'35': 0.0,'45': 0.0,'55': 0.0 },
                { ext: -22,'35': 0.0,'45': 0.0,'55': 0.0 },
                { ext: -23,'35': 0.0,'45': 0.0,'55': 0.0 },
                { ext: -24,'35': 0.0,'45': 0.0,'55': 0.0 },
                { ext: -25,'35': 0.0,'45': 0.0,'55': 0.0 }
            ],
            'F2050-12': [
                { ext: 9, '35': 12.50,'45': 11.50,'55': 11.50 },
                { ext: 8, '35': 12.40,'45': 11.20,'55': 11.20 },
                { ext: 7, '35': 12.10,'45': 11.10,'55': 11.10 },
                { ext: 6, '35': 11.90,'45': 10.90,'55': 10.90 },
                { ext: 5, '35': 11.70,'45': 10.30,'55': 10.10 },
                { ext: 4, '35': 11.50,'45': 10.30,'55': 9.70 },
                { ext: 3, '35': 11.00,'45': 10.00,'55': 9.40 },
                { ext: 2, '35': 10.50,'45': 9.90,'55': 9.00 },
                { ext: 1, '35': 10.10,'45': 9.70,'55': 8.90 },
                { ext: 0, '35': 9.90,'45': 9.60,'55': 8.80 },
                { ext: -1, '35': 9.80,'45': 9.40,'55': 8.80 },
                { ext: -2, '35': 9.60,'45': 9.10,'55': 8.70 },
                { ext: -3, '35': 9.30,'45': 8.90,'55': 8.10 },
                { ext: -4, '35': 9.00,'45': 8.40,'55': 7.90 },
                { ext: -5, '35': 8.80,'45': 8.20,'55': 7.50 },
                { ext: -6, '35': 8.60,'45': 8.00,'55': 7.30 },
                { ext: -7, '35': 8.40,'45': 7.80,'55': 7.00 },
                { ext: -8, '35': 8.20,'45': 7.40,'55': 6.80 },
                { ext: -9, '35': 7.80,'45': 7.20,'55': 6.50 },
                { ext: -10,'35': 7.50,'45': 7.00,'55': 6.30 },
                { ext: -11,'35': 7.20,'45': 6.70,'55': 6.20 },
                { ext: -12,'35': 7.00,'45': 6.50,'55': 6.00 },
                { ext: -13,'35': 6.80,'45': 6.30,'55': 5.80 },
                { ext: -14,'35': 6.60,'45': 6.10,'55': 5.70 },
                { ext: -15,'35': 6.40,'45': 5.90,'55': 5.50 },
                { ext: -16,'35': 6.20,'45': 5.80,'55': 5.00 },
                { ext: -17,'35': 6.00,'45': 5.70,'55': 4.90 },
                { ext: -18,'35': 5.80,'45': 5.50,'55': 4.80 },
                { ext: -19,'35': 5.60,'45': 5.10,'55': 4.70 },
                { ext: -20,'35': 5.40,'45': 4.90,'55': 4.60 },
                { ext: -21,'35': 5.20,'45': 4.80,'55': 4.50 },
                { ext: -22,'35': 5.00,'45': 4.70,'55': 4.30 },
                { ext: -23,'35': 4.80,'45': 4.60,'55': 3.90 },
                { ext: -24,'35': 4.60,'45': 4.40,'55': 3.80 },
                { ext: -25,'35': 4.40,'45': 4.10,'55': 3.70 }
            ],
            'F2050-16': [
                { ext: 9,'35': 17.00,'45': 15.40,'55': 15.40 },
                { ext: 8,'35': 16.87,'45': 14.90,'55': 14.90 },
                { ext: 7,'35': 16.09,'45': 14.40,'55': 14.40 },
                { ext: 6,'35': 15.91,'45': 14.10,'55': 14.10 },
                { ext: 5,'35': 15.50,'45': 13.80,'55': 13.80 },
                { ext: 4,'35': 15.04,'45': 13.60,'55': 13.60 },
                { ext: 3,'35': 14.70,'45': 13.00,'55': 13.00 },
                { ext: 2,'35': 14.40,'45': 12.70,'55': 12.70 },
                { ext: 1,'35': 14.00,'45': 12.40,'55': 12.40 },
                { ext: 0,'35': 13.70,'45': 12.00,'55': 12.00 },
                { ext: -1,'35': 13.40,'45': 11.70,'55': 11.70 },
                { ext: -2,'35': 13.00,'45': 11.50,'55': 11.50 },
                { ext: -3,'35': 12.80,'45': 11.00,'55': 11.00 },
                { ext: -4,'35': 12.40,'45': 10.80,'55': 10.80 },
                { ext: -5,'35': 11.90,'45': 10.50,'55': 10.50 },
                { ext: -6,'35': 11.60,'45': 10.00,'55': 10.00 },
                { ext: -7,'35': 11.30,'45': 9.70,'55': 9.70 },
                { ext: -8,'35': 11.10,'45': 9.40,'55': 9.40 },
                { ext: -9,'35': 10.80,'45': 9.00,'55': 9.00 },
                { ext: -10,'35': 10.40,'45': 8.70,'55': 8.70 },
                { ext: -11,'35': 10.00,'45': 8.40,'55': 8.40 },
                { ext: -12,'35': 9.80,'45': 8.00,'55': 8.00 },
                { ext: -13,'35': 9.40,'45': 7.70,'55': 7.70 },
                { ext: -14,'35': 9.00,'45': 7.40,'55': 7.40 },
                { ext: -15,'35': 8.50,'45': 7.20,'55': 7.20 },
                { ext: -16,'35': 7.90,'45': 6.70,'55': 6.70 },
                { ext: -17,'35': 7.40,'45': 6.40,'55': 6.40 },
                { ext: -18,'35': 7.10,'45': 6.10,'55': 6.10 },
                { ext: -19,'35': 7.00,'45': 5.90,'55': 5.90 },
                { ext: -20,'35': 6.90,'45': 5.60,'55': 5.60 },
                { ext: -21,'35': 6.20,'45': 5.10,'55': 5.10 },
                { ext: -22,'35': 5.80,'45': 5.00,'55': 5.00 },
                { ext: -23,'35': 5.60,'45': 4.80,'55': 4.80 },
                { ext: -24,'35': 5.50,'45': 4.60,'55': 4.60 },
                { ext: -25,'35': 5.30,'45': 4.20,'55': 4.20 }
            ],
            'AMS 20-6': [],
            'AMS 20-10': []
        };
        airEauData['AMS 20-6'] = airEauData['F2050-6'];
        airEauData['AMS 20-10'] = airEauData['F2050-10'];

        /* Air Extract capacities (kW) */
        const airExtractData = {
            'S735-4': {
                '60':  { '35': 1.3,  '45': 1.4,  '55': 1.5 },
                '75':  { '35': 1.5,  '45': 1.6,  '55': 1.75 },
                '90':  { '35': 1.8,  '45': 2.0,  '55': 2.25 },
                '105': { '35': 2.2,  '45': 2.4,  '55': 2.6 },
                '120': { '35': 2.4,  '45': 2.65, '55': 2.9 },
                '135': { '35': 2.65, '45': 3.05, '55': 3.2 },
                '150': { '35': 2.9,  '45': 3.25, '55': 3.4 },
                '165': { '35': 3.25, '45': 3.5,  '55': 3.6 },
                '180': { '35': 3.45, '45': 3.6,  '55': 3.75 },
                '195': { '35': 3.65, '45': 3.8,  '55': 3.9 },
                '210': { '35': 3.8,  '45': 3.9,  '55': 4.0 },
                '225': { '35': 3.9,  '45': 4.0,  '55': 4.1 },
                '240': { '35': 3.9,  '45': 4.0,  '55': 4.1 },
                '255': { '35': 4.2,  '45': 4.2,  '55': 4.2 },
                '270': { '35': 4.2,  '45': 4.2,  '55': 4.2 },
                '285': { '35': 4.2,  '45': 4.2,  '55': 4.2 },
                '300': { '35': 4.2,  '45': 4.2,  '55': 4.2 },
                '315': { '35': 4.2,  '45': 4.2,  '55': 4.2 },
                '330': { '35': 4.2,  '45': 4.2,  '55': 4.2 },
                '345': { '35': 4.2,  '45': 4.2,  '55': 4.2 },
                '360': { '35': 4.2,  '45': 4.2,  '55': 4.2 },
                '375': { '35': 4.2,  '45': 4.2,  '55': 4.2 },
                '390': { '35': 4.2,  '45': 4.2,  '55': 4.2 }
            },
            'S735-7': {
                '90':  { '35': 2.0,  '45': 2.23,'55': 2.6 },
                '105': { '35': 2.4,  '45': 2.6, '55': 3.0 },
                '120': { '35': 2.6,  '45': 2.9, '55': 3.2 },
                '135': { '35': 3.0,  '45': 3.25,'55': 3.65 },
                '150': { '35': 3.25, '45': 3.5, '55': 3.8 },
                '165': { '35': 3.6,  '45': 3.9, '55': 4.2 },
                '180': { '35': 4.0,  '45': 4.5, '55': 4.6 },
                '195': { '35': 4.2,  '45': 4.6, '55': 4.75 },
                '210': { '35': 4.4,  '45': 4.7, '55': 5.0 },
                '225': { '35': 4.8,  '45': 4.95,'55': 5.15 },
                '240': { '35': 4.8,  '45': 4.95,'55': 5.15 },
                '255': { '35': 5.2,  '45': 5.4, '55': 5.4 },
                '270': { '35': 5.4,  '45': 5.5, '55': 5.5 },
                '285': { '35': 5.4,  '45': 5.5, '55': 5.5 },
                '300': { '35': 5.8,  '45': 5.9, '55': 6.0 },
                '315': { '35': 5.9,  '45': 6.0, '55': 6.1 },
                '330': { '35': 6.2,  '45': 6.25,'55': 6.3 },
                '345': { '35': 6.3,  '45': 6.3, '55': 6.4 },
                '360': { '35': 6.4,  '45': 6.42,'55': 6.52 },
                '375': { '35': 6.4,  '45': 6.42,'55': 6.52 },
                '390': { '35': 6.4,  '45': 6.42,'55': 6.52 }
            },
            'S735-7C': {
                '90':  { '35': 2.0,  '45': 2.23,'55': 2.6 },
                '105': { '35': 2.4,  '45': 2.6, '55': 3.0 },
                '120': { '35': 2.6,  '45': 2.9, '55': 3.2 },
                '135': { '35': 3.0,  '45': 3.25,'55': 3.65 },
                '150': { '35': 3.25, '45': 3.5, '55': 3.8 },
                '165': { '35': 3.6,  '45': 3.9, '55': 4.2 },
                '180': { '35': 4.0,  '45': 4.5, '55': 4.6 },
                '195': { '35': 4.2,  '45': 4.6, '55': 4.75 },
                '210': { '35': 4.4,  '45': 4.7, '55': 5.0 },
                '225': { '35': 4.8,  '45': 4.95,'55': 5.15 },
                '240': { '35': 4.8,  '45': 4.95,'55': 5.15 },
                '255': { '35': 5.2,  '45': 5.4, '55': 5.4 },
                '270': { '35': 5.4,  '45': 5.5, '55': 5.5 },
                '285': { '35': 5.4,  '45': 5.5, '55': 5.5 },
                '300': { '35': 5.8,  '45': 5.9, '55': 6.0 },
                '315': { '35': 5.9,  '45': 6.0, '55': 6.1 },
                '330': { '35': 6.2,  '45': 6.25,'55': 6.3 },
                '345': { '35': 6.3,  '45': 6.3, '55': 6.4 },
                '360': { '35': 6.4,  '45': 6.42,'55': 6.52 },
                '375': { '35': 6.4,  '45': 6.42,'55': 6.52 },
                '390': { '35': 6.4,  '45': 6.42,'55': 6.52 }
            }
        };

        // ETAS values
        const etasMap = {
            'S735-4': { '35': 191, '55': 147 },
            'S735-7': { '35': 181, '55': 148 },
            'S735-7C':{ '35': 193, '55': 154 },
            'F2050-6':{ '35': 204, '55': 143 },
            'F2050-10':{ '35': 185, '55': 136 },
            'F2050-12':{ '35': 196, '55': 141 },
            'F2050-16':{ '35': 184, '55': 138 },
            'AMS 20-6':{ '35': 204, '55': 143 },
            'AMS 20-10':{ '35': 185, '55': 136 },
            'S2125-8':{ '35': 200, '55': 150 },
            'S2125-12':{ '35': 199, '55': 154 },
            'S2125-16':{ '35': 214, '55': 164 },
            'S2125-20':{ '35': 213, '55': 164 },
            // Géothermie
            'F1153-4':{ '35': 206, '55': 154 },
            'F1153-6':{ '35': 204, '55': 154 },
            'F1253-4':{ '35': 206, '55': 154 },
            'F1253-6':{ '35': 204, '55': 154 },
            'S1156-8':{ '35': 223, '55': 166 },
            'S1156-13':{ '35': 231, '55': 167 },
            'S1156-18':{ '35': 234, '55': 173 },
            'S1155-25':{ '35': 204, '55': 154 },
            'S1256-8':{ '35': 223, '55': 166 },
            'S1256-13':{ '35': 231, '55': 167 },
            'S1256-18':{ '35': 234, '55': 173 },
            'F1345-24':{ '35': 187, '55': 145 },
            'F1345-30':{ '35': 180, '55': 139 },
            'F1345-40':{ '35': 184, '55': 145 },
            'F1345-60':{ '35': 178, '55': 140 },
            'F1355-28':{ '35': 195, '55': 152 },
            'F1355-43':{ '35': 194, '55': 154 },
            // Aquathermie
            'F1353-4':{ '35': 272, '55': 210 },
            'F1153-4-10':{ '35': 272, '55': 210 },
            'F1153-6-10':{ '35': 270, '55': 214 },
            'F1253-4-10':{ '35': 272, '55': 210 },
            'F1253-6-10':{ '35': 270, '55': 214 },
            'S1156-8-10':{ '35': 311, '55': 221 },
            'S1156-13-10':{ '35': 346, '55': 236 },
            'S1156-18-10':{ '35': 333, '55': 232 },
            'S1155-25-10':{ '35': 289, '55': 201 },
            'S1256-8-10':{ '35': 311, '55': 221 },
            'S1256-13-10':{ '35': 346, '55': 236 },
            'S1256-18-10':{ '35': 333, '55': 232 },
            'F1345-24-10':{ '35': 229, '55': 178 },
            'F1345-30-10':{ '35': 215, '55': 165 },
            'F1345-40-10':{ '35': 223, '55': 179 },
            'F1345-60-10':{ '35': 212, '55': 166 },
            'F1355-28-10':{ '35': 244, '55': 190 },
            'F1355-43-10':{ '35': 246, '55': 196 }
        };

        const aquathermFlowMap = {
            'F1153-4': 1.0,
            'F1253-4': 1.0,
            'F1153-6': 1.1,
            'F1253-6': 1.1,
            'S1156-8': 1.3,
            'S1256-8': 1.3,
            'S1156-13': 3.1,
            'S1256-13': 3.1,
            'S1156-18': 4.2,
            'S1256-18': 4.2,
            'S1155-25': 6.1,
            'F1355-28': 6.1,
            'F1355-43': 8.0,
            'F1345-24': 4.7,
            'F1345-30': 6.1,
            'F1345-40': 7.6,
            'F1345-60': 11.9
        };

        // Application state
        let currentStep = 1;
        let zones = [];
        let pool = null; // piscine unique
        let airExtrFlowManuallySelected = false;
        let finalBaseTemp = null;
        let finalPac = null; // stocke les infos PAC pour les liens doc
        let airExtrPoolWarned = false;

        function getMaxHeating() {
            let heatingMax = zones.reduce((acc, z) => Math.max(acc, z.heating), 0);
            if (pool && pool.mode === 'toutesaison') {
                heatingMax = Math.max(heatingMax, pool.localHeating);
            }
            return heatingMax;
        }

        function updateAirExtrAvailability() {
            const techSelect = document.getElementById('technologySelect');
            if (!techSelect) return;
            const airExtrOption = Array.from(techSelect.options).find(o => o.value === 'airextr');
            if (!airExtrOption) return;

            if (pool) {
                airExtrOption.disabled = true;
                if (techSelect.value === 'airextr') {
                    techSelect.value = '';
                    document.getElementById('airExtrOptions').classList.add('hidden');
                    const vmcBlock = document.getElementById('vmcGuide');
                    if (vmcBlock) vmcBlock.classList.add('hidden');
                    document.getElementById('techSummary').classList.add('hidden');
                    alert("La technologie Air-Extrait ne permet pas de piloter une piscine.");
                }
            } else {
                airExtrOption.disabled = false;
            }
        }

        function showStep(step) {
            const steps = document.querySelectorAll('.step');
            steps.forEach((s, idx) => {
                const currentIndex = idx + 1;
                if (currentIndex === step) {
                    s.style.display = 'block';
                    setTimeout(() => s.classList.add('active'), 10);
                } else {
                    s.classList.remove('active');
                    setTimeout(() => { s.style.display = 'none'; }, 400);
                }
            });
            // Afficher/masquer les boutons de navigation selon l'étape courante.
            // Sur les étapes de note (5) et de devis (6), nous masquons la navigation générale
            // afin d'utiliser des boutons spécifiques placés dans ces sections.
            if (step >= 5) {
                document.getElementById('prevBtn').style.display = 'none';
                document.getElementById('nextBtn').style.display = 'none';
            } else {
                document.getElementById('prevBtn').style.display = (step === 1) ? 'none' : 'inline-block';
                document.getElementById('nextBtn').style.display = 'inline-block';
            }

            // Masquer l'en‑tête (logo et titre) sur les étapes finales (5 et 6) pour un rendu épuré.
            const headerElem = document.querySelector('.header');
            if (headerElem) {
                headerElem.style.display = (step >= 5) ? 'none' : 'flex';
            }
            if (step === 4) {
                const techSel = document.getElementById('technologySelect').value;
                if (techSel === 'airextr') {
                    airExtrFlowManuallySelected = false;
                }
                computeTechnology();
            }
        }

        function nextStep() {
            // Champs obligatoires
            if (currentStep === 1) {
                const inst = document.getElementById('companyName').value.trim();
                if (!inst) {
                    alert("Veuillez saisir le nom de l'installateur.");
                    return;
                }
            }
            if (currentStep === 2) {
                const benefNom = document.getElementById('beneficiaryLastName').value.trim();
                if (!benefNom) {
                    alert("Veuillez saisir le nom du bénéficiaire.");
                    return;
                }
                const postal = document.getElementById('beneficiaryPostalCode').value.trim();
                if (!postal) {
                    alert("Veuillez saisir le code postal du bénéficiaire.");
                    return;
                }
                if (!/^\d{5}$/.test(postal)) {
                    alert("Veuillez saisir un code postal valide (5 chiffres).");
                    return;
                }
                computeBaseTemp();
            }
            if (currentStep === 3) {
                updateProjectSummary();
                let hasZone = zones.some(z => (parseFloat(z.area) > 0) || (z.manual && parseFloat(z.manualValue) > 0));
                if (!hasZone && pool && pool.mode === 'toutesaison' && pool.localArea > 0) {
                    hasZone = true;
                }
                if (!hasZone) {
                    alert("Veuillez ajouter une zone avec une surface renseignée (supérieure à zéro) ou saisir manuellement les déperditions.");
                    return;
                }
            }
            if (currentStep === 4) {
                const techSel = document.getElementById('technologySelect').value;
                if (!techSel) {
                    alert("Veuillez sélectionner une technologie et un modèle de PAC.");
                    return;
                }
                computeTechnology();
                buildFinalReport();
            }
            // Sauvegarder l'étape courante pour savoir si l'on passe du rapport au devis
            const prev = currentStep;
            // Passer à l'étape suivante si elle existe (jusqu'à la page devis incluse)
            if (currentStep < 5) currentStep++;
            showStep(currentStep);
            // Si l'on vient de quitter l'étape 5 (note) pour aller à l'étape 6, préparer le devis
            if (prev === 5 && currentStep === 6) {
                if (typeof goToDevis === 'function') {
                    goToDevis();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        // Masquer l'ancienne section de devis intégrée à l'étape 5 si elle est présente.
        document.addEventListener('DOMContentLoaded', () => {
            // Certaines versions du fichier contiennent une ancienne section de devis dans l'étape 5 (classée comme .devis-form).
            // Nous parcourons les formulaires de devis présents dans l'étape 5 et les masquons afin que seul le véritable devis
            // (étape 6) soit visible lorsqu'on y accède depuis la note. Cela évite que le devis apparaisse sous la note.
            const step5 = document.getElementById('step5');
            if (step5) {
                const oldForms = step5.querySelectorAll('.devis-form');
                oldForms.forEach(form => {
                    const container = form.closest('div');
                    if (container) {
                        container.style.display = 'none';
                    }
                });
            }
        });

        // Calcule les kits de zones mélangées à partir des zones définies et de la surface totale.
        // Retourne un tableau de références (N067287 ou N067288) selon le nombre de kits nécessaires.
        function computeZoneKits() {
            const uniqueTemps = new Set();
            let totalSurface = 0;
            zones.forEach(z => {
                const area = parseFloat(z.area) || 0;
                const manualVal = z.manual ? parseFloat(z.manualValue) || 0 : 0;
                const hasSurface = (area > 0) || (manualVal > 0);
                if (hasSurface) {
                    uniqueTemps.add(String(z.temperature || ''));
                    totalSurface += area;
                }
            });
            let kitCount = 0;
            // Plusieurs températures différentes : un kit par température supplémentaire.
            if (uniqueTemps.size > 1) {
                kitCount = uniqueTemps.size - 1;
            } else if (uniqueTemps.size === 1) {
                // Une seule température : si 35 °C et surface importante, prévoir un kit.
                const tempVal = Array.from(uniqueTemps)[0];
                if (tempVal === '35' && totalSurface > 140) {
                    kitCount = 1;
                }
            }
            // Choisir le type de kit : ECS40 si surface ≤80 m², ECS41 sinon.
            const kitRef = (totalSurface <= 80) ? 'N067287' : 'N067288';
            const kits = [];
            for (let i = 0; i < kitCount; i++) {
                kits.push(kitRef);
            }
            return kits;
        }

        // Fonction appelée lors du clic sur le bouton Devis.
        // Elle stocke les données pertinentes dans le localStorage et ouvre la page de devis.
        function goToDevis() {
            // S'assurer que la technologie est calculée pour remplir finalPac.
            if (!finalPac || !finalPac.model) {
                computeTechnology();
            }
            if (!finalPac || !finalPac.model) {
                alert("Aucune pompe à chaleur n'est sélectionnée.");
                return;
            }
            // Enregistrer le nom de l'installateur.
            const instNameInput = document.getElementById('companyName');
            if (instNameInput && instNameInput.value.trim()) {
                localStorage.setItem('installerName', instNameInput.value.trim());
            } else {
                localStorage.removeItem('installerName');
            }
            // Calculer et enregistrer les kits de zones mélangées.
            const kitRefs = computeZoneKits();
            if (kitRefs && kitRefs.length > 0) {
                localStorage.setItem('kitRefs', JSON.stringify(kitRefs));
            } else {
                localStorage.removeItem('kitRefs');
            }
            // Enregistrer l'information de piscine (mode) si existante.
            if (pool) {
                localStorage.setItem('poolMode', pool.mode || 'true');
            } else {
                localStorage.removeItem('poolMode');
            }
            // Enregistrer les informations de dimensionnement.
            localStorage.setItem('finalPac', JSON.stringify(finalPac));
            // Ouvrir la page de devis dans la même interface (étape 6).
            // Pré-remplir le modèle de PAC sélectionné par la note et afficher l'étape devis.
            showStep(6);
            // Pré-sélectionner le modèle et mettre à jour les options après un court délai pour garantir le rendu.
            setTimeout(() => {
                const prodSelect = document.getElementById('devisProduct');
                if (prodSelect) {
                    prodSelect.value = finalPac && finalPac.model ? finalPac.model : '';
                    if (typeof updateEcsVolumeOptions === 'function') updateEcsVolumeOptions();
                    if (typeof updateSepVolumeOptions === 'function') updateSepVolumeOptions();
                }
                // Afficher ou masquer les sections ECS selon l'usage initial (chauffage seul par défaut)
                if (typeof toggleEcsOptions === 'function') toggleEcsOptions();
                if (typeof toggleEcsDetail === 'function') toggleEcsDetail();
                // Générer le devis initial
                if (typeof generateDevis === 'function') generateDevis();
            }, 200);
        }

        function computeBaseTemp() {
            const postal = document.getElementById('beneficiaryPostalCode').value.trim();
            let dept = postal.substring(0,2);
            if (dept === '97' || dept === '98') {
                dept = postal.substring(0,3);
            }
            let rawBase = baseTempMapping[dept] !== undefined ? baseTempMapping[dept] : 0;
            const bord = document.getElementById('bordDeMer').checked;

            // Ajustement spécifique bord de mer (<25 km)
            let adjustedBase = rawBase;
            if (bord) {
                const bordMap = {
                    '-2': -2,
                    '-4': -2,
                    '-5': -4,
                    '-6': -6,
                    '-7': -7,
                    '-8': -8,
                    '-10': -10,
                    '-12': -12,
                    '-15': -15
                };
                const key = String(rawBase);
                if (bordMap.hasOwnProperty(key)) {
                    adjustedBase = bordMap[key];
                }
            }

            const alt = document.getElementById('altitudeRange').value;
            const baseKey = adjustedBase.toString();
            let finalBase = adjustedBase;
            if (altitudeMap[baseKey] && altitudeMap[baseKey][alt] !== undefined) {
                finalBase = altitudeMap[baseKey][alt];
            }
            finalBaseTemp = finalBase;
            document.getElementById('baseTempValue').textContent = finalBase;

            const tech = document.getElementById('technologySelect').value;
            if (tech) {
                computeTechnology();
            }
            if (pool) {
                computePoolLoss();
                updateProjectSummary();
            }
        }

        document.getElementById('beneficiaryPostalCode').addEventListener('blur', computeBaseTemp);
        document.getElementById('altitudeRange').addEventListener('change', computeBaseTemp);
        document.getElementById('bordDeMer').addEventListener('change', computeBaseTemp);

        function addZone() {
            if (zones.length >= 20) return;
            const zone = {
                area: 0,
                height: 2.5,
                insulation: 'entre 1990-2000',
                manual: false,
                manualValue: 0,
                ambient: 20,
                heating: 45,
                loss: 0
            };
            zones.push(zone);
            renderZones();
        }

        function removeZone(i) {
            zones.splice(i,1);
            renderZones();
            updateProjectSummary();
        }

        function renderZones() {
            const container = document.getElementById('zonesContainer');
            container.innerHTML = '';
            zones.forEach((zone, i) => {
                const div = document.createElement('div');
                div.className = 'zone';
                const insulationOptions = gCoefficients.map(gc => {
                    const display = gc.value !== null ? `${gc.value.toFixed(2)} – ${gc.label}` : gc.label;
                    return `<option value="${gc.label}" ${gc.label===zone.insulation?'selected':''}>${display}</option>`;
                }).join('');
                div.innerHTML = `
                    <h4>Zone ${i+1}</h4>
                    <div class="zone-row">
                        <div class="field">
                            <span>Surface (m²)</span>
                            <input type="number" min="0" step="0.1" value="${zone.area}" onchange="updateZoneValue(${i}, 'area', this.value)">
                        </div>
                        <div class="field">
                            <span>Hauteur (m)</span>
                            <input type="number" min="0" step="0.1" value="${zone.height}" onchange="updateZoneValue(${i}, 'height', this.value)">
                        </div>
                        <div class="field">
                            <span>Isolation (Coeff. G)</span>
                            <select onchange="updateZoneValue(${i}, 'insulation', this.value)">
                                ${insulationOptions}
                            </select>
                        </div>
                        <div class="field">
                            <span>Temp. fonctionnement (°C)</span>
                            <select onchange="updateZoneValue(${i}, 'heating', this.value)">
                                <option value="35" ${zone.heating==35?'selected':''}>35°C</option>
                                <option value="45" ${zone.heating==45?'selected':''}>45°C</option>
                                <option value="55" ${zone.heating==55?'selected':''}>55°C</option>
                                <option value="65" ${zone.heating==65?'selected':''}>65°C</option>
                            </select>
                        </div>
                        <div class="field">
                            <span>Temp. ambiante (°C)</span>
                            <input type="number" min="5" max="30" step="0.5" value="${zone.ambient}" onchange="updateZoneValue(${i}, 'ambient', this.value)">
                        </div>
                        <div class="loss-display"><span>Déperdition&nbsp;:&nbsp;<span id="zoneLoss${i}">${zone.loss.toFixed(2)}</span>&nbsp;kW</span></div>
                        <div>
                            <button type="button" class="remove-zone-btn" onclick="removeZone(${i})" ${i===0 ? 'style="visibility:hidden"' : ''}>Supprimer</button>
                        </div>
                    </div>
                    <div id="manualInput${i}" class="${zone.insulation==='saisie manuelle'?'':'hidden'} manual-input">
                        <label>Déperdition saisie (kW)<br><input type="number" min="0" step="0.1" value="${zone.manualValue}" onchange="updateZoneValue(${i}, 'manualValue', this.value)"></label>
                    </div>
                `;
                container.appendChild(div);
            });
            if (pool) {
                renderPool();
            }
        }

        function updateZoneValue(index, field, value) {
            const zone = zones[index];
            if (field === 'area' || field === 'height' || field === 'ambient' || field === 'manualValue') {
                zone[field] = parseFloat(value);
            } else if (field === 'heating') {
                zone[field] = parseInt(value);
            } else if (field === 'insulation') {
                zone[field] = value;
                zone.manual = (value === 'saisie manuelle');
                document.getElementById('manualInput'+index).classList.toggle('hidden', !zone.manual);
            }
            computeZoneLoss(index);
            updateProjectSummary();
            renderZones();
            if (document.getElementById('technologySelect').value) {
                computeTechnology();
            }
        }

        function computeZoneLoss(i) {
            const zone = zones[i];
            if (finalBaseTemp === null && finalBaseTemp !== 0) {
                computeBaseTemp();
            }
            let loss = 0;
            if (zone.manual) {
                loss = parseFloat(zone.manualValue) || 0;
            } else {
                const gObj = gCoefficients.find(gc => gc.label === zone.insulation);
                const g = gObj ? gObj.value : 1;
                const deltaT = zone.ambient - finalBaseTemp;
                if (deltaT < 0) {
                    loss = 0;
                } else {
                    loss = (g * zone.area * zone.height * deltaT) / 1000;
                }
            }
            zone.loss = loss;
        }

        // =========================
        // PISCINE
        // =========================
        function addPool() {
            if (pool) return;
            pool = {
                mode: 'estivale', // par défaut estivale
                localArea: 0,
                localHeight: 3,
                localInsulation: 'entre 1990-2000',
                localManual: false,
                localManualLoss: 0,
                localAmbient: 28,
                localHeating: 35,
                basinLength: 0,
                basinWidth: 0,
                basinDepth: 1.5,
                basinTemp: 28,
                totalLoss: 0
            };
            const btn = document.getElementById('addPoolBtn');
            if (btn) btn.style.display = 'none';
            renderPool();
            computePoolLoss();
            updateProjectSummary();
            updateAirExtrAvailability();
        }

        function removePool() {
            pool = null;
            const poolContainer = document.getElementById('poolContainer');
            if (poolContainer) poolContainer.innerHTML = '';
            const btn = document.getElementById('addPoolBtn');
            if (btn) btn.style.display = 'inline-flex';
            updateProjectSummary();
            updateAirExtrAvailability();
        }

        function renderPool() {
            const container = document.getElementById('poolContainer');
            if (!container || !pool) return;

            const insulationOptions = gCoefficients.map(gc => {
                const display = gc.value !== null ? `${gc.value.toFixed(2)} – ${gc.label}` : gc.label;
                return `<option value="${gc.label}" ${gc.label===pool.localInsulation?'selected':''}>${display}</option>`;
            }).join('');

            const showLocal = (pool.mode === 'toutesaison');
            const localManualVisible = showLocal && pool.localInsulation === 'saisie manuelle';

            const volumeBassin = (pool.basinLength || 0) * (pool.basinWidth || 0) * (pool.basinDepth || 0);

            container.innerHTML = `
                <div class="zone">
                    <h4>Piscine</h4>
                    <div class="zone-row">
                        <div class="field">
                            <span>Type de piscine</span>
                            <select onchange="updatePoolValue('mode', this.value)">
                                <option value="toutesaison" ${pool.mode==='toutesaison'?'selected':''}>Toute saison</option>
                                <option value="estivale" ${pool.mode==='estivale'?'selected':''}>Estivale</option>
                            </select>
                        </div>
                    </div>

                    <div id="poolLocalBlock" class="${showLocal ? '' : 'hidden'}">
                        <div class="zone-row">
                            <div class="field">
                                <span>Surface du local (m²)</span>
                                <input type="number" min="0" step="0.1" value="${pool.localArea}" onchange="updatePoolValue('localArea', this.value)">
                            </div>
                            <div class="field">
                                <span>Hauteur du local (m)</span>
                                <input type="number" min="0" step="0.1" value="${pool.localHeight}" onchange="updatePoolValue('localHeight', this.value)">
                            </div>
                            <div class="field">
                                <span>Isolation (Coeff. G)</span>
                                <select onchange="updatePoolValue('localInsulation', this.value)">
                                    ${insulationOptions}
                                </select>
                            </div>
                            <div class="field">
                                <span>Temp. fonctionnement (°C)</span>
                                <select onchange="updatePoolValue('localHeating', this.value)">
                                    <option value="35" ${pool.localHeating==35?'selected':''}>35°C</option>
                                    <option value="45" ${pool.localHeating==45?'selected':''}>45°C</option>
                                    <option value="55" ${pool.localHeating==55?'selected':''}>55°C</option>
                                    <option value="65" ${pool.localHeating==65?'selected':''}>65°C</option>
                                </select>
                            </div>
                            <div class="field">
                                <span>Temp. ambiante (°C)</span>
                                <input type="number" min="5" max="30" step="0.5" value="${pool.localAmbient}" onchange="updatePoolValue('localAmbient', this.value)">
                            </div>
                        </div>
                        <div id="poolLocalManual" class="${localManualVisible ? '' : 'hidden'} manual-input">
                            <label>Déperdition saisie (kW)<br>
                                <input type="number" min="0" step="0.1" value="${pool.localManualLoss}" onchange="updatePoolValue('localManualLoss', this.value)">
                            </label>
                        </div>
                    </div>

                    <div id="poolBasinBlock">
                        <h5>Bassin</h5>
                        <div class="zone-row">
                            <div class="field">
                                <span>Longueur bassin (m)</span>
                                <input type="number" min="0" step="0.1" value="${pool.basinLength}" onchange="updatePoolValue('basinLength', this.value)">
                            </div>
                            <div class="field">
                                <span>Largeur bassin (m)</span>
                                <input type="number" min="0" step="0.1" value="${pool.basinWidth}" onchange="updatePoolValue('basinWidth', this.value)">
                            </div>
                            <div class="field">
                                <span>Profondeur moyenne (m)</span>
                                <input type="number" min="0" step="0.1" value="${pool.basinDepth}" onchange="updatePoolValue('basinDepth', this.value)">
                            </div>
                            <div class="field">
                                <span>Température du bassin (°C)</span>
                                <input type="number" min="5" max="40" step="0.5" value="${pool.basinTemp}" onchange="updatePoolValue('basinTemp', this.value)">
                            </div>
                        </div>
                        <div class="loss-display" style="margin-top:8px;">
                            Volume bassin :&nbsp;<span id="poolVolumeValue">${volumeBassin.toFixed(2)}</span> m³
                        </div>
                    </div>

                    <div class="loss-display" style="margin-top:8px;">
                        Déperdition piscine :&nbsp;<span id="poolLossValue">${pool.totalLoss.toFixed(2)}</span> kW
                    </div>
                    <div style="margin-top:8px;">
                        <button type="button" class="remove-zone-btn" onclick="removePool()">Supprimer la piscine</button>
                    </div>
                </div>
            `;
        }

        function updatePoolValue(field, value) {
            if (!pool) return;
            if (field === 'mode') {
                pool.mode = value === 'estivale' ? 'estivale' : 'toutesaison';
                if (pool.mode === 'toutesaison' && (pool.localArea || 0) <= 0) pool.localArea = 1;
            } else if (field === 'localArea') {
                pool.localArea = parseFloat(value) || 0;
                if (pool.mode === 'toutesaison' && pool.localArea <= 0) pool.localArea = 1;
            } else if (['localArea','localHeight','localAmbient','localManualLoss','basinLength','basinWidth','basinDepth','basinTemp'].includes(field)) {
                pool[field] = parseFloat(value) || 0;
            } else if (field === 'localInsulation') {
                pool.localInsulation = value;
                pool.localManual = (value === 'saisie manuelle');
            } else if (field === 'localHeating') {
                pool.localHeating = parseInt(value);
            }
            computePoolLoss();
            renderPool();
            updateProjectSummary();
            if (document.getElementById('technologySelect').value) {
                computeTechnology();
            }
        }

        function computePoolLoss() {
            if (!pool) return;
            if (finalBaseTemp === null && finalBaseTemp !== 0) {
                computeBaseTemp();
            }
            let localLoss = 0;
            let basinLoss = 0;

            // Local uniquement en toute saison
            if (pool.mode === 'toutesaison') {
                if (pool.localManual) {
                    localLoss = parseFloat(pool.localManualLoss) || 0;
                } else {
                    const gObj = gCoefficients.find(gc => gc.label === pool.localInsulation);
                    const g = gObj ? gObj.value : 1;
                    const deltaT = pool.localAmbient - finalBaseTemp;
                    if (deltaT > 0 && pool.localArea > 0 && pool.localHeight > 0) {
                        localLoss = (g * pool.localArea * pool.localHeight * deltaT) / 1000;
                    }
                }
            }

            // Bassin (volume * 71 W/m³ -> kW)
            if (pool.basinLength > 0 && pool.basinWidth > 0 && pool.basinDepth > 0) {
                const volume = pool.basinLength * pool.basinWidth * pool.basinDepth; // m³
                basinLoss = 0.071 * volume; // kW
            }

            if (pool.mode === 'toutesaison') {
                pool.totalLoss = localLoss + basinLoss;
            } else {
                pool.totalLoss = basinLoss;
            }

            const poolLossValue = document.getElementById('poolLossValue');
            if (poolLossValue) {
                poolLossValue.textContent = pool.totalLoss.toFixed(2);
            }

            const poolVolumeValue = document.getElementById('poolVolumeValue');
            if (poolVolumeValue) {
                const volumeBassin = (pool.basinLength || 0) * (pool.basinWidth || 0) * (pool.basinDepth || 0);
                poolVolumeValue.textContent = volumeBassin.toFixed(2);
            }
        }

        function updateProjectSummary() {
            if (zones.length === 0 && !pool) {
                document.getElementById('projectSummary').classList.add('hidden');
                return;
            }
            let totalLoss = 0;
            let surfacesByTemp = { '35':0, '45':0, '55':0, '65':0 };
            let sumHeights = 0;
            let maxAmbientZone = 0;  // max ambiance habitation (sans local piscine)
            let maxHeating = 0;
            let zoneCount = 0;

            zones.forEach(z => {
                totalLoss += z.loss;
                surfacesByTemp[z.heating] += z.area;
                sumHeights += z.height;
                zoneCount++;
                if (z.ambient > maxAmbientZone) maxAmbientZone = z.ambient;
                if (z.heating > maxHeating) maxHeating = z.heating;
            });

            // Piscine
            if (pool) {
                computePoolLoss();
                if (pool.mode === 'toutesaison') {
                    totalLoss += pool.totalLoss;
                    if (pool.localArea > 0) {
                        surfacesByTemp[pool.localHeating] += pool.localArea;
                        sumHeights += pool.localHeight;
                        zoneCount++;
                        // IMPORTANT : on n'ajoute PAS le local piscine au max ambiance de la note
                        if (pool.localHeating > maxHeating) maxHeating = pool.localHeating;
                    }
                }
            }

            const avgH = zoneCount > 0 ? (sumHeights / zoneCount) : 0;

            document.getElementById('totalLoss').textContent = totalLoss.toFixed(2);
            document.getElementById('avgHeight').textContent = avgH.toFixed(2);
            document.getElementById('maxAmbient').textContent = maxAmbientZone;  // uniquement habitation
            document.getElementById('maxHeating').textContent = maxHeating;

            const list = document.getElementById('surfacesByTemp');
            list.innerHTML = '';
            Object.keys(surfacesByTemp).forEach(temp => {
                if (surfacesByTemp[temp] > 0) {
                    const li = document.createElement('li');
                    li.textContent = `${surfacesByTemp[temp].toFixed(2)} m² à ${temp}°C`;
                    list.appendChild(li);
                }
            });
            document.getElementById('projectSummary').classList.remove('hidden');
        }

        function onTechnologyChange() {
            const tech = document.getElementById('technologySelect').value;
            document.getElementById('geoOptions').classList.add('hidden');
            document.getElementById('airEauOptions').classList.add('hidden');
            document.getElementById('airExtrOptions').classList.add('hidden');
            document.getElementById('techSummary').classList.add('hidden');

            const vmcBlock = document.getElementById('vmcGuide');
            if (vmcBlock) {
                vmcBlock.classList.add('hidden');
            }

            if (tech === 'geothermie') {
                document.getElementById('geoOptions').classList.remove('hidden');
                loadGeoModels();
                geoManuallySelected = false;
                selectDefaultModel('geothermie');
            } else if (tech === 'aireau') {
                document.getElementById('airEauOptions').classList.remove('hidden');
                loadAirEauModels();
                airEauManuallySelected = false;
                selectDefaultModel('aireau');
            } else if (tech === 'airextr') {
                document.getElementById('airExtrOptions').classList.remove('hidden');
                loadAirExtrModels();
                selectDefaultModel('airextr');
                if (vmcBlock) {
                    vmcBlock.classList.remove('hidden');
                }
            }

            if (tech) {
                computeTechnology();
            }
        }

        function loadGeoModels() {
            const select = document.getElementById('geoModel');
            select.innerHTML = '';
            const typeVal = document.getElementById('geoType').value;
            const list = [];
            if (typeVal === '0' || typeVal === '5') {
                list.push(
                    'F1253-4','F1153-4','F1253-6','F1153-6',
                    'S1256-8','S1156-8','S1256-13','S1156-13','S1256-18','S1156-18',
                    'S1155-25',
                    'F1345-24','F1345-30','F1345-40','F1345-60','F1355-28','F1355-43'
                );
            } else if (typeVal === '10') {
                list.push(
                    'F1253-4','F1153-4','F1253-6','F1153-6',
                    'S1256-8','S1156-8','S1256-13','S1156-13','S1256-18','S1156-18',
                    'S1155-25',
                    'F1345-24','F1345-30','F1345-40','F1345-60','F1355-28','F1355-43','F1353-4'
                );
            }
            list.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                select.appendChild(opt);
            });

            // Par défaut, sélectionner la gamme S1256 (si disponible)
            if (!geoManuallySelected) {
                const preferred = Array.from(select.options).find(o => o.value.startsWith('S1256'));
                if (preferred) {
                    select.value = preferred.value;
                }
            }
        }

        document.getElementById('geoType').addEventListener('change', function(){
            loadGeoModels();
            selectDefaultModel('geothermie', false);
            computeTechnology();
        });

        function loadAirEauModels() {
            const select = document.getElementById('airEauModel');
            select.innerHTML = '';
            const heatingMax = getMaxHeating();
            const allowedModels = [];
            const allowHigh = heatingMax < 65;
            ['S2125-8','S2125-12','S2125-16','S2125-20','F2050-6','F2050-10','F2050-12','F2050-16','AMS 20-6','AMS 20-10'].forEach(m => {
                if (!allowHigh && (m.startsWith('F2050') || m.startsWith('AMS'))) {
                    return;
                }
                if (airEauData[m]) allowedModels.push(m);
            });
            allowedModels.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                select.appendChild(opt);
            });

            // Par défaut, sélectionner la gamme S2125 (si disponible)
            if (!airEauManuallySelected) {
                const preferred = Array.from(select.options).find(o => o.value.startsWith('S2125'));
                if (preferred) {
                    select.value = preferred.value;
                }
            }
        }

        function loadAirExtrModels() {
            const select = document.getElementById('airExtrModel');
            select.innerHTML = '';
            const heatingMax = getMaxHeating();
            if (heatingMax >= 65) {
                alert("La technologie Air Extrait n'est pas disponible pour une température de fonctionnement de 65°C.");
                document.getElementById('technologySelect').value = '';
                return;
            }
            ['S735-4','S735-7','S735-7C'].forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                select.appendChild(opt);
            });
            select.addEventListener('change', function(){ loadAirExtrFlows(); });
            loadAirExtrFlows();
        }

        function loadAirExtrFlows() {
            const model = document.getElementById('airExtrModel').value;
            const flowSelect = document.getElementById('airExtrFlow');
            flowSelect.innerHTML = '';
            if (!model) return;
            const flows = Object.keys(airExtractData[model]).map(f => parseFloat(f)).sort((a,b) => a - b);
            flows.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.toString();
                opt.textContent = f.toString();
                flowSelect.appendChild(opt);
            });
            const totalVolume = zones.reduce((sum, z) => sum + (parseFloat(z.area) || 0) * (parseFloat(z.height) || 0), 0);
            const targetFlow = totalVolume * 0.5;
            let defaultFlow = flows[0];
            for (let i = 0; i < flows.length; i++) {
                if (flows[i] >= targetFlow) {
                    defaultFlow = flows[i];
                    break;
                }
            }
            flowSelect.value = defaultFlow.toString();
            airExtrFlowManuallySelected = false;
            computeTechnology();
        }

        function computeTechnology() {
            const tech = document.getElementById('technologySelect').value;
            if (!tech) return;
            updateProjectSummary();
            const totalLoss = parseFloat(document.getElementById('totalLoss').textContent) || 0;
            let capacity = 0;
            let etas35 = 0;
            let etas55 = 0;
            let units = 1;
            let selectedModelName = '';

            const heatingMax = getMaxHeating();
            const heatingKey = (heatingMax >= 65) ? '55' : (heatingMax >= 55 ? '55' : (heatingMax >= 45 ? '45' : '35'));
            let extraInfo = null;

            if (tech === 'geothermie') {
                const typeVal = document.getElementById('geoType').value;
                let model = document.getElementById('geoModel').value;
                selectedModelName = model;
                units = parseInt(document.getElementById('geoUnits').value);
                let key = model;
                if (typeVal === '10' && !model.includes('-10') && model !== 'F1353-4') {
                    key += '-10';
                }
                const data = geoData[key];
                if (data) {
                    let tempKey = typeVal;
                    if (!data[tempKey]) {
                        tempKey = Object.keys(data)[0];
                    }
                    const hTemps = data[tempKey];
                    capacity = hTemps[heatingKey] || 0;
                }
                capacity *= units;
                if (etasMap[key]) {
                    etas35 = etasMap[key]['35'];
                    etas55 = etasMap[key]['55'];
                } else if (etasMap[model]) {
                    etas35 = etasMap[model]['35'];
                    etas55 = etasMap[model]['55'];
                }
                const baseModel = model.split('-')[0];
                if (units === 1 && (baseModel.startsWith('F1153') || baseModel.startsWith('F1253') || model.startsWith('S1156-8') || model.startsWith('S1256-8'))) {
                    if (capacity > totalLoss) {
                        capacity = totalLoss;
                    }
                }
                if (typeVal === '0' || typeVal === '5') {
                    let lengthVal = totalLoss * 1000 * 0.014;
                    if (lengthVal < 50) lengthVal = 50;

                    // *** AJOUT : piscine estivale → longueur de sondes + 1 m par m³ de bassin ***
                    if (pool && pool.mode === 'estivale' && pool.basinLength > 0 && pool.basinWidth > 0 && pool.basinDepth > 0) {
                        const volumeBassin = pool.basinLength * pool.basinWidth * pool.basinDepth; // m³
                        lengthVal += volumeBassin;
                    }

                    extraInfo = { type: 'sonde', value: lengthVal.toFixed(0) + ' m' };
                } else if (typeVal === '10') {
                    const unitsValGeo = units || 1;
                    if (aquathermFlowMap[model] !== undefined) {
                        const baseFlow = aquathermFlowMap[model];
                        const totalFlow = baseFlow * unitsValGeo;
                        const isTotal = unitsValGeo > 1;
                        extraInfo = { type: 'flow', base: baseFlow.toFixed(1), total: totalFlow.toFixed(1), units: unitsValGeo, isTotal: isTotal };
                    }
                }
            }

            if (tech === 'aireau') {
                const model = document.getElementById('airEauModel').value;
                selectedModelName = model;
                units = parseInt(document.getElementById('airEauUnits').value);
                const dataArr = airEauData[model];
                const ext = finalBaseTemp;
                let entry = null;
                if (dataArr) {
                    entry = dataArr.find(e => e.ext === ext);
                    if (!entry) {
                        dataArr.sort((a,b) => b.ext - a.ext);
                        for (let i=0;i<dataArr.length;i++) {
                            if (dataArr[i].ext <= ext) {
                                entry = dataArr[i];
                                break;
                            }
                        }
                        if (!entry) entry = dataArr[dataArr.length-1];
                    }
                    capacity = entry[heatingKey] || 0;
                }
                capacity *= units;
                if (etasMap[model]) {
                    etas35 = etasMap[model]['35'];
                    etas55 = etasMap[model]['55'];
                }
            }

            if (tech === 'airextr') {
                const model = document.getElementById('airExtrModel').value;
                selectedModelName = model;
                let flow = document.getElementById('airExtrFlow').value;
                const data = airExtractData[model];
                if (!airExtrFlowManuallySelected) {
                    const flowsSorted = Object.keys(data).map(f => parseFloat(f)).sort((a,b) => a - b);
                    const totalVolume = zones.reduce((sum,z) => sum + (parseFloat(z.area) || 0) * (parseFloat(z.height) || 0), 0);
                    const targetFlow = totalVolume * 0.5;
                    let bestFlow = flowsSorted[0];
                    for (let i=0; i<flowsSorted.length; i++) {
                        if (flowsSorted[i] >= targetFlow) {
                            bestFlow = flowsSorted[i];
                            break;
                        }
                    }
                    flow = bestFlow.toString();
                    document.getElementById('airExtrFlow').value = flow;
                }
                if (data && data[flow]) {
                    capacity = data[flow][heatingKey] || 0;
                }
                units = 1;
                if (etasMap[model]) {
                    etas35 = etasMap[model]['35'];
                    etas55 = etasMap[model]['55'];
                }
                const renewalDiv = document.getElementById('renewalInfo');
                if (renewalDiv) {
                    const totalVolume = zones.reduce((sum,z) => sum + (parseFloat(z.area) || 0) * (parseFloat(z.height) || 0), 0);
                    const flowVal = parseFloat(flow);
                    let renewal = 0;
                    if (totalVolume > 0) {
                        renewal = flowVal / totalVolume;
                    }
                    let colour = '';
                    if (renewal < 0.30) {
                        colour = 'red';
                    } else if (renewal < 0.55) {
                        colour = 'green';
                    } else if (renewal < 0.70) {
                        colour = 'orange';
                    } else {
                        colour = 'red';
                    }
                    renewalDiv.innerHTML = '<strong>Renouvellement d\'air</strong><br><span style="color:' + colour + ';">' + renewal.toFixed(2) + ' volume/heure</span>';
                    renewalDiv.classList.remove('hidden');
                }
            }

            // Restrictions pour 65°C
            if (tech === 'aireau') {
                const heatingMaxForCheck = getMaxHeating();
                const currentModel = document.getElementById('airEauModel').value || '';
                const isDisallowed = currentModel.startsWith('F2050') || currentModel.startsWith('AMS');
                if (heatingMaxForCheck >= 65 && isDisallowed) {
                    if (!window._disallowGuard) {
                        window._disallowGuard = true;
                        airEauManuallySelected = false;
                        loadAirEauModels();
                        selectDefaultModel('aireau');
                        window._disallowGuard = false;
                        return;
                    }
                }
            }
            if (tech === 'airextr') {
                const heatingMaxCheck = getMaxHeating();
                if (heatingMaxCheck >= 65) {
                    if (!window._disallowGuard) {
                        window._disallowGuard = true;
                        alert("La technologie Air Extrait n'est pas disponible pour une température de fonctionnement de 65°C.");
                        document.getElementById('technologySelect').value = '';
                        document.getElementById('airExtrOptions').classList.add('hidden');
                        document.getElementById('techSummary').classList.add('hidden');
                        const vmcBlock = document.getElementById('vmcGuide');
                        if (vmcBlock) vmcBlock.classList.add('hidden');
                        window._disallowGuard = false;
                        return;
                    }
                }
            }

            const ratio = totalLoss > 0 ? (capacity / totalLoss * 100) : 0;
            let backup = totalLoss - capacity;
            if (backup < 0) backup = 0;
            document.getElementById('summaryLoss').textContent = totalLoss.toFixed(2);
            document.getElementById('pacPower').textContent = capacity.toFixed(2);
            const ratioSpan = document.getElementById('powerRatio');
            ratioSpan.textContent = ratio.toFixed(1);
            let ratioColour = '';
            if (ratio < 60) {
                ratioColour = 'red';
            } else if (ratio < 70) {
                ratioColour = 'orange';
            } else if (ratio <= 120) {
                ratioColour = 'green';
            } else {
                ratioColour = 'orange';
            }
            ratioSpan.style.color = ratioColour;
            document.getElementById('backupPower').textContent = backup.toFixed(2);
            document.getElementById('techSummary').classList.remove('hidden');

            if (!window._autoSelectGuard) {
                let minRatio = 0;
                let maxRatio = Infinity;
                if (tech === 'aireau') {
                    minRatio = 0.65;
                    maxRatio = 0.75;
                } else if (tech === 'geothermie') {
                    minRatio = 0.70;
                    maxRatio = 0.90;
                }
                if (tech === 'geothermie' || tech === 'aireau') {
                    const withinLower = ratio >= minRatio * 100;
                    const withinUpper = ratio <= maxRatio * 100;
                    const userManuallySelected = (tech === 'geothermie' && geoManuallySelected) || (tech === 'aireau' && airEauManuallySelected);
                    if (!userManuallySelected && (!withinLower || !withinUpper)) {
                        window._autoSelectGuard = true;
                        selectDefaultModel(tech, false);
                        computeTechnology();
                        window._autoSelectGuard = false;
                        return;
                    }
                }
            }

            const extraDiv = document.getElementById('extraInfo');
            if (extraDiv) {
                if (extraInfo) {
                    if (extraInfo.type === 'sonde') {
                        extraDiv.innerHTML = '<strong>Longueur de sondes géothermiques estimée :</strong> ' + extraInfo.value;
                    } else if (extraInfo.type === 'flow') {
                        if (extraInfo.isTotal) {
                            extraDiv.innerHTML = '<strong>Débit total d\u2019eau de nappe :</strong> ' + extraInfo.total + ' m³/h';
                        } else {
                            extraDiv.innerHTML = '<strong>Débit d\u2019eau de nappe :</strong> ' + extraInfo.base + ' m³/h';
                        }
                    }
                    extraDiv.classList.remove('hidden');
                } else {
                    extraDiv.innerHTML = '';
                    extraDiv.classList.add('hidden');
                }
            }
            if (tech !== 'airextr') {
                const renewalDiv = document.getElementById('renewalInfo');
                if (renewalDiv) {
                    renewalDiv.innerHTML = '';
                    renewalDiv.classList.add('hidden');
                }
            }

            finalPac = {
                tech: tech,
                model: selectedModelName,
                capacity: capacity,
                ratio: ratio,
                backup: backup,
                etas35: etas35,
                etas55: etas55,
                units: units,
                limited: (capacity === totalLoss && totalLoss > 0),
                extra: extraInfo
            };
        }

        function getAirEauCapacity(dataArr, ext, heatingKey) {
            if (!dataArr || dataArr.length === 0) return 0;
            let entry = dataArr.find(e => e.ext === ext);
            if (!entry) {
                const sorted = dataArr.slice().sort((a,b) => b.ext - a.ext);
                for (let i=0; i<sorted.length; i++) {
                    if (sorted[i].ext <= ext) {
                        entry = sorted[i];
                        break;
                    }
                }
                if (!entry) {
                    entry = sorted[sorted.length - 1];
                }
            }
            return entry[heatingKey] || 0;
        }

        function selectDefaultModel(tech, overrideType = true) {
            updateProjectSummary();
            const totalLoss = parseFloat(document.getElementById('totalLoss').textContent) || 0;
            if (!(totalLoss > 0)) {
                return;
            }
            if (finalBaseTemp === null) {
                computeBaseTemp();
            }
            const heatingMax = getMaxHeating();
            const heatingKey = (heatingMax >= 65) ? '55' : (heatingMax >= 55 ? '55' : (heatingMax >= 45 ? '45' : '35'));

            const getRatioBounds = (tech) => {
                if (tech === 'aireau') {
                    return { min: 0.65, max: 0.75, limit: 9 };
                }
                return { min: 0.70, max: 0.90, limit: 8 };
            };

            if (tech === 'geothermie') {
                const geoTypeElem = document.getElementById('geoType');
                if (overrideType) {
                    geoTypeElem.value = '5';
                }
                loadGeoModels();
                const typeVal = document.getElementById('geoType').value;
                const modelSelect = document.getElementById('geoModel');
                const models = Array.from(modelSelect.options).map(o => o.value);
                if (models.length === 0) return;
                const caps = {};
                models.forEach((m) => {
                    let key = m;
                    if (typeVal === '10' && !m.includes('-10') && m !== 'F1353-4') {
                        key = m + '-10';
                    }
                    const data = geoData[key];
                    if (!data) return;
                    let tempKey = typeVal;
                    if (!data[tempKey]) {
                        const keys = Object.keys(data);
                        if (keys.length > 0) tempKey = keys[0];
                    }
                    const hTemps = data[tempKey];
                    const cap = (hTemps && hTemps[heatingKey]) ? hTemps[heatingKey] : 0;
                    caps[m] = cap;
                });
                const bounds = getRatioBounds('geothermie');
                const minRatio = bounds.min;
                const maxRatio = bounds.max;
                const maxUnits = bounds.limit;
                let chosenModel = null;
                let chosenUnits = 1;

                outerGeoLoop:
                for (let n = 1; n <= maxUnits; n++) {
                    const within = [];
                    const overs = [];
                    models.forEach((m, idx) => {
                        const cap = caps[m] || 0;
                        const ratio = (cap * n) / totalLoss;
                        if (ratio >= minRatio) {
                            if (ratio <= maxRatio) {
                                within.push({ model: m, units: n, ratio: ratio, index: idx });
                            } else {
                                overs.push({ model: m, units: n, ratio: ratio, index: idx });
                            }
                        }
                    });
                    if (within.length > 0) {
                        within.sort((a, b) => {
                            if (a.ratio !== b.ratio) return a.ratio - b.ratio;
                            return a.index - b.index;
                        });
                        chosenModel = within[0].model;
                        chosenUnits = within[0].units;
                        break outerGeoLoop;
                    }
                    if (overs.length > 0) {
                        overs.sort((a, b) => {
                            const diffA = a.ratio - maxRatio;
                            const diffB = b.ratio - maxRatio;
                            if (diffA !== diffB) return diffA - diffB;
                            if (a.ratio !== b.ratio) return a.ratio - b.ratio;
                            return a.index - b.index;
                        });
                        chosenModel = overs[0].model;
                        chosenUnits = overs[0].units;
                        break outerGeoLoop;
                    }
                }
                if (!chosenModel) {
                    let best = null;
                    models.forEach((m, idx) => {
                        const cap = caps[m] || 0;
                        for (let n = 1; n <= maxUnits; n++) {
                            const ratio = (cap * n) / totalLoss;
                            if (!best || ratio > best.ratio || (ratio === best.ratio && n < best.units)) {
                                best = { model: m, units: n, ratio: ratio, index: idx };
                            }
                        }
                    });
                    if (best) {
                        chosenModel = best.model;
                        chosenUnits = best.units;
                    }
                }

                // Priorité à la gamme S1256 (si disponible et cohérente avec le dimensionnement)
                if (!geoManuallySelected) {
                    const modelIndexMap = {};
                    models.forEach((m, i) => { modelIndexMap[m] = i; });
                    const preferredModels = models.filter(m => m.startsWith('S1256'));
                    if (preferredModels.length > 0) {
                        const withinPref = [];
                        const oversPref = [];
                        preferredModels.forEach((m) => {
                            const cap = caps[m] || 0;
                            for (let n = 1; n <= maxUnits; n++) {
                                const ratio = (cap * n) / totalLoss;
                                if (ratio >= minRatio) {
                                    if (ratio <= maxRatio) {
                                        withinPref.push({ model: m, units: n, ratio: ratio, index: modelIndexMap[m] });
                                    } else {
                                        oversPref.push({ model: m, units: n, ratio: ratio, index: modelIndexMap[m] });
                                    }
                                }
                            }
                        });
                        if (withinPref.length > 0) {
                            withinPref.sort((a,b) => {
                                if (a.ratio !== b.ratio) return a.ratio - b.ratio;
                                return a.index - b.index;
                            });
                            chosenModel = withinPref[0].model;
                            chosenUnits = withinPref[0].units;
                        } else if (oversPref.length > 0) {
                            oversPref.sort((a,b) => {
                                const diffA = a.ratio - maxRatio;
                                const diffB = b.ratio - maxRatio;
                                if (diffA !== diffB) return diffA - diffB;
                                if (a.ratio !== b.ratio) return a.ratio - b.ratio;
                                return a.index - b.index;
                            });
                            chosenModel = oversPref[0].model;
                            chosenUnits = oversPref[0].units;
                        }
                    }
                }

                if (chosenModel && !geoManuallySelected) {
                    modelSelect.value = chosenModel;
                    document.getElementById('geoUnits').value = chosenUnits.toString();
                }

            } else if (tech === 'aireau') {
                const modelSelect = document.getElementById('airEauModel');
                const models = Array.from(modelSelect.options).map(o => o.value);
                if (models.length === 0) return;
                const caps = {};
                models.forEach(m => {
                    const dataArr = airEauData[m];
                    if (!dataArr) return;
                    const cap = getAirEauCapacity(dataArr, finalBaseTemp, heatingKey);
                    caps[m] = cap;
                });
                const bounds = getRatioBounds('aireau');
                const minRatio = bounds.min;
                const maxRatio = bounds.max;
                const maxUnits = bounds.limit;
                let chosenModel = null;
                let chosenUnits = 1;

                outerAirLoop:
                for (let n = 1; n <= maxUnits; n++) {
                    const within = [];
                    const overs = [];
                    models.forEach((m, idx) => {
                        const cap = caps[m] || 0;
                        const ratio = (cap * n) / totalLoss;
                        if (ratio >= minRatio) {
                            if (ratio <= maxRatio) {
                                within.push({ model: m, units: n, ratio: ratio, index: idx });
                            } else {
                                overs.push({ model: m, units: n, ratio: ratio, index: idx });
                            }
                        }
                    });
                    if (within.length > 0) {
                        within.sort((a,b) => {
                            if (a.ratio !== b.ratio) return a.ratio - b.ratio;
                            return a.index - b.index;
                        });
                        chosenModel = within[0].model;
                        chosenUnits = within[0].units;
                        break outerAirLoop;
                    }
                    if (overs.length > 0) {
                        overs.sort((a,b) => {
                            const diffA = a.ratio - maxRatio;
                            const diffB = b.ratio - maxRatio;
                            if (diffA !== diffB) return diffA - diffB;
                            if (a.ratio !== b.ratio) return a.ratio - b.ratio;
                            return a.index - b.index;
                        });
                        chosenModel = overs[0].model;
                        chosenUnits = overs[0].units;
                        break outerAirLoop;
                    }
                }
                if (!chosenModel) {
                    let best = null;
                    models.forEach((m, idx) => {
                        const cap = caps[m] || 0;
                        for (let n = 1; n <= maxUnits; n++) {
                            const ratio = (cap * n) / totalLoss;
                            if (!best || ratio > best.ratio || (ratio === best.ratio && n < best.units)) {
                                best = { model: m, units: n, ratio: ratio, index: idx };
                            }
                        }
                    });
                    if (best) {
                        chosenModel = best.model;
                        chosenUnits = best.units;
                    }
                }

                // Priorité à la gamme S2125 (si disponible et cohérente avec le dimensionnement)
                if (!airEauManuallySelected) {
                    const modelIndexMap = {};
                    models.forEach((m, i) => { modelIndexMap[m] = i; });
                    const preferredModels = models.filter(m => m.startsWith('S2125'));
                    if (preferredModels.length > 0) {
                        const withinPref = [];
                        const oversPref = [];
                        preferredModels.forEach((m) => {
                            const cap = caps[m] || 0;
                            for (let n = 1; n <= maxUnits; n++) {
                                const ratio = (cap * n) / totalLoss;
                                if (ratio >= minRatio) {
                                    if (ratio <= maxRatio) {
                                        withinPref.push({ model: m, units: n, ratio: ratio, index: modelIndexMap[m] });
                                    } else {
                                        oversPref.push({ model: m, units: n, ratio: ratio, index: modelIndexMap[m] });
                                    }
                                }
                            }
                        });
                        if (withinPref.length > 0) {
                            withinPref.sort((a,b) => {
                                if (a.ratio !== b.ratio) return a.ratio - b.ratio;
                                return a.index - b.index;
                            });
                            chosenModel = withinPref[0].model;
                            chosenUnits = withinPref[0].units;
                        } else if (oversPref.length > 0) {
                            oversPref.sort((a,b) => {
                                const diffA = a.ratio - maxRatio;
                                const diffB = b.ratio - maxRatio;
                                if (diffA !== diffB) return diffA - diffB;
                                if (a.ratio !== b.ratio) return a.ratio - b.ratio;
                                return a.index - b.index;
                            });
                            chosenModel = oversPref[0].model;
                            chosenUnits = oversPref[0].units;
                        }
                    }
                }

                if (chosenModel && !airEauManuallySelected) {
                    modelSelect.value = chosenModel;
                    document.getElementById('airEauUnits').value = chosenUnits.toString();
                }

            } else if (tech === 'airextr') {
                const modelSelect = document.getElementById('airExtrModel');
                const models = Array.from(modelSelect.options).map(o => o.value);
                let chosenModel = null;
                let minDiff = Infinity;
                const totalVolume = zones.reduce((sum,z) => sum + (parseFloat(z.area) || 0) * (parseFloat(z.height) || 0), 0);
                const targetFlow = totalVolume * 0.5;
                models.forEach(m => {
                    const flows = Object.keys(airExtractData[m] || {}).map(f => parseFloat(f)).sort((a,b) => a - b);
                    if (flows.length === 0) return;
                    let defaultFlow = flows[0];
                    for (let i = 0; i < flows.length; i++) {
                        if (flows[i] >= targetFlow) {
                            defaultFlow = flows[i];
                            break;
                        }
                    }
                    const data = airExtractData[m];
                    const flowStr = defaultFlow.toString();
                    const capObj = (data && data[flowStr]) ? data[flowStr] : null;
                    let cap = 0;
                    if (capObj && capObj[heatingKey] !== undefined) {
                        cap = capObj[heatingKey];
                    }
                    const diff = Math.abs(cap - totalLoss);
                    if (diff < minDiff) {
                        minDiff = diff;
                        chosenModel = m;
                    }
                });
                if (!chosenModel && models.length > 0) {
                    chosenModel = models[0];
                }
                if (chosenModel) {
                    modelSelect.value = chosenModel;
                    loadAirExtrFlows();
                }
            }
        }

        function buildFinalReport() {
            const reportDiv = document.getElementById('finalReport');
            reportDiv.innerHTML = '';
            const companyName = document.getElementById('companyName').value;
            const companyAddress = document.getElementById('companyAddress').value;
            const companySiret = document.getElementById('companySiret').value;
            const benefFN = document.getElementById('beneficiaryFirstName').value;
            const benefLN = document.getElementById('beneficiaryLastName').value;
            const benefAddr = document.getElementById('beneficiaryAddress').value;
            const benefPC = document.getElementById('beneficiaryPostalCode').value;
            const benefCity = document.getElementById('beneficiaryCity').value;
            const year = document.getElementById('constructionYear').value;
            const surfacesLines = Array.from(document.getElementById('surfacesByTemp').children).map(li => li.textContent);
            const avgHeight = document.getElementById('avgHeight').textContent;
            const maxAmbient = document.getElementById('maxAmbient').textContent;
            const maxHeating = document.getElementById('maxHeating').textContent;
            const totalLoss = document.getElementById('totalLoss').textContent;
            if (pool) computePoolLoss();
            const pac = finalPac || {tech:'',model:'',capacity:0,ratio:0,backup:0,etas35:0,etas55:0,units:1};

            const logoUrl = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQQRLnUEoNR2GdiXhoMIgRc6NZN_8JHSGA2DQ&s';
            let html = '';
            html += `<div class="report-header" style="display:flex; align-items:center; justify-content:space-between;">
                        <img src="${logoUrl}" alt="logo" style="height:20px; max-width:80px; width:auto;">
                        <div style="flex:1; text-align:center; font-weight:bold; font-size:20px;">NOTE DE DIMENSIONNEMENT</div>
                    </div>`;
            html += `<div class="print-spacer"></div>`;
            html += `<table>
                        <tr><th colspan="2" style="color:#0B3D91; font-weight:bold; text-transform:uppercase;">Installateur</th></tr>
                        <tr><td>Entreprise</td><td>${companyName}</td></tr>
                        <tr><td>Adresse</td><td>${companyAddress}</td></tr>
                        <tr><td>SIRET</td><td>${companySiret}</td></tr>
                    </table>`;
            html += `<table>
                        <tr><th colspan="2" style="color:#0B3D91; font-weight:bold; text-transform:uppercase;">Bénéficiaire</th></tr>
                        <tr><td>Nom</td><td>${benefFN} ${benefLN}</td></tr>
                        <tr><td>Adresse</td><td>${benefAddr}, ${benefPC} ${benefCity}</td></tr>
                        <tr><td>Année de construction</td><td>${year}</td></tr>
                    </table>`;
            html += `<table>
                        <tr><th colspan="2" style="color:#0B3D91; font-weight:bold; text-transform:uppercase;">Données de base</th></tr>
                        <tr><td>Température extérieure de base</td><td>${finalBaseTemp} °C</td></tr>
                        <tr><td>Surface chauffée</td><td>${surfacesLines.join('<br>')}</td></tr>
                        <tr><td>Hauteur sous plafond moyenne</td><td>${avgHeight} m</td></tr>
                        <tr><td>Température ambiante</td><td>${maxAmbient} °C</td></tr>
                        <tr><td>Température de fonctionnement maximale</td><td>${maxHeating} °C${(parseInt(maxHeating)>=65?' (Haute température)':'')}</td></tr>
                        <tr><td style="font-weight:bold;">Déperditions calculées</td><td style="font-weight:bold;">${totalLoss} kW</td></tr>
                    </table>`;

            const techSelect = document.getElementById('technologySelect').value;
            let pacDesc = '';
            if (techSelect === 'geothermie') {
                const typeVal = document.getElementById('geoType').value;
                const model = document.getElementById('geoModel').value;
                const unitsVal = document.getElementById('geoUnits').value;
                pacDesc = `${model} (${unitsVal} unité${unitsVal>1?'s':''}) (${typeVal}°C)`;
            } else if (techSelect === 'aireau') {
                const model = document.getElementById('airEauModel').value;
                const unitsVal = document.getElementById('airEauUnits').value;
                pacDesc = `${model} (${unitsVal} unité${unitsVal>1?'s':''})`;
            } else if (techSelect === 'airextr') {
                const model = document.getElementById('airExtrModel').value;
                const flow = document.getElementById('airExtrFlow').value;
                pacDesc = `${model} (débit ${flow} m³/h)`;
            }

            let selectedModelName = '';
            if (finalPac && finalPac.model) {
                selectedModelName = finalPac.model;
            } else {
                if (techSelect === 'geothermie') {
                    selectedModelName = document.getElementById('geoModel').value;
                } else if (techSelect === 'aireau') {
                    selectedModelName = document.getElementById('airEauModel').value;
                } else if (techSelect === 'airextr') {
                    selectedModelName = document.getElementById('airExtrModel').value;
                }
            }

            let regulatorClass = '';
            const modelUpper = selectedModelName ? selectedModelName.toUpperCase() : '';
            const sSeriesPrefixes = ['S1156', 'S1155', 'S1256', 'S2125', 'S735'];
            const isSeriesS = sSeriesPrefixes.some(prefix => modelUpper.startsWith(prefix)) || modelUpper.startsWith('F2050');
            const isSeriesF = modelUpper.startsWith('F1153') || modelUpper.startsWith('F1253') || modelUpper.startsWith('F1345') || modelUpper.startsWith('F1355') || modelUpper.startsWith('AMS');
            if (isSeriesS) {
                regulatorClass = 'NIBE Série S / Classe VI – inclus sonde d’ambiance RTS 40';
            } else if (isSeriesF) {
                regulatorClass = 'NIBE Série F / Classe VI – inclus sonde d’ambiance RTS 40';
            }

            html += `<table>
                        <tr><th colspan="2" style="color:#0B3D91; font-weight:bold; text-transform:uppercase;">Pompe à chaleur</th></tr>
                        <tr><td><strong style="color:#d62728;">Modèle choisi</strong></td><td><strong style="color:#d62728;">${pacDesc}</strong></td></tr>
                        <tr><td style="font-weight:bold;">Puissance PAC à ${finalBaseTemp}&nbsp;°C</td><td style="font-weight:bold;">${pac.capacity.toFixed(2)} kW</td></tr>
                        <tr><td>Puissance/Déperditions</td><td>
                            ${(() => {
                                const r = pac.ratio;
                                let colour = '';
                                if (r < 60) {
                                    colour = 'red';
                                } else if (r < 70) {
                                    colour = 'orange';
                                } else if (r <= 120) {
                                    colour = 'green';
                                } else {
                                    colour = 'orange';
                                }
                                return `<span style="color:${colour}; font-weight:bold;">${r.toFixed(1)}&nbsp;%</span>`;
                            })()}
                        </td></tr>
                        <tr><td>Puissance d'appoint recommandée</td><td>${pac.backup.toFixed(2)} kW</td></tr>
                        <tr><td>Modèle et classe du régulateur</td><td>${regulatorClass}</td></tr>
                        ${pac.extra && pac.extra.type === 'sonde' ? `<tr><td>Longueur de sondes géothermiques estimée</td><td>${pac.extra.value}</td></tr>` : ''}
                        ${pac.extra && pac.extra.type === 'flow' ? `<tr><td>${pac.extra.isTotal ? 'Débit total d\u2019eau de nappe' : 'Débit d\u2019eau de nappe'}</td><td>${pac.extra.isTotal ? pac.extra.total : pac.extra.base} m³/h</td></tr>` : ''}
                        <tr><td style="color:#006400; font-weight:bold;"><strong>ETAS (PAC) 35°C</strong></td><td style="color:#006400; font-weight:bold;"><strong>${(pac.etas35 - 4)} %</strong></td></tr>
                        <tr><td style="color:#006400; font-weight:bold;"><strong>ETAS (PAC) 55°C</strong></td><td style="color:#006400; font-weight:bold;"><strong>${(pac.etas55 - 4)} %</strong></td></tr>
                        <tr><td>60% des déperditions</td><td>${(parseFloat(totalLoss)*0.60).toFixed(2)} kW</td></tr>
                        <tr><td>130% des déperditions</td><td>${(parseFloat(totalLoss)*1.30).toFixed(2)} kW</td></tr>
                        <tr><td>Température d'arrêt PAC NIBE</td><td>`;

            let modelName = selectedModelName || '';
            let cutoff = '-25°C';
            if (modelName.startsWith('F2050') || modelName.startsWith('AMS 20')) {
                cutoff = '-20°C';
            }
            html += `${cutoff}</td></tr>`;
            html += `</table>`;

            html += `<p style="font-size:8px;">Les déperditions calculées concernent toutes les pièces du logement desservies par le réseau de chauffage et sans considération d’éventuels autres générateurs.</p>`;
            html += `<p style="font-size:8px;">Les informations et estimations fournies dans cette note de dimensionnement sont données à titre indicatif. Elles sont basées sur les renseignements communiqués et n’ont qu’une valeur approximative. Elles doivent être vérifiées et complétées en consultant les notices des fabricants, la réglementation en vigueur et les régimes de fonctionnement applicables. Un bureau d’étude ou un professionnel qualifié devra confirmer ces données, procéder aux ajustements nécessaires et émettre les réserves d’usage.</p>`;

            reportDiv.innerHTML = html;
            updatePreconisationButtons();
            logUsageIfNeeded();
        }

        // === Guide VMC (débit réglementaire indicatif pour PAC air extrait) ===
        function titreLogementVmc(nb){
            nb = Number(nb) || 0;
            if (nb <= 1) return 'T2';
            if (nb === 2) return 'T3';
            if (nb === 3) return 'T4';
            if (nb === 4) return 'T5';
            if (nb === 5) return 'T6';
            if (nb >= 7) return 'T7+';
            return 'T7';
        }
        function cuisineDefaultsVmc(nb){
            nb = Number(nb) || 0;
            if (nb <= 1) return { mini: 30, grand: 90 };
            if (nb === 2) return { mini: 45, grand: 105 };
            if (nb === 3) return { mini: 45, grand: 120 };
            return { mini: 45, grand: 135 };
        }

        function computeVmcReglementaire(){
            const nbCh = parseInt(document.getElementById('vmcBedrooms').value,10) || 0;
            const nbSdb = parseInt(document.getElementById('vmcBathrooms').value,10) || 0;
            const nbWc = parseInt(document.getElementById('vmcWc').value,10) || 0;
            const nbAut = parseInt(document.getElementById('vmcOther').value,10) || 0;

            if (nbCh <= 0){
                alert("Veuillez saisir au moins 1 chambre.");
                return;
            }

            const typeLogement = titreLogementVmc(nbCh);
            const cuisine = cuisineDefaultsVmc(nbCh);

            const pieces = [];
            for (let i=1;i<=nbSdb;i++){
                pieces.push({ label: `Salle de bain ${i}`, type: 'sdb', flow: 30 });
            }
            for (let i=1;i<=nbWc;i++){
                pieces.push({ label: `WC ${i}`, type: 'wc', flow: 15 });
            }
            for (let i=1;i<=nbAut;i++){
                pieces.push({ label: `Autre pièce d'eau ${i}`, type: 'autre', flow: 15 });
            }

            // Règles WC
            if (nbWc > 0){
                if (typeLogement === 'T2' || typeLogement === 'T3'){
                    pieces.forEach(p => {
                        if (p.type === 'wc') p.flow = 15;
                    });
                } else {
                    if (nbWc === 1){
                        const firstWc = pieces.find(p => p.type === 'wc');
                        if (firstWc) firstWc.flow = 30;
                    } else {
                        pieces.forEach(p => {
                            if (p.type === 'wc') p.flow = 15;
                        });
                    }
                }
            }

            // Règle T2 : si une seule pièce d’eau → 30 m³/h, si 2+ → 15 m³/h chacune
            if (typeLogement === 'T2'){
                const wetPieces = pieces;
                if (wetPieces.length === 1){
                    wetPieces[0].flow = 30;
                } else if (wetPieces.length >= 2){
                    wetPieces.forEach(p => { p.flow = 15; });
                }
            }

            let totalWet = 0;
            pieces.forEach(p => totalWet += p.flow);

            const qMini = cuisine.mini + totalWet;
            const qGrand = cuisine.grand + totalWet;

            const resDiv = document.getElementById('vmcResult');
            let html = '';
            html += `<div class="vmc-result-line"><strong>Type de logement :</strong> ${typeLogement} — OK</div>`;
            pieces.forEach(p => {
                html += `<div class="vmc-result-line">${p.label} : ${p.flow.toFixed(0)} m³/h</div>`;
            });
            html += `<div class="vmc-result-line"><strong>Cuisine (mini / grand) :</strong> ${cuisine.mini} / ${cuisine.grand} m³/h — OK</div>`;
            html += `<div class="vmc-result-line"><strong>Débit extrait réglementaire (mini / grand) :</strong> ${qMini.toFixed(0)} / ${qGrand.toFixed(0)} m³/h — OK</div>`;

            resDiv.innerHTML = html;
            resDiv.classList.remove('hidden');
        }

        
        // === Liens Préconisations (schémas / accessoires) ===
        const preconisationLinksByModel = {
    "F1153-4": { preconisation: "https://drive.google.com/drive/folders/1Aseb0YuBKGghuKNfg97AEJTWLGSy4chg" },
    "F1153-6": { preconisation: "https://drive.google.com/drive/folders/1Aseb0YuBKGghuKNfg97AEJTWLGSy4chg" },
    "F1253-4": { preconisation: "https://drive.google.com/drive/folders/1tuFl6r4w1z0DdJOsH9w1Hl-av1DZIoQ7" },
    "F1253-6": { preconisation: "https://drive.google.com/drive/folders/1tuFl6r4w1z0DdJOsH9w1Hl-av1DZIoQ7" },
    "F2050-10": { preconisation: "https://drive.google.com/drive/folders/1gz2rOn9uOYJlI9G9YNY47CCXI_RjJ8eh" },
    "F2050-12": { preconisation: "https://drive.google.com/drive/folders/1MbD3Wam5Hougg1JVgAFpqL_WaIwr0-sY" },
    "F2050-16": { preconisation: "https://drive.google.com/drive/folders/1Q2eZgbTaIJoq4dM46hwHLQ6y-wxh0YMS" },
    "F2050-6": { preconisation: "https://drive.google.com/drive/folders/1sLAJt9m8tbNjfTzyeJeFjIOgo5umbdNC" },
    "S1155-25": { preconisation: "https://drive.google.com/drive/folders/1VUAVLLUv0ZDa0aqn95EYeZq2esIajsI0" },
    "S1156-13": {
        tri: "https://drive.google.com/drive/folders/1VUAVLLUv0ZDa0aqn95EYeZq2esIajsI0",
        mono: "https://drive.google.com/drive/folders/1Aseb0YuBKGghuKNfg97AEJTWLGSy4chg"
    },
    "S1156-18": { preconisation: "https://drive.google.com/drive/folders/1VUAVLLUv0ZDa0aqn95EYeZq2esIajsI0" },
    "S1156-8": {
        tri: "https://drive.google.com/drive/folders/1VUAVLLUv0ZDa0aqn95EYeZq2esIajsI0",
        mono: "https://drive.google.com/drive/folders/1Aseb0YuBKGghuKNfg97AEJTWLGSy4chg"
    },
    "S1256-13": {
        tri: "https://drive.google.com/drive/folders/1RCNfydd5ZnMR2F7Hy3PgayBUnnUALQJh",
        mono: "https://drive.google.com/drive/folders/1tuFl6r4w1z0DdJOsH9w1Hl-av1DZIoQ7"
    },
    "S1256-18": { preconisation: "https://drive.google.com/drive/folders/1RCNfydd5ZnMR2F7Hy3PgayBUnnUALQJh" },
    "S1256-8": {
        tri: "https://drive.google.com/drive/folders/1RCNfydd5ZnMR2F7Hy3PgayBUnnUALQJh",
        mono: "https://drive.google.com/drive/folders/1tuFl6r4w1z0DdJOsH9w1Hl-av1DZIoQ7"
    },
    "S2125-12": {
        tri: "https://drive.google.com/drive/folders/1asG6cdfYDHdtgfspWX93W8B0hmOsDUXk",
        mono: "https://drive.google.com/drive/folders/1RQ3sI3PGfFLC7nZnasE00EkRKhyNwCvJ"
    },
    "S2125-16": {
        tri: "https://drive.google.com/drive/folders/15e52mIHAeGuyYHPvqLUSO045BBkxNNed",
        mono: "https://drive.google.com/drive/folders/1lQgfoTF5BDT9K20dCrYdBNLYwvqxb1Xi"
    },
    "S2125-20": {
        tri: "https://drive.google.com/drive/folders/1OT-hcWkrWvELXH3a5s-TKtnunXssTR8Y",
        mono: "https://drive.google.com/drive/folders/127lr9e9x0sUdo7hD5Qs-iT0YN5yPedNi"
    },
    "S2125-8": {
        tri: "https://drive.google.com/drive/folders/16BcMX-LTTiSQB0O75TwjzgGscKB5WP6i",
        mono: "https://drive.google.com/drive/folders/1BMwIwIc-aSefbk8v8MZici3Gz7-igK1W"
    },
    "S735-4": { preconisation: "https://drive.google.com/drive/folders/1wMxgVjpUPmGLklVs_e8vs7JGKVg4FqQu" },
    "S735-7": { preconisation: "https://drive.google.com/drive/folders/1ycwyFvtKuk4TJa_NmxF4TjqZzEnS5EPc" }
,"AMS 20-6": { preconisation: "https://drive.google.com/drive/folders/1sLAJt9m8tbNjfTzyeJeFjIOgo5umbdNC" }
,"AMS 20-10": { preconisation: "https://drive.google.com/drive/folders/1gz2rOn9uOYJlI9G9YNY47CCXI_RjJ8eh" }
};

        
        function normalizeModel(raw) {
            if (!raw) return '';
            let m = String(raw).trim();
            // Remplacer tirets longs
            m = m.replace(/[–—]/g, '-');
            // Pour les modèles du type "AMS 20-6", conserver les 2 premiers tokens
            const tokens = m.split(/\s+/);
            if (tokens.length >= 2 && tokens[0].toUpperCase() === 'AMS') {
                m = tokens[0] + ' ' + tokens[1];
            } else {
                // Sinon garder uniquement le 1er token (ex: "S1156-8 kW")
                m = tokens[0];
            }
            // Supprimer espaces autour des tirets
            m = m.replace(/\s*-\s*/g, '-');
            // Normaliser les tailles avec zéro (ex: -08 -> -8)
            m = m.replace(/-(0+)(\d)/g, '-$2');
            return m.toUpperCase();
        }

function updatePreconisationButtons(){
            const container = document.getElementById('preconisationButtons');
            if (!container) return;
            container.innerHTML = '';

            // Affichage uniquement si 1 machine sélectionnée (quantité = 1)
            if (!finalPac || !finalPac.model || (finalPac.units && finalPac.units > 1)) {
                return;
            }

            const model = normalizeModel(finalPac.model);
            let conf = preconisationLinksByModel[model];
            if (!conf) {
                // Tentative sans normalisation (au cas où la clé serait déjà au format exact)
                conf = preconisationLinksByModel[finalPac.model];
            }
            if (!conf) return;

            const makeBtn = (label, url) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                // Même style que les boutons de la page note (Précédent / Imprimer)
                btn.style.padding = '8px 16px';
                btn.style.margin = '0 10px 10px 0';
                btn.style.background = '#007bff';
                btn.style.color = '#fff';
                btn.style.border = 'none';
                btn.style.borderRadius = '4px';
                btn.style.cursor = 'pointer';
                btn.textContent = label;
                btn.onclick = () => window.open(url, '_blank');
                container.appendChild(btn);
            };

            if (conf.mono && conf.tri) {
                makeBtn('Préconisation monophasé', conf.mono);
                makeBtn('Préconisation triphasé', conf.tri);
            } else if (conf.preconisation) {
                makeBtn('Préconisation', conf.preconisation);
            } else if (conf.mono) {
                makeBtn('Préconisation monophasé', conf.mono);
            } else if (conf.tri) {
                makeBtn('Préconisation triphasé', conf.tri);
            }
        }


        // === Tracking utilisation (envoi vers Google Sheet via Apps Script WebApp) ===
        // ⚠️ Pour écrire dans un Google Sheet depuis une page web statique, il faut un endpoint (Apps Script).
        // Renseigner l'URL du WebApp ci-dessous une fois déployé.
        const GOOGLE_SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxayZrAajz96sTzw_QXUfscx5_qV9IxTYVdbLOfuZwJrbRwDM54QP4p17GfZgtTJY6i/exec"; // ex: https://script.google.com/macros/s/XXXX/exec
        const GOOGLE_SHEET_SHARED_SECRET = "Lapienichehaut35";
        let usageLogged = false;

        function buildUsagePayload() {
            const payload = {
                _secret: GOOGLE_SHEET_SHARED_SECRET,
                timestamp: new Date().toISOString(),
                pageUrl: window.location.href,
                referrer: document.referrer || "",
                userAgent: navigator.userAgent || "",
                // Installateur (entreprise)
                installateur_nom: (document.getElementById('companyName')?.value || "").trim(),
                installateur_adresse: (document.getElementById('companyAddress')?.value || "").trim(),
                installateur_siret: (document.getElementById('companySiret')?.value || "").trim(),
                // Bénéficiaire
                beneficiaire_prenom: (document.getElementById('beneficiaryFirstName')?.value || "").trim(),
                beneficiaire_nom: (document.getElementById('beneficiaryLastName')?.value || "").trim(),
                beneficiaire_adresse: (document.getElementById('beneficiaryAddress')?.value || "").trim(),
                beneficiaire_cp: (document.getElementById('beneficiaryPostalCode')?.value || "").trim(),
                beneficiaire_ville: (document.getElementById('beneficiaryCity')?.value || "").trim(),
                // Projet
                modele_choisi: finalPac?.model || "",
                nb_unites: (finalPac?.units ?? 1),
                technologie: (document.getElementById('technologySelect')?.value || ""),
                // Résultat (si disponible)
                puissance_batiment_kw: (finalPac?.pRequired ?? null),
                puissance_pac_kw: (finalPac?.pSelected ?? null),
                bivalence: (finalPac?.bivalence ?? null)
            };

            return payload;
        }

        async function sendUsageToGoogleSheet(payload) {
            if (!GOOGLE_SHEET_WEBAPP_URL) return; // pas configuré
            try {
                await fetch(GOOGLE_SHEET_WEBAPP_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain;charset=UTF-8" },
                    body: JSON.stringify(payload)
                });
            } catch (e) {
                // On ne bloque pas l'utilisateur si le tracking échoue
                console.warn("Tracking Google Sheet: échec d'envoi", e);
            }
        }

        function logUsageIfNeeded() {
            if (usageLogged) return;
            // On log uniquement quand on est sur la dernière page et qu'on a un résultat quelconque
            if (!finalPac || !finalPac.model) return;

            const payload = buildUsagePayload();

            // Minimum requis : installateur, bénéficiaire, CP, modèle, unités
            if (!payload.installateur_nom || !payload.beneficiaire_nom || !/^\d{5}$/.test(payload.beneficiaire_cp) || !payload.modele_choisi) {
                return;
            }

            usageLogged = true;
            sendUsageToGoogleSheet(payload);
        }

// === Liens Fiche technique / Notice d'installation ===
        function getTechSheetUrl(model){
            if (!model) return null;
            const m = model.toUpperCase();
            if (m.startsWith('F2050')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/875864/storage/ODc1ODY0LzAvbWFzdGVr';
            if (m.startsWith('S2125')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/906101/storage/OTA2MTAxLzAvbWFzdGVy';
            if (m.startsWith('AMS')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/893145/storage/ODkzMTQ1LzAvbWFzdGVy';
            if (m.startsWith('S735')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/881548/storage/ODgxNTQ4LzAvbWFzdGVy';
            if (m.startsWith('F1153') || m.startsWith('F1253')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/899603/storage/ODk5NjAzLzAvbWFzdGVy';
            if (m.startsWith('S1155')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/22598/storage/MDIyNTk4LzAvbWFzdGVy';
            if (m.startsWith('S1156')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/883850/storage/ODgzODUwLzAvbWFzdGVy';
            if (m.startsWith('S1256')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/883848/storage/ODgzODQ4LzAvbWFzdGVr';
            if (m.startsWith('F1355')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/22594/storage/MDIyNTk0LzAvbWFzdGVy';
            if (m.startsWith('F1345')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/22593/storage/MDIyNTkzLzAvbWFzdGVy';
            return null;
        }

        function getInstallManualUrl(model){
            if (!model) return null;
            const m = model.toUpperCase();
            if (m.startsWith('F2050')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/886452/storage/ODg2NDUyLzAvbWFzdGVy';
            if (m.startsWith('S2125')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/905850/storage/OTA1ODUwLzAvbWFzdGVy';
            if (m.startsWith('AMS')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/892751/storage/ODkyNzUxLzAvbWFzdGVy';
            if (m.startsWith('S735')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/893061/storage/ODkzMDYxLzAvbWFzdGVy';
            if (m.startsWith('F1153')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/891120/storage/ODkxMTIwLzAvbWFzdGVy';
            if (m.startsWith('F1253')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/891161/storage/ODkxMTYxLzAvbWFzdGVy';
            if (m.startsWith('S1155')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/889934/storage/ODg5OTM0LzAvbWFzdGVy';
            if (m.startsWith('S1156')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/909513/storage/OTA5NTEzLzAvbWFzdGVy';
            if (m.startsWith('S1256')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/909583/storage/OTA5NTgzLzAvbWFzdGVy';
            if (m.startsWith('F1355')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/891271/storage/ODkxMjcxLzAvbWFzdGVy';
            if (m.startsWith('F1345')) return 'https://assetstore.nibe.se/hcms/v2.3/entity/document/890055/storage/ODkwMDU1LzAvbWFzdGVy';
            return null;
        }

        function openTechSheet(){
            if (!finalPac || !finalPac.model){
                alert("Veuillez d'abord sélectionner une pompe à chaleur et générer le dimensionnement.");
                return;
            }
            const url = getTechSheetUrl(finalPac.model);
            if (!url){
                alert("Aucune fiche technique disponible pour ce modèle.");
                return;
            }
            window.open(url, '_blank');
        }

        function openInstallManual(){
            if (!finalPac || !finalPac.model){
                alert("Veuillez d'abord sélectionner une pompe à chaleur et générer le dimensionnement.");
                return;
            }
            const url = getInstallManualUrl(finalPac.model);
            if (!url){
                alert("Aucune notice d'installation disponible pour ce modèle.");
                return;
            }
            window.open(url, '_blank');
        }

        // Initialisation
        addZone();
        showStep(1);
        updateAirExtrAvailability();

        document.getElementById('geoModel').addEventListener('change', function(){
            geoManuallySelected = true;
            computeTechnology();
        });
        document.getElementById('geoUnits').addEventListener('input', function(){
            geoManuallySelected = true;
            computeTechnology();
        });
        document.getElementById('airEauModel').addEventListener('change', function(){
            airEauManuallySelected = true;
            computeTechnology();
        });
        document.getElementById('airEauUnits').addEventListener('input', function(){
            airEauManuallySelected = true;
            computeTechnology();
        });
        document.getElementById('airExtrModel').addEventListener('change', function(){ computeTechnology(); });
        document.getElementById('airExtrFlow').addEventListener('change', function(){
            airExtrFlowManuallySelected = true;
            computeTechnology();
        });
    </script>
</body>
</html>
