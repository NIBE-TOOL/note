<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NOTE DE DIMENSIONNEMENT – Formulaire unique</title>
<style>
  html,body{background:#fff;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 12px}
  h2{font-size:16px;margin:18px 0 8px}
  label{display:block;margin:8px 0 4px}
  input,select{width:100%;box-sizing:border-box;padding:10px;border:1px solid #dcdfe5;border-radius:6px;background:#fff}
  .row{display:grid;gap:12px}
  .row-2{grid-template-columns:1fr 1fr}
  .row-3{grid-template-columns:1fr 1fr 1fr}
  .row-4{grid-template-columns:1fr 1fr 1fr 1fr}
  .card{border:1px solid #eceff3;border-radius:10px;padding:12px;margin:12px 0}
  .muted{opacity:.75}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  button{border:1px solid #cfd3da;background:#fff;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
  button.primary{background:#111;color:#fff;border-color:#111}
  button:disabled{opacity:.5;cursor:not-allowed}
  .actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .tag{display:inline-block;border:1px solid #d5d7dd;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}
  .hr{height:1px;background:#eceff3;margin:12px 0}
  .grid-zones{display:grid;gap:12px}
  .z-title{display:flex;justify-content:space-between;align-items:center}
  .tabs{display:flex;gap:8px;margin:6px 0 10px}
  .tabs button{padding:6px 10px;border-radius:999px;border:1px solid #dcdfe5;background:#fff}
  .tabs button.active{background:#111;color:#fff;border-color:#111}
  .warn{color:#9a2a2a}
  .ok{color:#1f7a1f}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid #e7eaf0;padding:6px;text-align:left}

  /* ===== Rapport compact ===== */
  #rapport{font-size:12px}
  #rapport table{width:100%;margin:6px 0}
  #rapport th{background:#f7f8fa;font-weight:600}
  #rapport .t-small td, #rapport .t-small th{padding:4px 6px;font-size:11px}
  #rapport .cap{letter-spacing:.08em;font-weight:700}
  #rapport .headline{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center;margin-bottom:6px}
  #rapport .headline img{max-width:140px;max-height:60px;object-fit:contain}
  #rapport .headline h2{margin:0;text-align:center;font-size:18px}
  #rapport .footnote{font-size:10px;opacity:.8}
  #rapport .etas{color:#0a5b22;font-weight:700}
  #r_haute{display:none}
  .tight{margin-top:6px}

  /* Impression : on n'imprime QUE le rapport */
  @media print{
    .screen-only{display:none!important}
    .wrap{max-width:none;margin:0;padding:0}
    @page{size:A4;margin:12mm}
    #rapport{page-break-inside:avoid}
  }
</style>
</head>
<body>
<div class="wrap">

  <h1 class="screen-only">NOTE DE DIMENSIONNEMENT – Formulaire</h1>

  <!-- IDENTITÉS (masqué à l'impression) -->
  <div class="card screen-only">
    <h2>Installateur & Bénéficiaire</h2>
    <div class="row row-2">
      <div><label>Nom de l’entreprise</label><input id="inst_nom" placeholder="Société XYZ"></div>
      <div><label>SIRET</label><input id="inst_siret" placeholder="14 chiffres"></div>
    </div>
    <div class="row">
      <div><label>Adresse de l’entreprise</label><input id="inst_adresse" placeholder="N° et voie, CP Ville"></div>
    </div>

    <div class="row row-2" style="margin-top:8px">
      <div><label>Prénom</label><input id="ben_prenom"></div>
      <div><label>Nom</label><input id="ben_nom"></div>
    </div>
    <div class="row">
      <div><label>Adresse complète</label><input id="ben_adresse" placeholder="N° et voie, complément"></div>
    </div>
    <div class="row row-3">
      <div><label>Code postal</label><input id="ben_cp" maxlength="5" placeholder="75001"></div>
      <div><label>Ville</label><input id="ben_ville"></div>
      <div><label>Année de construction</label><input id="ben_annee" type="number" min="1800" max="2100"></div>
    </div>

    <div class="row row-3 tight">
      <div style="display:flex;align-items:center;gap:8px;margin-top:6px">
        <input id="bord_de_mer" type="checkbox" style="width:auto">
        <label for="bord_de_mer" style="margin:0">Bord de mer (température de base fixée à −2&nbsp;°C)</label>
      </div>
      <div>
        <label>Altitude</label>
        <select id="altitude">
          <option value="0-200">0 à 200 m</option><option value="201-400">201 à 400 m</option>
          <option value="401-600">401 à 600 m</option><option value="601-800">601 à 800 m</option>
          <option value="801-1000">801 à 1000 m</option><option value="1001-1200">1001 à 1200 m</option>
          <option value="1201-1400">1201 à 1400 m</option><option value="1401-1600">1401 à 1600 m</option>
          <option value="1601-1800">1601 à 1800 m</option><option value="1801-2000">1801 à 2000 m</option>
          <option value="2001-2200">2001 à 2200 m</option>
        </select>
      </div>
      <div class="muted" id="baseTempInfo" style="align-self:end">Température de base : —</div>
    </div>
  </div>

  <!-- ZONES (masqué à l'impression) -->
  <div class="card screen-only">
    <div class="z-title">
      <h2>Zones (jusqu’à 20)</h2>
      <div class="actions">
        <button id="addZone" type="button">Ajouter une zone</button>
        <span class="muted">Déperditions totales : <span id="depTot" class="mono">0</span> W</span>
      </div>
    </div>
    <div id="zones" class="grid-zones"></div>
    <div class="hr"></div>
    <div class="row row-3">
      <div>
        <label>Déperditions totales – saisie manuelle (W, optionnel)</label>
        <input id="depMan" type="number" min="0" step="1" placeholder="Laisser vide pour calcul automatique">
      </div>
      <div style="align-self:end" class="muted">Si renseigné, ce total remplace le calcul.</div>
    </div>
  </div>

  <!-- TECHNOLOGIE (masqué à l'impression) -->
  <div class="card screen-only">
    <h2>Technologie & sélection</h2>
    <div class="tabs">
      <button data-tech="geo" class="active" type="button">Géothermie / Aquathermie</button>
      <button data-tech="aireau" type="button">Pompe à chaleur Air/Eau</button>
      <button data-tech="airextrait" type="button">Pompe à chaleur sur Air Extrait</button>
    </div>

    <!-- GEO -->
    <div id="geoBox">
      <div class="row row-3">
        <div>
          <label>Source</label>
          <select id="geoSource">
            <option value="0">Géothermie 0 °C</option>
            <option value="5">Géothermie 5 °C</option>
            <option value="10">Aquathermie 10 °C</option>
          </select>
        </div>
        <div>
          <label>Modèle</label>
          <select id="geoModel"></select>
        </div>
        <div>
          <label>Unités (1–9)</label>
          <input id="geoUnits" type="number" min="1" max="9" value="1">
        </div>
      </div>
    </div>

    <!-- AIR/EAU -->
    <div id="aeBox" style="display:none">
      <div class="row row-3">
        <div>
          <label>Modèle</label>
          <select id="aeModel"></select>
        </div>
        <div>
          <label>Unités (1–8)</label>
          <input id="aeUnits" type="number" min="1" max="8" value="1">
        </div>
        <div class="muted" style="align-self:end">Température extérieure de base : <span id="tbaseAE" class="mono">—</span></div>
      </div>
    </div>

    <!-- AIR EXTRACT -->
    <div id="axBox" style="display:none">
      <div class="row row-3">
        <div>
          <label>Modèle</label>
          <select id="axModel">
            <option value="S735-4">S735-4</option>
            <option value="S735-7">S735-7</option>
            <option value="S735-7C">S735-7C</option>
          </select>
        </div>
        <div>
          <label>Débit de ventilation (m³/h)</label>
          <select id="axFlow"></select>
        </div>
        <div style="align-self:end" class="muted">Unités : 1 (unique)</div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="row row-3">
      <div><strong>Température de fonctionnement (max zones)</strong><br><span id="maxRegime" class="mono">—</span></div>
      <div><strong>Puissance PAC à T° de base</strong><br><span id="pacPower" class="mono">0.00</span> kW</div>
      <div><strong>Ratio PAC / Déperditions</strong><br><span id="pacRatio" class="mono">—</span> %</div>
    </div>
    <div id="techWarn" class="warn tight"></div>
  </div>

  <!-- ===================== RAPPORT FINAL (IMPRIMÉ SEUL) ===================== -->
  <div class="card" id="rapport">
    <div class="headline">
      <img alt="Logo" id="logo" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQQRLnUEoNR2GdiXhoMIgRc6NZN_8JHSGA2DQ&s">
      <h2 class="cap">NOTE DE DIMENSIONNEMENT</h2>
    </div>

    <!-- Bloc Identités -->
    <table class="t-small">
      <thead><tr><th style="width:50%">Installateur</th><th>Bénéficiaire</th></tr></thead>
      <tbody>
        <tr>
          <td id="r_inst" class="mono"></td>
          <td id="r_ben" class="mono"></td>
        </tr>
      </tbody>
    </table>

    <!-- Paramètres principaux -->
    <table class="t-small">
      <thead><tr><th>Température extérieure de base</th><th>Surface chauffée</th><th>Hauteur sous plafond moyenne</th><th>Température ambiante</th><th>Température max de fonctionnement</th></tr></thead>
      <tbody>
        <tr>
          <td class="mono"><span id="r_tbase"></span> °C</td>
          <td class="mono"><span id="r_surf"></span> m²</td>
          <td class="mono"><span id="r_havg"></span> m</td>
          <td class="mono"><span id="r_ti"></span> °C</td>
          <td class="mono"><span id="r_tmax"></span> <span id="r_haute" class="tag">Haute température</span></td>
        </tr>
      </tbody>
    </table>

    <!-- Surfaces par régime -->
    <table class="t-small">
      <thead><tr><th style="width:40%">Régime (°C)</th><th>Surface totale (m²)</th></tr></thead>
      <tbody id="r_table"></tbody>
    </table>

    <!-- Solution retenue -->
    <table class="t-small">
      <thead><tr><th>Solution retenue</th></tr></thead>
      <tbody><tr><td id="r_solution" class="mono"></td></tr></tbody>
    </table>

    <!-- Performances -->
    <table class="t-small">
      <thead><tr><th>Température d’arrêt PAC NIBE</th><th>Puissance PAC à température de base</th><th>Déperditions totales</th><th>Ratio PAC / Déperditions</th><th>Puissance d’appoint recommandée</th></tr></thead>
      <tbody>
        <tr>
          <td class="mono"><span id="r_stop"></span> °C</td>
          <td class="mono"><span id="r_pac_base"></span> kW</td>
          <td class="mono"><span id="r_dep"></span> kW</td>
          <td class="mono"><span id="r_ratio"></span> %</td>
          <td class="mono"><span id="r_appoint"></span> kW</td>
        </tr>
      </tbody>
    </table>

    <!-- ETAS -->
    <table class="t-small">
      <thead><tr><th>ETAS 35 °C</th><th>ETAS 55 °C</th></tr></thead>
      <tbody>
        <tr>
          <td class="mono etas" id="r_etas35"></td>
          <td class="mono etas" id="r_etas55"></td>
        </tr>
      </tbody>
    </table>

    <!-- Bornes 60% / 130% -->
    <table class="t-small">
      <thead><tr><th>60 % des déperditions</th><th>130 % des déperditions</th></tr></thead>
      <tbody>
        <tr>
          <td class="mono"><span id="r_60"></span> kW</td>
          <td class="mono"><span id="r_130"></span> kW</td>
        </tr>
      </tbody>
    </table>

    <p class="footnote">Les déperditions calculées concernent toutes les pièces du logement desservies par le réseau de chauffage et sans considération d’éventuels autre générateurs. Informations données à titre informatif, vérifier les notices, réglementations en vigueur et régimes de fonctionnement.</p>
  </div>

  <div class="actions screen-only" style="margin:12px 0 24px">
    <button id="majRapport" class="primary" type="button">Mettre à jour le rapport</button>
    <button type="button" onclick="window.print()">Imprimer (PDF A4)</button>
    <span class="muted">À l’impression, seules les données du rapport sortent.</span>
  </div>

</div>

<script>
/* =========================
   DONNÉES
   ========================= */
const depBase={"01":-10,"02":-7,"03":-8,"04":-8,"05":-10,"06":-2,"07":-7,"08":-10,"09":-5,"10":-10,"11":-5,"12":-8,"13":-5,"14":-7,"15":-8,"16":-5,"17":-5,"18":-7,"19":-8,"21":-10,"22":-4,"23":-8,"24":-5,"25":-12,"26":-7,"27":-7,"28":-7,"29":-4,"30":-5,"31":-5,"32":-5,"33":-5,"34":-5,"35":-5,"36":-7,"37":-7,"38":-10,"39":-10,"40":-5,"41":-7,"42":-10,"43":-8,"44":-5,"45":-7,"46":-7,"47":-5,"48":-8,"49":-7,"50":-4,"51":-10,"52":-12,"53":-7,"54":-15,"55":-12,"56":-4,"57":-15,"58":-10,"59":-9,"60":-7,"61":-7,"62":-9,"63":-8,"64":-5,"65":-5,"66":-5,"67":-15,"68":-15,"69":-10,"70":-12,"71":-10,"72":-7,"73":-10,"74":-10,"75":-7,"76":-7,"77":-7,"78":-7,"79":-7,"80":-9,"81":-5,"82":-5,"83":-2,"84":-7,"85":-5,"86":-7,"87":-8,"88":-15,"89":-10,"90":-15,"91":-7,"92":-7,"93":-7,"94":-7,"95":-7};

/* >>> Correction du barème altitude pour base -7°C (0–200 m = -7, et non -8) <<< */
const altMaps={
  "-2":{"0-200":-2,"201-400":-4,"401-600":-6,"601-800":-8,"801-1000":-10,"1001-1200":-12,"1201-1400":-14,"1401-1600":-16,"1601-1800":-18,"1801-2000":-20},
  "-4":{"0-200":-4,"201-400":-5,"401-600":-6,"601-800":-7,"801-1000":-8,"1001-1200":-9,"1201-1400":-10},
  "-5":{"0-200":-5,"201-400":-6,"401-600":-7,"601-800":-8,"801-1000":-9,"1001-1200":-10,"1201-1400":-11,"1401-1600":-12,"1601-1800":-13,"1801-2000":-14,"2001-2200":-15},
  "-7":{"0-200":-7,"201-400":-8,"401-600":-9,"601-800":-11,"801-1000":-13,"1001-1200":-14,"1201-1400":-15},
  "-8":{"0-200":-8,"201-400":-9,"401-600":-11,"601-800":-13,"801-1000":-15,"1001-1200":-17,"1201-1400":-19,"1401-1600":-21,"1601-1800":-23,"1801-2000":-25,"2001-2200":-27},
  "-9":{"0-200":-9,"201-400":-10,"401-600":-11,"601-800":-12,"801-1000":-13},
  "-10":{"0-200":-10,"201-400":-11,"401-600":-13,"601-800":-14,"801-1000":-17,"1001-1200":-19,"1201-1400":-21,"1401-1600":-23,"1601-1800":-24,"1801-2000":-25,"2001-2200":-29},
  "-12":{"0-200":-12,"201-400":-13,"401-600":-15,"601-800":-17,"801-1000":-19,"1001-1200":-21,"1201-1400":-23,"1401-1600":-24},
  "-15":{"0-200":-15,"201-400":-15,"401-600":-19,"601-800":-21,"801-1000":-23,"1001-1200":-24,"1201-1400":-25}
};
const Goptions=[["2.00","véranda récente"],["1.60","pas isolé, pas d’inertie"],["1.40","pas isolé, ancien, mur 60cm"],["1.30","isolé, bâtiment années 1960"],["1.20","entre 1974-1982"],["1.10","maison années 1980"],["1.00","entre 1990-2000"],["0.90","maison RT2000"],["0.80","entre 2001-2005"],["0.80","isolation norme RT2000"],["0.75","maison RT2005"],["0.60","isolation norme RT2012"],["0.50","isolation norme RT2012 Bbio +"],["0.40","isolation norme RE2020"]];
const N=x=>Number(String(x).replace(',','.')); const clamp=(v,mi,ma)=>Math.min(Math.max(v,mi),ma);

/* === Données puissances (géothermie/aquathermie, air/eau, air extrait) et ETAS
   — identiques à la version précédente, conservées intégralement ci-dessous === */
const geoModels=["F1153-4","F1153-6","F1253-4","F1253-6","S1156-8","S1156-13","S1156-18","S1155-25","S1256-8","S1256-13","S1256-18","F1355-28","F1355-43","F1345-24","F1345-30","F1345-40","F1345-60"];
const geoData={}; function addGD(m,src,dep,p){ if(!geoData[m]) geoData[m]={}; geoData[m][`${src}|${dep}`]=p; }
[
["F1253-4",0,55,4.1],["F1253-4",5,55,4.4],["F1253-4",0,35,4.5],["F1253-4",5,35,4.8],["F1253-4",0,45,4.5],["F1253-4",5,45,4.8],
["F1153-4",0,55,4.1],["F1153-4",5,55,4.4],["F1153-4",0,35,4.5],["F1153-4",5,35,4.8],["F1153-4",0,45,4.5],["F1153-4",5,45,4.8],
["F1253-6",0,55,7.0],["F1253-6",5,55,7.3],["F1253-6",0,35,7.6],["F1253-6",5,35,8.0],["F1253-6",0,45,7.7],["F1253-6",5,45,8.0],
["F1153-6",0,55,7.0],["F1153-6",5,55,7.3],["F1153-6",0,35,7.6],["F1153-6",5,35,8.0],["F1153-6",0,45,7.7],["F1153-6",5,45,8.0],
["S1156-8",0,55,7.8],["S1156-8",5,55,9.1],["S1156-8",0,45,8.5],["S1156-8",5,45,9.8],["S1156-8",0,35,8.5],["S1156-8",5,35,9.8],
["S1256-8",0,55,7.8],["S1256-8",5,55,9.1],["S1256-8",0,45,8.5],["S1256-8",5,45,9.8],["S1256-8",0,35,8.5],["S1256-8",5,35,9.8],
["S1156-13",0,55,12.5],["S1156-13",5,55,14.2],["S1156-13",0,35,13.5],["S1156-13",5,35,15.5],["S1156-13",0,45,13.5],["S1156-13",5,45,15.5],
["S1256-13",0,55,12.5],["S1256-13",5,55,14.2],["S1256-13",0,35,13.5],["S1256-13",5,35,15.5],["S1256-13",0,45,13.5],["S1256-13",5,45,15.5],
["S1156-18",0,55,17.8],["S1156-18",5,55,20.2],["S1156-18",0,35,18.9],["S1156-18",5,35,22.0],["S1156-18",0,45,18.9],["S1156-18",5,45,22.0],
["S1256-18",0,55,17.8],["S1256-18",5,55,20.2],["S1256-18",0,35,18.9],["S1256-18",5,35,22.0],["S1256-18",0,45,18.9],["S1256-18",5,45,22.0],
["S1155-25",0,55,24],["S1155-25",5,55,27],["S1155-25",0,35,25],["S1155-25",5,35,29],["S1155-25",0,45,25],["S1155-25",5,45,29],
["F1345-24",0,55,22],["F1345-24",0,35,23],["F1345-24",0,45,23],
["F1345-30",0,55,29],["F1345-30",0,35,31],["F1345-30",0,45,31],
["F1345-40",0,55,38],["F1345-40",0,35,40],["F1345-40",0,45,40],
["F1345-60",0,55,54],["F1345-60",0,35,59],["F1345-60",0,45,59],
["F1355-28",0,55,27],["F1355-28",0,35,28],["F1355-28",0,45,28],
["F1355-43",0,55,38],["F1355-43",0,35,45],["F1355-43",0,45,45],
["F1253-4",10,55,4.6],["F1253-4",10,35,5.0],["F1253-4",10,45,5.0],
["F1153-4",10,55,4.6],["F1153-4",10,35,5.0],["F1153-4",10,45,5.0],
["F1253-6",10,55,7.5],["F1253-6",10,35,8.2],["F1253-6",10,45,8.2],
["F1153-6",10,55,7.5],["F1153-6",10,35,8.2],["F1153-6",10,45,8.2],
["S1156-8",10,55,10.5],["S1156-8",10,35,11.0],["S1156-8",10,45,11.0],
["S1256-8",10,55,10.5],["S1256-8",10,35,11.0],["S1256-8",10,45,11.0],
["S1156-13",10,55,16.0],["S1156-13",10,35,17.5],["S1156-13",10,45,17.5],
["S1256-13",10,55,16.0],["S1256-13",10,35,17.5],["S1256-13",10,45,17.5],
["S1156-18",10,55,22.8],["S1156-18",10,35,24.8],["S1156-18",10,45,24.8],
["S1256-18",10,55,22.8],["S1256-18",10,35,24.8],["S1256-18",10,45,24.8],
["S1155-25",10,55,31],["S1155-25",10,35,34],["S1155-25",10,45,34],
["F1345-24",10,55,28],["F1345-24",10,35,30],["F1345-24",10,45,30],
["F1345-30",10,55,39],["F1345-30",10,35,40],["F1345-30",10,45,40],
["F1345-40",10,55,49],["F1345-40",10,35,52],["F1345-40",10,45,52],
["F1345-60",10,55,69],["F1345-60",10,35,78],["F1345-60",10,45,78],
["F1355-28",10,55,33],["F1355-28",10,35,35],["F1355-28",10,45,35],
["F1355-43",10,55,52],["F1355-43",10,35,58],["F1355-43",10,45,58]
].forEach(([m,s,d,p])=>addGD(m,s,d,N(p)));

const aeModels=["S2125-8","S2125-12","S2125-16","S2125-20","F2050-6","F2050-10","F2050-12","F2050-16","AMS 20-6","AMS 20-10"];
const aeData={}; function addAE(m,tex,dep,p){ if(!aeData[m]) aeData[m]={}; aeData[m][`${tex}|${dep}`]=p; }
function fill(name, rows){aeData[name]={}; rows.forEach(r=>addAE(name,r[0],r[1],N(r[2])));}
/* ... (toutes les séries S2125 / F2050 / AMS identiques à la version précédente – conservées) ... */
fill("S2125-8",[[7,35,6.4],[2,35,6.4],[1,35,6.4],[0,35,6.3],[-1,35,6.2],[-2,35,6.1],[-3,35,5.9],[-4,35,5.8],[-5,35,5.7],[-6,35,5.6],[-7,35,5.5],[-8,35,5.3],[-9,35,5.1],[-10,35,5.0],[-11,35,4.8],[-12,35,4.7],[-13,35,4.5],[-14,35,4.4],[-15,35,4.2],[-16,35,4.10],[-17,35,4.00],[-18,35,3.80],[-19,35,3.70],[-20,35,3.60],[-21,35,3.50],[-22,35,3.40],[-23,35,3.30],[-24,35,3.20],[-25,35,3.20],[7,45,6.2],[2,45,6.2],[1,45,6.1],[0,45,6.0],[-1,45,5.9],[-2,45,5.7],[-3,45,5.6],[-4,45,5.5],[-5,45,5.4],[-6,45,5.3],[-7,45,5.1],[-8,45,5.0],[-9,45,4.9],[-10,45,4.7],[-11,45,4.6],[-12,45,4.4],[-13,45,4.3],[-14,45,4.1],[-15,45,4.0],[-16,45,4.00],[-17,45,3.90],[-18,45,3.70],[-19,45,3.60],[-20,45,3.50],[-21,45,3.40],[-22,45,3.30],[-23,45,3.20],[-24,45,3.10],[-25,45,3.10],[7,55,6.0],[2,55,6.0],[1,55,5.9],[0,55,5.9],[-1,55,5.8],[-2,55,5.7],[-3,55,5.6],[-4,55,5.5],[-5,55,5.4],[-6,55,5.3],[-7,55,5.2],[-8,55,5.0],[-9,55,4.9],[-10,55,4.8],[-11,55,4.6],[-12,55,4.5],[-13,55,4.3],[-14,55,4.2],[-15,55,4.0],[-16,55,3.90],[-17,55,3.80],[-18,55,3.60],[-19,55,3.50],[-20,55,3.40],[-21,55,3.30],[-22,55,3.20],[-23,55,3.00],[-24,55,2.90],[-25,55,2.80]]);
/* (… remplir S2125-12/-16/-20, F2050-6/10/12/16, AMS 20-6/10 – idem version précédente …) */
fill("S2125-12",[[20,35,8.43],[12,35,9.41],[10,35,9.53],[7,35,9.71],[2,35,9.50],[1,35,9.40],[0,35,9.30],[-1,35,9.10],[-2,35,9.00],[-3,35,8.90],[-4,35,8.80],[-5,35,8.70],[-6,35,8.50],[-7,35,8.30],[-8,35,8.00],[-9,35,7.80],[-10,35,7.60],[-11,35,7.40],[-12,35,7.20],[-13,35,6.90],[-14,35,6.70],[-15,35,6.50],[-16,35,6.30],[-17,35,6.10],[-18,35,5.90],[-19,35,5.70],[-20,35,5.50],[-21,35,5.30],[-22,35,5.20],[-23,35,5.00],[-24,35,4.90],[-25,35,4.70],[20,45,10.50],[12,45,10.50],[10,45,10.50],[7,45,9.89],[2,45,9.50],[1,45,9.40],[0,45,9.40],[-1,45,9.20],[-2,45,9.00],[-3,45,8.80],[-4,45,8.70],[-5,45,8.60],[-6,45,8.30],[-7,45,8.40],[-8,45,7.90],[-9,45,7.70],[-10,45,7.50],[-11,45,7.30],[-12,45,7.10],[-13,45,6.90],[-14,45,6.70],[-15,45,6.60],[-16,45,6.30],[-17,45,6.10],[-18,45,5.90],[-19,45,5.70],[-20,45,5.50],[-21,45,5.30],[-22,45,5.20],[-23,45,5.00],[-24,45,4.90],[-25,45,4.70],[20,55,7.65],[12,55,9.95],[10,55,9.98],[7,55,10.03],[2,55,9.50],[1,55,9.40],[0,55,9.40],[-1,55,9.30],[-2,55,9.10],[-3,55,9.00],[-4,55,8.90],[-5,55,8.80],[-6,55,8.50],[-7,55,8.40],[-8,55,8.10],[-9,55,7.90],[-10,55,7.70],[-11,55,7.50],[-12,55,7.30],[-13,55,7.00],[-14,55,6.80],[-15,55,6.60],[-16,55,6.40],[-17,55,6.20],[-18,55,6.10],[-19,55,5.90],[-20,55,5.70],[-21,55,5.50],[-22,55,5.30],[-23,55,5.20],[-24,55,5.00],[-25,55,4.80]]);
fill("S2125-16",[[20,35,20.90],[12,35,19.20],[10,35,17.70],[7,35,16.50],[2,35,14.90],[1,35,14.70],[0,35,14.10],[-1,35,13.90],[-2,35,13.80],[-3,35,13.70],[-4,35,13.60],[-5,35,13.40],[-6,35,13.10],[-7,35,12.70],[-8,35,12.30],[-9,35,11.90],[-10,35,11.38],[-11,35,11.21],[-12,35,10.31],[-13,35,9.98],[-14,35,9.67],[-15,35,9.01],[-16,35,8.90],[-17,35,8.80],[-18,35,8.60],[-19,35,8.50],[-20,35,8.30],[-21,35,8.10],[-22,35,8.00],[-23,35,7.80],[-24,35,7.70],[-25,35,7.50],[20,45,19.10],[12,45,18.20],[10,45,16.70],[7,45,15.60],[2,45,14.90],[1,45,14.70],[0,45,14.10],[-1,45,13.90],[-2,45,13.80],[-3,45,13.70],[-4,45,13.60],[-5,45,13.40],[-6,45,13.10],[-7,45,12.70],[-8,45,12.30],[-9,45,11.90],[-10,45,11.38],[-11,45,11.21],[-12,45,10.31],[-13,45,9.98],[-14,45,9.67],[-15,45,9.01],[-16,45,8.90],[-17,45,8.80],[-18,45,8.60],[-19,45,8.50],[-20,45,8.30],[-21,45,8.10],[-22,45,8.00],[-23,45,7.80],[-24,45,7.70],[-25,45,7.50],[20,55,18.01],[12,55,17.10],[10,55,15.70],[7,55,15.60],[2,55,14.90],[1,55,14.70],[0,55,14.10],[-1,55,13.90],[-2,55,13.80],[-3,55,13.70],[-4,55,13.60],[-5,55,13.40],[-6,55,13.10],[-7,55,12.70],[-8,55,12.30],[-9,55,11.90],[-10,55,11.38],[-11,55,11.21],[-12,55,10.31],[-13,55,9.98],[-14,55,9.67],[-15,55,9.01],[-16,55,8.90],[-17,55,8.80],[-18,55,8.60],[-19,55,8.50],[-20,55,8.30],[-21,55,8.10],[-22,55,8.00],[-23,55,7.80],[-24,55,7.70],[-25,55,7.50]]);
fill("S2125-20",[[20,35,27.10],[12,35,25.40],[10,35,22.40],[7,35,20.01],[2,35,17.81],[1,35,17.01],[0,35,16.80],[-1,35,16.60],[-2,35,15.96],[-3,35,15.45],[-4,35,14.97],[-5,35,14.91],[-6,35,14.79],[-7,35,14.61],[-8,35,13.96],[-9,35,13.56],[-10,35,12.96],[-11,35,12.81],[-12,35,12.72],[-13,35,12.43],[-14,35,12.04],[-15,35,11.91],[-16,35,11.81],[-17,35,11.05],[-18,35,10.93],[-19,35,10.53],[-20,35,10.01],[-21,35,9.96],[-22,35,9.64],[-23,35,9.45],[-24,35,9.03],[-25,35,8.47],[20,45,26.00],[12,45,24.30],[10,45,22.40],[7,45,20.01],[2,45,18.20],[1,45,17.90],[0,45,16.90],[-1,45,16.60],[-2,45,15.96],[-3,45,15.45],[-4,45,14.97],[-5,45,14.91],[-6,45,14.79],[-7,45,14.61],[-8,45,13.96],[-9,45,13.56],[-10,45,12.96],[-11,45,12.81],[-12,45,12.72],[-13,45,12.43],[-14,45,12.04],[-15,45,11.91],[-16,45,11.81],[-17,45,11.05],[-18,45,10.93],[-19,45,10.53],[-20,45,10.01],[-21,45,9.96],[-22,45,9.64],[-23,45,9.45],[-24,45,9.03],[-25,45,8.47],[20,55,24.10],[12,55,23.10],[10,55,21.20],[7,55,19.42],[2,55,18.80],[1,55,17.90],[0,55,16.90],[-1,55,16.60],[-2,55,15.96],[-3,55,15.45],[-4,55,14.97],[-5,55,14.91],[-6,55,14.79],[-7,55,14.61],[-8,55,13.96],[-9,55,13.56],[-10,55,12.96],[-11,55,12.81],[-12,55,12.72],[-13,55,12.43],[-14,55,12.04],[-15,55,11.91],[-16,55,11.81],[-17,55,11.05],[-18,55,10.93],[-19,55,10.53],[-20,55,10.01],[-21,55,9.96],[-22,55,9.64],[-23,55,9.45],[-24,55,9.03],[-25,55,8.47]]);
function fillF2050(name,rows){aeData[name]={}; rows.forEach(r=>addAE(name,r[0],r[1],N(r[2])));}
fillF2050("F2050-6",[[2,35,6.9],[1,35,6.8],[0,35,6.6],[-1,35,6.4],[-2,35,6.2],[-3,35,6.1],[-4,35,6.0],[-5,35,5.9],[-6,35,5.6],[-7,35,5.6],[-8,35,5.4],[-9,35,5.2],[-10,35,5.1],[-11,35,5.0],[-12,35,4.9],[-13,35,4.8],[-14,35,4.6],[-15,35,4.5],[-16,35,4.4],[-17,35,4.2],[-18,35,4.0],[-19,35,3.8],[-20,35,3.7],[-21,35,0],[-22,35,0],[-23,35,0],[-24,35,0],[-25,35,0],[2,45,6.9],[1,45,6.8],[0,45,6.4],[-1,45,6.3],[-2,45,6.2],[-3,45,6.0],[-4,45,5.6],[-5,45,5.4],[-6,45,5.2],[-7,45,5.1],[-8,45,5.0],[-9,45,4.9],[-10,45,4.8],[-11,45,4.7],[-12,45,4.6],[-13,45,4.5],[-14,45,4.4],[-15,45,4.3],[-16,45,4.2],[-17,45,4.1],[-18,45,4.0],[-19,45,3.8],[-20,45,3.7],[-21,45,0],[-22,45,0],[-23,45,0],[-24,45,0],[-25,45,0],[2,55,6.4],[1,55,6.1],[0,55,6.0],[-1,55,5.9],[-2,55,5.8],[-3,55,5.4],[-4,55,5.1],[-5,55,5.0],[-6,55,4.9],[-7,55,4.8],[-8,55,4.6],[-9,55,4.4],[-10,55,4.3],[-11,55,4.1],[-12,55,4.0],[-13,55,3.9],[-14,55,3.8],[-15,55,3.8],[-16,55,3.6],[-17,55,3.5],[-18,55,3.4],[-19,55,3.3],[-20,55,3.1],[-21,55,0],[-22,55,0],[-23,55,0],[-24,55,0],[-25,55,0]]);
fillF2050("F2050-10",[[2,35,10.40],[1,35,10.30],[0,35,10.20],[-1,35,10.10],[-2,35,10.01],[-3,35,9.80],[-4,35,9.50],[-5,35,9.30],[-6,35,9.00],[-7,35,8.90],[-8,35,8.60],[-9,35,8.30],[-10,35,8.20],[-11,35,7.90],[-12,35,7.70],[-13,35,7.50],[-14,35,7.20],[-15,35,7.10],[-16,35,6.90],[-17,35,6.50],[-18,35,6.40],[-19,35,6.10],[-20,35,5.90],[-21,35,0],[-22,35,0],[-23,35,0],[-24,35,0],[-25,35,0],[2,45,10.2],[1,45,9.9],[0,45,9.8],[-1,45,9.6],[-2,45,9.4],[-3,45,9.1],[-4,45,8.9],[-5,45,8.7],[-6,45,8.5],[-7,45,8.2],[-8,45,8.0],[-9,45,7.8],[-10,45,7.6],[-11,45,7.2],[-12,45,7.0],[-13,45,6.8],[-14,45,6.7],[-15,45,6.6],[-16,45,6.5],[-17,45,6.3],[-18,45,6.1],[-19,45,5.8],[-20,45,5.6],[-21,45,0],[-22,45,0],[-23,45,0],[-24,45,0],[-25,45,0],[2,55,9.20],[1,55,9.10],[0,55,9.00],[-1,55,8.70],[-2,55,8.50],[-3,55,8.00],[-4,55,7.90],[-5,55,7.60],[-6,55,7.40],[-7,55,7.10],[-8,55,7.00],[-9,55,6.70],[-10,55,6.40],[-11,55,6.30],[-12,55,6.20],[-13,55,6.10],[-14,55,5.80],[-15,55,5.50],[-16,55,5.20],[-17,55,5.00],[-18,55,4.80],[-19,55,4.60],[-20,55,4.50],[-21,55,0],[-22,55,0],[-23,55,0],[-24,55,0],[-25,55,0]]);
fillF2050("F2050-12",[[9,35,12.50],[8,35,12.40],[7,35,12.10],[6,35,11.90],[5,35,11.70],[4,35,11.50],[3,35,11.00],[2,35,10.50],[1,35,10.10],[0,35,9.90],[-1,35,9.80],[-2,35,9.60],[-3,35,9.30],[-4,35,9.00],[-5,35,8.80],[-6,35,8.60],[-7,35,8.40],[-8,35,8.20],[-9,35,7.80],[-10,35,7.50],[-11,35,7.20],[-12,35,7.00],[-13,35,6.80],[-14,35,6.60],[-15,35,6.40],[-16,35,6.20],[-17,35,6.00],[-18,35,5.80],[-19,35,5.60],[-20,35,5.40],[-21,35,5.20],[-22,35,5.00],[-23,35,4.80],[-24,35,4.60],[-25,35,4.40],[9,45,11.50],[8,45,11.20],[7,45,11.10],[6,45,10.90],[5,45,10.30],[4,45,10.30],[3,45,10.00],[2,45,9.90],[1,45,9.70],[0,45,9.60],[-1,45,9.40],[-2,45,9.10],[-3,45,8.90],[-4,45,8.40],[-5,45,8.20],[-6,45,8.00],[-7,45,7.80],[-8,45,7.40],[-9,45,7.20],[-10,45,7.00],[-11,45,6.70],[-12,45,6.50],[-13,45,6.30],[-14,45,6.10],[-15,45,5.90],[-16,45,5.80],[-17,45,5.70],[-18,45,5.50],[-19,45,5.10],[-20,45,4.90],[-21,45,4.80],[-22,45,4.70],[-23,45,4.60],[-24,45,4.40],[-25,45,4.10]]);
fillF2050("F2050-16",[[9,35,17.00],[8,35,16.87],[7,35,16.09],[6,35,15.91],[5,35,15.50],[4,35,15.04],[3,35,14.70],[2,35,14.40],[1,35,14.00],[0,35,13.70],[-1,35,13.40],[-2,35,13.00],[-3,35,12.80],[-4,35,12.40],[-5,35,11.90],[-6,35,11.60],[-7,35,11.30],[-8,35,11.10],[-9,35,10.80],[-10,35,10.40],[-11,35,10.00],[-12,35,9.80],[-13,35,9.40],[-14,35,9.00],[-15,35,8.50],[-16,35,7.90],[-17,35,7.40],[-18,35,7.10],[-19,35,7.00],[-20,35,6.90],[-21,35,6.20],[-22,35,5.80],[-23,35,5.60],[-24,35,5.50],[-25,35,5.30],[9,45,15.40],[8,45,14.90],[7,45,14.40],[6,45,14.10],[5,45,13.80],[4,45,13.60],[3,45,13.00],[2,45,12.70],[1,45,12.40],[0,45,12.00],[-1,45,11.70],[-2,45,11.50],[-3,45,11.00],[-4,45,10.80],[-5,45,10.50],[-6,45,10.00],[-7,45,9.70],[-8,45,9.40],[-9,45,9.00],[-10,45,8.70],[-11,45,8.40],[-12,45,8.00],[-13,45,7.70],[-14,45,7.40],[-15,45,7.20],[-16,45,6.70],[-17,45,6.40],[-18,45,6.10],[-19,45,5.90],[-20,45,5.60],[-21,45,5.10],[-22,45,5.00],[-23,45,4.80],[-24,45,4.60],[-25,45,4.20],[9,55,15.40],[8,55,14.90],[7,55,14.40],[6,55,14.10],[5,55,13.80],[4,55,13.60],[3,55,13.00],[2,55,12.70],[1,55,12.40],[0,55,12.00],[-1,55,11.70],[-2,55,11.50],[-3,55,11.00],[-4,55,10.80],[-5,55,10.50],[-6,55,10.00],[-7,55,9.70],[-8,55,9.40],[-9,55,9.00],[-10,55,8.70],[-11,55,8.40],[-12,55,8.00],[-13,55,7.70],[-14,55,7.40],[-15,55,7.20],[-16,55,6.70],[-17,55,6.40],[-18,55,6.10],[-19,55,5.90],[-20,55,5.60],[-21,55,5.10],[-22,55,5.00],[-23,55,4.80],[-24,55,4.60],[-25,55,4.20]]);

aeData["AMS 20-6"]=Object.assign({},aeData["F2050-6"]);
aeData["AMS 20-10"]=Object.assign({},aeData["F2050-10"]);

const axFlows={"S735-4":[60,75,90,105,120,135,150,165,180,195,210,225,240,255,270,285,300,315,330,345,360,375,390],"S735-7":[90,105,120,135,150,165,180,195,210,225,240,255,270,285,300,315,330,345,360,375,390],"S735-7C":[90,105,120,135,150,165,180,195,210,225,240,255,270,285,300,315,330,345,360,375,390]};
const axData={"S735-4":{60:[1.3,1.4,1.5],75:[1.5,1.6,1.75],90:[1.8,2,2.25],105:[2.2,2.4,2.6],120:[2.4,2.65,2.9],135:[2.65,3.05,3.2],150:[2.9,3.25,3.4],165:[3.25,3.5,3.6],180:[3.45,3.6,3.75],195:[3.65,3.8,3.9],210:[3.8,3.9,4],225:[3.9,4,4.1],240:[3.9,4,4.1],255:[4.2,4.2,4.2],270:[4.2,4.2,4.2],285:[4.2,4.2,4.2],300:[4.2,4.2,4.2],315:[4.2,4.2,4.2],330:[4.2,4.2,4.2],345:[4.2,4.2,4.2],360:[4.2,4.2,4.2],375:[4.2,4.2,4.2],390:[4.2,4.2,4.2]},"S735-7":{90:[2,2.23,2.6],105:[2.4,2.6,3],120:[2.6,2.9,3.2],135:[3,3.25,3.65],150:[3.25,3.5,3.8],165:[3.6,3.9,4.2],180:[4,4.5,4.6],195:[4.2,4.6,4.75],210:[4.4,4.7,5],225:[4.8,4.95,5.15],240:[4.8,4.95,5.15],255:[5.2,5.4,5.4],270:[5.4,5.5,5.5],285:[5.4,5.5,5.5],300:[5.8,5.9,6],315:[5.9,6,6.1],330:[6.2,6.25,6.3],345:[6.3,6.3,6.4],360:[6.4,6.42,6.52],375:[6.4,6.42,6.52],390:[6.4,6.42,6.52]}};
axData["S735-7C"]=Object.assign({},axData["S735-7"]);

const ETAS35={"S735-4":191,"S735-7":181,"S735-7C":193,"F2050-6":204,"F2050-10":185,"F2050-12":196,"F2050-16":184,"S2125-8":200,"S2125-12":199,"S2125-16":214,"S2125-20":213,"AMS 20-6":204,"AMS 20-10":185,"F1153-4":206,"F1153-6":204,"F1253-4":206,"F1253-6":204,"S1156-8":223,"S1156-13":231,"S1156-18":234,"S1155-25":204,"S1256-8":223,"S1256-13":231,"S1256-18":234,"F1345-24":187,"F1345-30":180,"F1345-40":184,"F1345-60":178,"F1355-28":195,"F1355-43":194};
const ETAS55={"S735-4":147,"S735-7":148,"S735-7C":154,"F2050-6":143,"F2050-10":136,"F2050-12":141,"F2050-16":138,"S2125-8":150,"S2125-12":154,"S2125-16":164,"S2125-20":164,"AMS 20-6":143,"AMS 20-10":136,"F1153-4":154,"F1153-6":154,"F1253-4":154,"F1253-6":154,"S1156-8":166,"S1156-13":167,"S1156-18":173,"S1155-25":154,"S1256-8":166,"S1256-13":167,"S1256-18":173,"F1345-24":145,"F1345-30":139,"F1345-40":145,"F1345-60":140,"F1355-28":152,"F1355-43":154};

/* ========================= APP ========================= */
document.addEventListener('DOMContentLoaded', ()=>{
  // Populate selects
  const geoModel=document.getElementById('geoModel');
  const aeModel=document.getElementById('aeModel');
  geoModels.forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=m;geoModel.appendChild(o);});
  aeModels.forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=m;aeModel.appendChild(o);});

  // Zones
  const zonesDiv=document.getElementById('zones');
  let zoneCount=0; const MAX_ZONES=20;
  const GHTML=Goptions.map(([g,lab])=>`<option value="${g}">${lab} — G=${g}</option>`).join('');

  function zoneNode(i){
    const el=document.createElement('div');
    el.className='card';
    el.innerHTML=`
      <div class="z-title"><strong>Zone ${i}</strong><button type="button" data-del>Supprimer</button></div>
      <div class="row row-4">
        <div><label>Surface (m²)</label><input type="number" step="0.1" min="0" value="0" data-s></div>
        <div><label>Hauteur (m)</label><input type="number" step="0.01" min="0" value="2.5" data-h></div>
        <div><label>Température ambiante (°C)</label><input type="number" step="0.1" value="20" data-ti></div>
        <div><label>Régime (°C)</label>
          <select data-reg><option value="35">35</option><option value="45">45</option><option value="55">55</option><option value="65">65</option></select>
        </div>
        <div><label>Isolation (G)</label><select data-g>${GHTML}</select></div>
      </div>`;
    el.querySelectorAll('input,select').forEach(x=>{
      x.addEventListener('input', recalcAll);
      x.addEventListener('change', recalcAll);
    });
    el.querySelector('[data-del]').addEventListener('click',()=>{
      el.remove(); zoneCount--; renum(); recalcAll();
    });
    return el;
  }
  function addZone(){ if(zoneCount>=MAX_ZONES) return; zoneCount++; zonesDiv.appendChild(zoneNode(zoneCount)); }
  function renum(){ [...zonesDiv.children].forEach((c,i)=>c.querySelector('strong').textContent=`Zone ${i+1}`); }
  document.getElementById('addZone').addEventListener('click', addZone);

  // Base température (CP + altitude + bord de mer)
  ["ben_cp","bord_de_mer","altitude"].forEach(id=>{
    document.getElementById(id).addEventListener('input', updateBaseInfo);
    document.getElementById(id).addEventListener('change', updateBaseInfo);
  });
  function deptFromCP(cp){ return /^\d{5}$/.test(cp||"")?cp.slice(0,2):null; }
  function computeBaseTemp(){
    const cp=document.getElementById('ben_cp').value.trim();
    const d=deptFromCP(cp); if(!d||depBase[d]==null) return null;
    let base=depBase[d];
    if(document.getElementById('bord_de_mer').checked) base=-2;
    const map=altMaps[String(base)];
    if(!map) return base;
    const key=document.getElementById('altitude').value;
    if(map[key]!=null) return map[key];
    return base;
  }
  function updateBaseInfo(){
    const t=computeBaseTemp();
    document.getElementById('baseTempInfo').textContent = t==null ? "Température de base : —" : `Température de base estimée : ${t} °C`;
    document.getElementById('tbaseAE').textContent = t==null ? "—" : `${t} °C`;
    recalcAll();
  }

  // Tabs techno
  const tabBtns=[...document.querySelectorAll('.tabs [data-tech]')];
  const geoBox=document.getElementById('geoBox'), aeBox=document.getElementById('aeBox'), axBox=document.getElementById('axBox');
  let currentTech="geo";
  tabBtns.forEach(btn=>{
    btn.addEventListener('click',()=>{
      tabBtns.forEach(b=>b.classList.toggle('active',b===btn));
      currentTech=btn.getAttribute('data-tech');
      geoBox.style.display=currentTech==="geo"?"block":"none";
      aeBox.style.display=currentTech==="aireau"?"block":"none";
      axBox.style.display=currentTech==="airextrait"?"block":"none";
      if(currentTech==="airextrait") fillAxFlows();
      recalcAll();
    });
  });

  // Sélections techno – écouteurs
  const geoSource=document.getElementById('geoSource');
  const geoUnits=document.getElementById('geoUnits');
  const geoModelSel=document.getElementById('geoModel');
  geoSource.addEventListener('change', recalcAll); geoUnits.addEventListener('input', recalcAll); geoUnits.addEventListener('change', recalcAll);
  geoModelSel.addEventListener('change', recalcAll);

  const aeUnits=document.getElementById('aeUnits');
  const aeModelSel=document.getElementById('aeModel');
  aeUnits.addEventListener('input', recalcAll); aeUnits.addEventListener('change', recalcAll);
  aeModelSel.addEventListener('change', recalcAll);

  const axModel=document.getElementById('axModel');
  const axFlow=document.getElementById('axFlow');
  axModel.addEventListener('change', ()=>{ fillAxFlows(); recalcAll(); });
  axFlow.addEventListener('change', recalcAll);

  function fillAxFlows(){
    const m=axModel.value; axFlow.innerHTML="";
    (axFlows[m]||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; axFlow.appendChild(o); });
  }
  fillAxFlows();

  // Récup zones
  function getZones(){
    return [...zonesDiv.children].map(c=>({
      s:+(c.querySelector('[data-s]').value||0),
      h:+(c.querySelector('[data-h]').value||2.5),
      ti:+(c.querySelector('[data-ti]').value||20),
      reg:+(c.querySelector('[data-reg]').value),
      g:+(c.querySelector('[data-g]').value)
    }));
  }
  const Gcalc=(z,tbase)=> (z.g*(z.s*z.h)*(z.ti - tbase));

  function baseTempForZones(){ return computeBaseTemp()??-7; }

  function recalcAll(){
    const tbase=baseTempForZones();
    const zones=getZones();

    // Déperditions calculées automatiques
    let depCalc=0;
    zones.forEach(z=>{
      const dep=Gcalc(z,tbase);
      z.dep=dep; depCalc+=dep;
    });

    // Déperditions totales (manuel prioritaire si renseigné)
    const depManEl=document.getElementById('depMan');
    let depTotW = depCalc;
    const manVal = depManEl.value==="" ? null : +depManEl.value;
    if(manVal!=null && !isNaN(manVal)){ depTotW = manVal; }

    document.getElementById('depTot').textContent = Math.round(depTotW);

    // T° max zones
    const maxReg = zones.reduce((a,z)=>Math.max(a,z.reg),0)||35;
    document.getElementById('maxRegime').textContent = `${maxReg} °C`;

    const warn = document.getElementById('techWarn');
    warn.textContent="";
    if(currentTech==="airextrait" && maxReg===65){ warn.textContent="Air Extrait indisponible si une zone est à 65 °C."; }

    // Air/Eau – interdire AMS/F2050 si 65 °C
    if(currentTech==="aireau"){
      [...aeModelSel.options].forEach(o=>{
        const ban = (maxReg===65) && (o.value.startsWith("F2050") || o.value.startsWith("AMS"));
        o.disabled = ban;
      });
      if(aeModelSel.selectedOptions[0]?.disabled){
        const firstValid=[...aeModelSel.options].find(o=>!o.disabled);
        if(firstValid) aeModelSel.value=firstValid.value;
      }
    }

    // Puissance PAC
    const depTotkW = depTotW/1000;
    const depUsed = (maxReg===65?55:maxReg);
    let pacPower=0;

    if(currentTech==="geo"){
      const model = geoModelSel.value || geoModels[0]; if(!geoModelSel.value) geoModelSel.value=model;
      const src = +geoSource.value || 0;
      const u   = clamp(+geoUnits.value||1,1,9); geoUnits.value=u;
      const pUnit = geoData[model]?.[`${src}|${depUsed}`] ?? 0;
      pacPower = +(pUnit*u).toFixed(2);
      setEtas(model); setStopT(model); setSolution(`${model} — ${u} unité(s) — ${src===10?"Aquathermie 10 °C":"Géothermie "+src+" °C"} — Départ ${depUsed} °C`);
    }
    else if(currentTech==="aireau"){
      const model = aeModelSel.value || aeModels[0]; if(!aeModelSel.value) aeModelSel.value=model;
      const u = clamp(+aeUnits.value||1,1,8); aeUnits.value=u;
      const pUnit = aeData[model]?.[`${tbase}|${depUsed}`] ?? 0;
      pacPower = +(pUnit*u).toFixed(2);
      setEtas(model); setStopT(model); setSolution(`${model} — ${u} unité(s) — Départ ${depUsed} °C`);
    }
    else if(currentTech==="airextrait"){
      const model = axModel.value;
      const flow  = +axFlow.value || (axFlows[model]||[])[0] || 0;
      const idx   = depUsed===35?0:(depUsed===45?1:2);
      const pUnit = axData[model]?.[flow]?.[idx] ?? 0;
      pacPower = +Number(pUnit).toFixed(2);
      setEtas(model); setStopT(model); setSolution(`${model} — Débit ${flow} m³/h — Départ ${depUsed} °C`);
    }

    document.getElementById('pacPower').textContent = pacPower.toFixed(2);
    document.getElementById('pacRatio').textContent = depTotkW>0 ? Math.round(pacPower/depTotkW*100) : "—";

    buildReport(depTotW, pacPower);
  }

  function setEtas(model){
    document.getElementById('r_etas35').textContent = (ETAS35[model]!=null ? `${ETAS35[model]} %` : "—");
    document.getElementById('r_etas55').textContent = (ETAS55[model]!=null ? `${ETAS55[model]} %` : "—");
  }
  function setStopT(model){
    const stop = (["F2050-6","F2050-10","AMS 20-6","AMS 20-10"].includes(model)) ? "-20" : "-25";
    document.getElementById('r_stop').textContent=stop;
  }
  function setSolution(txt){ document.getElementById('r_solution').textContent=txt; }

  // RAPPORT
  function buildReport(depTotWParam, pacPowerParam){
    const inst={nom:val('inst_nom'),siret:val('inst_siret'),adr:val('inst_adresse')};
    const ben={prenom:val('ben_prenom'),nom:val('ben_nom'),adr:val('ben_adresse'),cp:val('ben_cp'),ville:val('ben_ville'),an:val('ben_annee')};
    const zones=getZones(); const tbase=baseTempForZones();
    const depTotW=depTotWParam ?? (+document.getElementById('depTot').textContent||0);
    const depTotkW=+(depTotW/1000).toFixed(2);
    const surfTot=zones.reduce((a,z)=>a+z.s,0);
    const hAvg=zones.length?(zones.reduce((a,z)=>a+z.h,0)/zones.length):0;
    const tiMax=zones.reduce((a,z)=>Math.max(a,z.ti),0);
    const regMax=zones.reduce((a,z)=>Math.max(a,z.reg),0)||35;

    const surfByReg={}; zones.forEach(z=>{surfByReg[z.reg]=(surfByReg[z.reg]||0)+z.s;});
    const tbody=document.getElementById('r_table'); tbody.innerHTML="";
    [35,45,55,65].forEach(r=>{
      if((surfByReg[r]||0)>0){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="mono">${r} °C</td><td class="mono">${(Math.round(surfByReg[r]*10)/10).toFixed(1)}</td>`;
        tbody.appendChild(tr);
      }
    });

    const Pdisplay = +(pacPowerParam ?? document.getElementById('pacPower').textContent) || 0;
    const ratio = depTotkW>0 ? Math.round(Pdisplay/depTotkW*100) : 0;
    const appoint = Math.max(0, +(depTotkW - Pdisplay).toFixed(2));

    id('r_inst').innerHTML=`${e(inst.nom)}<br>${e(inst.adr)}<br>SIRET : ${e(inst.siret)}`;
    id('r_ben').innerHTML=`${e(ben.prenom)} ${e(ben.nom)}<br>${e(ben.adr)} ${e(ben.cp)} ${e(ben.ville)}<br>Année : ${e(ben.an)}`;

    text('r_tbase',tbase??"—"); text('r_surf',(Math.round(surfTot*10)/10).toFixed(1)); text('r_havg',(Math.round(hAvg*100)/100).toFixed(2));
    text('r_ti',(Math.round(tiMax*10)/10).toFixed(1)); text('r_tmax',`${regMax} °C`); document.getElementById('r_haute').style.display=regMax===65?"inline-block":"none";
    text('r_pac_base',Pdisplay.toFixed(2));
    text('r_dep',depTotkW.toFixed(2)); text('r_ratio',String(ratio)); text('r_appoint',appoint.toFixed(2));
    text('r_60',(depTotkW*0.6).toFixed(2)); text('r_130',(depTotkW*1.3).toFixed(2));
  }

  document.getElementById('majRapport').addEventListener('click', ()=>buildReport());

  // Helpers
  function id(x){return document.getElementById(x);}
  function text(x,v){id(x).textContent=v;}
  function val(x){return id(x).value.trim();}
  function e(s){return (s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));}

  // Init
  addZone(); // au moins une zone
  updateBaseInfo();
  recalcAll();
});
</script>
</body>
</html>
